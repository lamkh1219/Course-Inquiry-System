<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šèª²å ‚èˆ‡æ•™å¸«æŸ¥è©¢ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #2c3e50;
            margin-top: 30px;
            border-left: 5px solid #3498db;
            padding-left: 10px;
        }
        h3 {
            color: #d35400; /* æ©™è‰²å€åˆ†èª¿æ•´å­åŠŸèƒ½ */
            margin-top: 20px;
            border-bottom: 1px dashed #e67e22;
            padding-bottom: 5px;
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 8px;
        }
        .select-group {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
        }
        .input-full-width {
            flex: 1 1 100%; /* ä½”æ»¿æ•´è¡Œ */
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        label {
            font-weight: bold;
            margin-right: 5px;
            /* è®“æ¨™ç±¤åœ¨è¼¸å…¥æ¡†å¯¬åº¦æ”¹è®Šæ™‚ä¸æœƒå¤ªå¿«æ›è¡Œ */
            white-space: nowrap; 
        }
        /* çµ±ä¸€æ‰€æœ‰è¼¸å…¥æ¡†çš„æ¨£å¼ï¼Œä½¿å…¶å¯¬åº¦ä¸€è‡´ä¸”å…·å½ˆæ€§ */
        select, input[type="text"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            min-width: 150px;
            flex-grow: 1; /* è®“è¼¸å…¥æ¡†ä½”ç”¨å‰©é¤˜ç©ºé–“ï¼Œç¢ºä¿å¯¬åº¦ä¸€è‡´ */
        }
        /* é‡å°æª”æ¡ˆä¸Šå‚³è¼¸å…¥æ¡†ï¼Œèª¿æ•´æ¨£å¼ */
        input[type="file"] {
            padding: 5px;
            border: none;
        }
        button {
            padding: 10px 15px;
            margin-top: 10px;
            background-color: #e67e22;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #d35400;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        /* é‡å°æ–°çš„å„²å­˜èˆ‡è¼‰å…¥æŒ‰éˆ•è¨­ç½®ä¸åŒé¡è‰² */
        #save-data-btn {
            background-color: #2ecc71; /* ç¶ è‰² */
            flex-grow: 1; /* ç¢ºä¿å¯¬åº¦èˆ‡å ±å‘ŠæŒ‰éˆ•ç›¸è¿‘ */
        }
        #save-data-btn:hover:not(:disabled) {
            background-color: #27ae60;
        }
        #load-data-btn {
            background-color: #3498db; /* è—è‰² */
        }
        #load-data-btn:hover:not(:disabled) {
            background-color: #2980b9;
        }
        /* MODIFIED: Report CSV Button Style */
        #generate-report-btn { /* Changed from #generate-pdf-btn */
            background-color: #e74c3c; /* ç´…è‰² */
            flex-grow: 1; /* ç¢ºä¿å¯¬åº¦èˆ‡ä¸‹è¼‰æŒ‰éˆ•ç›¸è¿‘ */
        }
        #generate-report-btn:hover:not(:disabled) {
            background-color: #c0392b;
        }
        /* NEW: Reset Data Button Style */
        #reset-data-btn {
            background-color: #9b59b6; /* ç´«è‰² */
            margin-top: 0; /* è®“å®ƒèˆ‡ Select åœ¨åŒä¸€è¡Œå°é½Š */
        }
        #reset-data-btn:hover:not(:disabled) {
            background-color: #8e44ad;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: white;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: top;
            /* é‡å°å…¨ç­åˆ¥è¦–åœ–ï¼Œè®“å–®å…ƒæ ¼å…§å®¹å¯ä»¥æ›è¡Œ */
            word-break: break-word; 
        }
        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            /* ç¢ºä¿ç­åˆ¥æ¨™é¡Œä¸æœƒæ›è¡Œ */
            white-space: nowrap; 
        }
        .teacher-table th {
             background-color: #2ecc71; /* ç¶ è‰²ï¼Œå€åˆ†æŸ¥è©¢ */
        }
        #teacher-schedule-output td:last-child {
            background-color: #e6f7ff; /* çªå‡ºé¡¯ç¤ºç©ºé–’æ•™å¸«åˆ—è¡¨ */
        }
        /* ç¢ºä¿è¡Œå…§æ¨£å¼å¯ä»¥è¦†è“‹é è¨­çš„äº¤æ›¿è¡Œé¡è‰² */
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        /* å¤šæ•™å¸«æŸ¥è©¢æ™‚çš„åˆ†éš”æ¨™é ­ */
        .teacher-header-row {
            background-color: #ffe082 !important; 
            font-weight: bold;
            text-align: center;
        }
        .teacher-header-row td {
            font-size: 1.1em;
        }
        /* ç‚ºç´”ç¯€æ•¸æŸ¥è©¢è¨­è¨ˆä¸€å€‹æ›´ç°¡æ½”çš„æ¨™é ­ */
        .timeslot-header-row {
            background-color: #d8eaff !important; /* æ·ºè—è‰² */
            font-weight: bold;
            text-align: left;
        }
        .timeslot-header-row td {
            font-size: 1.0em;
        }
        /* 2. ç­ç´šèª²è¡¨æŸ¥è©¢ æç¤ºæ–‡å­—é¡è‰²å®šç¾© */
        p > span[style*="background-color: #ffc2c2"] { /* ç¼ºå°‘è€å¸«çš„ç²‰ç´…è‰² */
            background-color: #ffc2c2;
        }
        p > span[style*="background-color: #FFC299"] { /* æ•™å¸«è¡çªçš„ç²‰æ©™è‰² */
            background-color: #FFC299;
            color: #333; 
        }
        /* NEW: å·²ä¿®æ”¹è¨˜éŒ„çš„ç²‰ç´«è‰² */
        p > span[style*="background-color: #E6E6FA"] { 
            background-color: #E6E6FA;
            color: #333; 
        }
        
        /* è®“èª²è¡¨ä¸­çš„å¯é»æ“Šå–®å…ƒæ ¼æœ‰æ‰‹å‹æ¸¸æ¨™æç¤º */
        #schedule-body td {
            cursor: pointer; 
        }


        #result-message, #teacher-result-message, #adjustment-message {
            margin-top: 15px;
            font-style: italic;
            font-weight: bold;
            color: #2980b9;
        }
        /* MODIFIED: Use button-row to handle the save/pdf buttons side-by-side */
        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>

    <h1>ç­ç´šèª²å ‚èˆ‡æ•™å¸«æŸ¥è©¢ç³»çµ±</h1>
    <p style="color: green;">âœ… æ­£åœ¨è‡ªå‹•è¼‰å…¥ **`ç­åˆ¥æ™‚é–“ç¸½è¡¨.csv`**ã€**`S&PSM_L.csv`**ã€**`Teacher List.csv`** å’Œ **`æ™‚é–“è¡¨.csv`** æª”æ¡ˆ...</p>

    <div class="controls">
        <div class="select-group">
            <label for="day-select">å…±åŒé¸æ“‡æ—¥å­:</label>
            <select id="day-select" disabled>
                <option>è¼‰å…¥ä¸­...</option>
            </select>
            <button id="reset-data-btn" disabled>ğŸ”„ æ¸…é™¤æ‰€æœ‰æ›´æ”¹ (é‚„åŸ)</button>
        </div>
    </div>
    
    <hr>
    <h2>1. æ•™å¸«ç©ºé–’æŸ¥è©¢ (Teacher Free Time Lookup)</h2>
    <p>
        â„¹ï¸ <span style="color: blue; font-weight: bold;">SPSM</span>/<span style="color: blue; font-weight: bold;">è—è‰²</span>ï¼Œ<span style="color: red; font-weight: bold;">PSM</span>/<span style="color: red; font-weight: bold;">ç´…è‰²</span>ï¼Œå„ªå…ˆä»£èª²/<span style="color: orange; font-weight: bold;">æ©™è‰²</span>ä¸¦æ’æœ€å‰
        <br>â„¹ï¸ æ—©æœƒã€ç­ä¸»ä»»èª²ã€é–±è®€ã€å°æ¯ã€åˆè†³ã€åˆé–“æ´»å‹•å’Œé€±æœƒï¼èª²é–“æ´»å‹•ä¸ç´å…¥ç©ºå ‚æ•¸è¨ˆç®—
        <br>â„¹ï¸ å¯å–®ç¨è¼¸å…¥ç¯€æ•¸æŸ¥è©¢è©²æ™‚æ®µæ‰€æœ‰ç©ºé–’æ•™å¸«
    </p>
    <div class="controls">
        <div class="input-full-width">
            <label for="teacher-name-input">è¼¸å…¥éœ€è¦èª²å ‚èª¿å‹•æ•™å¸«å§“å (é¸å¡«):</label>
            <input type="text" id="teacher-name-input" placeholder="ä¾‹å¦‚: å©· é´»" disabled>
        </div>

        <div class="input-full-width">
            <label for="lesson-number-input" style="color: #3498db;">æŸ¥è©¢ç¯€æ•¸ (ä¾‹å¦‚: 3,4,5) (é¸å¡«):</label>
            <input type="text" id="lesson-number-input" placeholder="ä¾‹å¦‚: 3,4,5" disabled>
        </div>
        
        <div class="input-full-width">
            <label for="priority-teacher-input" style="color: orange;">å„ªå…ˆä»£èª²è€å¸«åå–® (æ©™è‰²ï¼Œæ’æœ€å‰):</label>
            <input type="text" id="priority-teacher-input" placeholder="ä¾‹å¦‚: é›… é­" disabled>
        </div>
        
        <div class="input-full-width">
            <label for="duty-teacher-input" style="color: #900;">å·²æœ‰å…¬å‹™è€å¸«åå–® (æ’é™¤åå–®):</label>
            <input type="text" id="duty-teacher-input" placeholder="ä¾‹å¦‚: ç›§ æ¬£" disabled>
        </div>
    </div>
    
    <div id="teacher-schedule-output">
        <table class="teacher-table">
            <thead>
                <tr>
                    <th>ç¯€æ•¸</th>
                    <th>æ™‚é–“</th>
                    <th>ç­åˆ¥</th>
                    <th>èª²å ‚</th>
                    <th>ç©ºé–’æ•™å¸« (å¯ä»£èª²åå–®) - æŒ‰å„ªå…ˆç´šåŠç©ºå ‚æ•¸æ’åº</th>
                </tr>
            </thead>
            <tbody id="teacher-schedule-body">
                <tr><td colspan="5" style="text-align: center;">è«‹è¼¸å…¥æ•™å¸«å§“åæˆ–ç¯€æ•¸ä¸¦é¸æ“‡æ—¥å­</td></tr>
            </tbody>
        </table>
        <p id="teacher-result-message"></p>
    </div>

    
    <hr>
    <h2>2. ç­ç´šèª²è¡¨æŸ¥è©¢ (Class Schedule Lookup)</h2>
    <p>
        â„¹ï¸ <span style="color: blue; font-weight: bold;">SPSM</span>/<span style="color: blue; font-weight: bold;">è—è‰²</span>ï¼Œ<span style="color: red; font-weight: bold;">PSM</span>/<span style="color: red; font-weight: bold;">ç´…è‰²</span>
        <br>â„¹ï¸ **æœ‰æ›´æ”¹çš„èª²å ‚**å°‡ä»¥ <span style="background-color: #E6E6FA; font-weight: bold;">ç²‰ç´«è‰²åº•è‰²</span> é¡¯ç¤ºã€‚
        <br>â„¹ï¸ æ²’æœ‰æ•™å¸«çš„èª²å ‚å°‡ä»¥ <span style="background-color: #ffc2c2; font-weight: bold;">ç²‰ç´…è‰²åº•è‰²</span> é¡¯ç¤ºï¼Œå¦‚æœåŒä¸€æ•™å¸«åœ¨åŒä¸€ç¯€æ•¸å‡ºç¾åœ¨å…©ç­ä»¥ä¸Šèª²å ‚å°‡ä»¥ <span style="background-color: #FFC299; color: #333; font-weight: bold;">æ©™è‰²åº•è‰²</span> é¡¯ç¤º
        <br>ğŸ’¡ é»æ“Šèª²è¡¨ä¸­çš„ä»»ä½•å–®å…ƒæ ¼ï¼Œå¯å°‡è©²èª²å ‚çš„ç­åˆ¥ã€ç¯€æ•¸å’Œä¸Šèª²æ•™å¸«è‡ªå‹•å¡«å…¥ä¸‹æ–¹çš„ 3.2åŠ 3.3 çš„è¼¸å…¥æ¡†ä¸­ã€‚
    </p>
    <div class="controls">
        <div class="select-group">
            <label for="class-select">é¸æ“‡ç­åˆ¥:</label>
            <select id="class-select" disabled>
                <option>è¼‰å…¥ä¸­...</option>
            </select>
        </div>
        <div class="input-full-width" id="multi-class-input-group" style="display: none; margin-top: 10px;">
            <label for="multi-class-input" style="color: #2980b9;">è¼¸å…¥è¦é¡¯ç¤ºçš„ç­åˆ¥ (ä¾‹å¦‚: 1A 1B 2C) :</label>
            <input type="text" id="multi-class-input" placeholder="ä¾‹å¦‚: 1A 1B 2C">
        </div>
    </div>

    <div id="schedule-output">
        <table>
            <thead id="schedule-header">
                <tr>
                    <th>ç¯€æ•¸</th>
                    <th>æ™‚é–“</th>
                    <th>èª²å ‚</th>
                    <th>ä¸Šèª²æ•™å¸«</th>
                </tr>
            </thead>
            <tbody id="schedule-body">
                <tr><td colspan="4" style="text-align: center;">æ•¸æ“šè¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</td></tr>
            </tbody>
        </table>
        <p id="result-message"></p>
    </div>

    <hr>
    <h2>3. èª¿å ‚åŠŸèƒ½ (Class/Teacher Assignment Adjustment)</h2>
    <p style="color: orange;">âš ï¸ æ³¨æ„ï¼šä»¥ä¸‹æ“ä½œå°‡ä¿®æ”¹ç•¶å‰ç¶²é çš„æ’èª²è³‡æ–™ã€‚è«‹å‹™å¿…ä½¿ç”¨ä¸‹æ–¹çš„ã€Œå„²å­˜ã€åŠŸèƒ½ä¾†ä¸‹è¼‰å·²èª¿æ•´çš„æ•¸æ“šã€‚</p>
    <div class="controls">
        
        <h3>3.1. èª²å ‚å…§å®¹å°èª¿ (Swap - æ”¯æ´è·¨ç­åˆ¥/è·¨ç´šåˆ¥)</h3>
        <p>æ­¤åŠŸèƒ½å°‡èª¿æ›**å…©çµ„ç¨ç«‹æ’èª²ä½ç½®**çš„èª²å ‚å’Œä¸Šèª²æ•™å¸«æ¬„ä½ã€‚é€™å¯ç”¨æ–¼**è·¨ç­åˆ¥ã€è·¨ç´šåˆ¥**æˆ–åœ¨**åŒä¸€ç­åˆ¥**å…§èª¿å‹•ã€‚</p>
        
        <div class="input-full-width" style="background-color: #f7f3e8; padding: 5px; border-radius: 4px;">
            <label for="swap-class-1-select" style="min-width: 60px;">A ç­åˆ¥:</label>
            <select id="swap-class-1-select" disabled style="flex-grow: 0; margin-right: 10px;"></select>
            <label for="swap-lessons-1-input" style="min-width: 60px;">A ç¯€æ•¸ (ä¾‹å¦‚: 3,4):</label>
            <input type="text" id="swap-lessons-1-input" placeholder="3,4">
        </div>

        <div class="input-full-width" style="background-color: #e8f7f3; padding: 5px; border-radius: 4px;">
            <label for="swap-class-2-select" style="min-width: 60px;">B ç­åˆ¥:</label>
            <select id="swap-class-2-select" disabled style="flex-grow: 0; margin-right: 10px;"></select>
            <label for="swap-lessons-2-input" style="min-width: 60px;">B ç¯€æ•¸ (ä¾‹å¦‚: 7,8):</label>
            <input type="text" id="swap-lessons-2-input" placeholder="7,8">
        </div>

        <button id="swap-classes-btn" disabled>åŸ·è¡Œèª²å ‚å°èª¿ (Swap)</button>

        <hr style="margin: 20px 0;">
        
        <h3>3.2. æ¸…ç©ºè€å¸«æ’èª² (Clear)</h3>
        <p>ğŸ¯ **ç›®æ¨™ç­åˆ¥** å¯ç”¨æ–¼è§£æ±ºåŒä¸€è€å¸«åœ¨å…©ç­åŒæ™‚ä¸Šèª²çš„è¡çªå•é¡Œã€‚</p>
        
        <div class="select-group">
            <label for="class-select-clear">ğŸ¯ **ç›®æ¨™ç­åˆ¥** (ç”¨æ–¼æ¸…ç©ºè€å¸«):</label>
            <select id="class-select-clear" disabled>
                <option>è¼‰å…¥ä¸­...</option>
            </select>
        </div>
        
        <div class="input-full-width">
            <label for="clear-lessons-input">æ¸…ç©ºã€Œç¯€æ•¸ã€ (ä¾‹å¦‚: 3,4 æˆ– **all**):</label>
            <input type="text" id="clear-lessons-input" placeholder="3,4 æˆ– all">
        </div>
        <div class="input-full-width">
            <label for="clear-teachers-input" style="color: #900;">æ¸…ç©ºæ’èª²è€å¸«åå–® (ä¾‹å¦‚: ç›§ æ¬£):</label>
            <input type="text" id="clear-teachers-input" placeholder="ç›§ æ¬£">
        </div>
        <button id="clear-teachers-btn" disabled>åŸ·è¡Œæ¸…ç©ºæ’èª² (Clear)</button>
        
        <hr style="margin: 20px 0;">
        <h3>3.3. æ–°å¢è€å¸«æ’èª² (Add)</h3>
        <p>æ­¤åŠŸèƒ½å°‡åœ¨ **ğŸ¯ æ‰€é¸ç­åˆ¥** çš„ **æŒ‡å®šç¯€æ•¸** ä¸Šï¼ŒåŠ å…¥æŒ‡å®šçš„è€å¸«åˆ°æ’èª²åå–®ã€‚å¦‚æœè©²ä½ç½®å·²æœ‰è€å¸«ï¼Œå‰‡æœƒé™„åŠ è€å¸«åå–®ã€‚</p>
        
        <div class="select-group">
            <label for="class-select-adj">ğŸ¯ **ç›®æ¨™ç­åˆ¥** (ç”¨æ–¼æ–°å¢è€å¸«):</label>
            <select id="class-select-adj" disabled>
                <option>è¼‰å…¥ä¸­...</option>
            </select>
        </div>
        
        <div class="input-full-width">
            <label for="add-lessons-input">åŠ å…¥ã€Œç¯€æ•¸ã€ (ä¾‹å¦‚: 3,4):</label>
            <input type="text" id="add-lessons-input" placeholder="3,4">
        </div>
        <div class="input-full-width">
            <label for="add-teacher-input" style="color: #007bff;">æ–°å¢è€å¸«åå–® (ä¾‹å¦‚: ç›§ æ¬£):</label>
            <input type="text" id="add-teacher-input" placeholder="ç›§ æ¬£">
        </div>
        <button id="add-teacher-btn" disabled>åŸ·è¡Œæ–°å¢æ’èª² (Add)</button>

    </div>
    
    <hr>
    <h2>4. å„²å­˜èˆ‡è¼‰å…¥åŠŸèƒ½ (Save & Load)</h2>
    <div class="controls">
        <p>
            ğŸ’¡ä¸‹è¼‰ æŒ‰éˆ•åªæœƒå„²å­˜èˆ‡è¼‰å…¥æ™‚çš„æ•¸æ“šæœ‰å·®ç•°çš„è¨˜éŒ„ (åªåŒ…å«æ–°å€¼)ã€‚**æª”æ¡ˆå‰¯æª”åç‚º .csav**ã€‚
            <br>ğŸ’¡å ±å‘Š æŒ‰éˆ•å°‡ä¸‹è¼‰åŒ…å«æ‰€æœ‰**åŸæœ‰**å’Œ**ä¿®æ”¹å¾Œ**ç´€éŒ„çš„ CSV å ±å‘Š (.csv)ã€‚
            <br>ğŸ’¡è¼‰å…¥ æŒ‰éˆ•åªæœƒæ›´æ–°èˆ‡ä¸Šå‚³æª”æ¡ˆ (.csv æˆ– .csav) å»åˆçš„è¨˜éŒ„ï¼Œå¦‚æœä¸Šå‚³æª”æ¡ˆåªåŒ…å«å–®ä¸€æ—¥å­ï¼Œæœƒè‡ªå‹•åˆ‡æ›é¡¯ç¤ºã€‚
        </p>
        <div class="select-group button-row">
            <button id="save-data-btn" disabled>ğŸ“¥ ä¸‹è¼‰å·²èª¿æ•´æ’èª²è¡¨ (Save Modified Only)</button>
            <button id="generate-report-btn" disabled>ğŸ“‘ ç”Ÿæˆèª¿èª²å ±å‘Š CSV (Generate Report)</button>
        </div>
        
        <div class="input-full-width" style="margin-top: 20px;">
            <label for="load-file-input">ä¸Šå‚³èª¿æ•´éçš„æ’èª²è¡¨ CSV / CSAV æª”æ¡ˆ (Load):</label>
            <input type="file" id="load-file-input" accept=".csv, .csav" disabled> 
            <button id="load-data-btn" disabled style="background-color: #3498db; margin-left: 10px;">â¬†ï¸ è¼‰å…¥æ’èª²è¡¨ (Update Existing)</button>
        </div>
    </div>


    <p id="adjustment-message" style="margin-top: 15px; font-weight: bold;"></p>

    <script>
        const CSV_FILE_PATH = "ç­åˆ¥æ™‚é–“ç¸½è¡¨.csv"; 
        const GRADE_FILE_PATH = "S&PSM_L.csv"; 
        const TEACHER_LIST_FILE_PATH = "Teacher List.csv";
        const TIMETABLE_FILE_PATH = "æ™‚é–“è¡¨.csv"; 
        
        // 1. æ´»å‹•åç¨±åªé¡¯ç¤ºï¼Œä¸é¡¯ç¤ºæ•™å¸« (ç”¨æ–¼ displaySchedule)
        const NON_LESSON_ACTIVITIES = ['å°æ¯', 'åˆè†³', 'åˆé–“æ´»å‹•', 'é€±æœƒï¼èª²é–“æ´»å‹•'];
        
        // 2. æ´»å‹•ä¸ç´å…¥ç©ºå ‚è¨ˆç®— (ç”¨æ–¼ calculateDailyFreeLessons)
        // åŒ…å«æ‰€æœ‰ NON_LESSON_ACTIVITIESï¼Œä»¥åŠéœ€è¦è€å¸«ä½†ä¸èƒ½ä»£èª²çš„è·å‹™/æ´»å‹•
        const NON_COUNTABLE_FOR_FREE_LESSONS = [...NON_LESSON_ACTIVITIES, 'æ—©æœƒ', 'ç­ä¸»ä»»èª²', 'é–±è®€'];
        
        let scheduleData = []; 
        let teacherGradesMap = new Map(); 
        let teacherListCache = []; 
        
        // Key: 'æ—¥å­|ç­åˆ¥|æ™‚é–“', Value: {èª²å ‚: string, ä¸Šèª²æ•™å¸«: string}
        // This map ONLY stores the data from the initial load of ç­åˆ¥æ™‚é–“ç¸½è¡¨.csv
        // It is the immutable baseline for all reset/reporting operations.
        let originalScheduleDataMap = new Map(); 

        // çµæ§‹: Map<DayType, Map<Time, LessonNumber>>
        let timetableDayTypeMap = new Map(); 
        
        // DOM å…ƒç´ å¼•ç”¨
        const daySelect = document.getElementById('day-select');
        const classSelect = document.getElementById('class-select');
        const scheduleHeader = document.getElementById('schedule-header'); 
        const scheduleBody = document.getElementById('schedule-body');
        const resultMessage = document.getElementById('result-message');
        
        // NEW CUSTOM MULTI-CLASS ELEMENTS
        const multiClassInputGroup = document.getElementById('multi-class-input-group');
        const multiClassInput = document.getElementById('multi-class-input');
        
        const teacherNameInput = document.getElementById('teacher-name-input');
        const lessonNumberInput = document.getElementById('lesson-number-input'); 
        const teacherScheduleBody = document.getElementById('teacher-schedule-body');
        const teacherResultMessage = document.getElementById('teacher-result-message');
        
        const priorityTeacherInput = document.getElementById('priority-teacher-input');
        const dutyTeacherInput = document.getElementById('duty-teacher-input');
        
        // NEW RESET BUTTON
        const resetDataBtn = document.getElementById('reset-data-btn');

        // ADJUSTMENT CONTROLS
        const classSelectClear = document.getElementById('class-select-clear'); // NEW: For Clear only
        const classSelectAdj = document.getElementById('class-select-adj'); // For Add only
        const swapClassesBtn = document.getElementById('swap-classes-btn');
        const clearTeachersBtn = document.getElementById('clear-teachers-btn');
        const addTeacherBtn = document.getElementById('add-teacher-btn');
        
        // Inputs for 3.2 and 3.3
        const clearLessonsInput = document.getElementById('clear-lessons-input');
        const clearTeachersInput = document.getElementById('clear-teachers-input'); // NEW REFERENCE
        const addLessonsInput = document.getElementById('add-lessons-input');
        
        // NEW SWAP CONTROLS
        const swapClass1Select = document.getElementById('swap-class-1-select');
        const swapLessons1Input = document.getElementById('swap-lessons-1-input');
        const swapClass2Select = document.getElementById('swap-class-2-select');
        const swapLessons2Input = document.getElementById('swap-lessons-2-input');
        
        // SAVE/LOAD CONTROLS
        const saveDataBtn = document.getElementById('save-data-btn');
        const loadFileInput = document.getElementById('load-file-input');
        const loadDataBtn = document.getElementById('load-data-btn');
        // MODIFIED: Report CSV CONTROL
        const generateReportBtn = document.getElementById('generate-report-btn'); // Changed from generatePdfBtn
        
        const adjustmentMessage = document.getElementById('adjustment-message');
        
        // ====================================================================
        // æ ¸å¿ƒè¼”åŠ©åŠŸèƒ½
        // ====================================================================

        /**
         * æ ¹æ“šæ—¥å­ã€ç­åˆ¥å’Œæ™‚é–“ç”Ÿæˆå”¯ä¸€çš„éµå€¼ã€‚
         * @param {object} record - ä¸€æ¢æ’èª²è¨˜éŒ„ã€‚
         * @returns {string|null} éµå€¼ï¼Œä¾‹å¦‚ 'æ˜ŸæœŸä¸€|1A|08:35-09:05'ã€‚
         */
        function generateRecordKey(record) {
            if (!record || !record['æ—¥å­'] || !record['ç­åˆ¥'] || !record['æ™‚é–“']) return null;
            // ç¢ºä¿æ‰€æœ‰çµ„æˆéµçš„æ¬„ä½éƒ½æ˜¯å­—ä¸²ä¸¦å»é™¤ç©ºç™½
            return `${String(record['æ—¥å­']).trim()}|${String(record['ç­åˆ¥']).trim()}|${String(record['æ™‚é–“']).trim()}`;
        }
        
        /**
         * åˆå§‹åŒ–æˆ–é‡è¨­åŸå§‹æ•¸æ“šåœ°åœ– (baseline)ã€‚
         * @param {Array<object>} data - è¦è¨­å®šç‚ºåŸºç·šçš„æ’èª²æ•¸æ“šã€‚
         */
        function initializeOriginalDataMap(data) {
            originalScheduleDataMap.clear();
            data.forEach(record => {
                const key = generateRecordKey(record);
                if (key) {
                    // åªè¿½è¹¤å¯è®Šå‹•çš„æ¬„ä½: èª²å ‚ å’Œ ä¸Šèª²æ•™å¸«
                    originalScheduleDataMap.set(key, {
                        'èª²å ‚': String(record['èª²å ‚'] || '').trim(), 
                        'ä¸Šèª²æ•™å¸«': String(record['ä¸Šèª²æ•™å¸«'] || '').trim()
                    });
                }
            });
        }
        
        /**
         * [MODIFIED FUNCTION] å°‡æ‰€æœ‰å·²ä¿®æ”¹çš„æ’èª²æ•¸æ“šé‚„åŸåˆ°åˆå§‹è¼‰å…¥çš„ç‹€æ…‹ã€‚
         */
        function resetModifiedDataToOriginal() {
            let resetCount = 0;
            
            // è¿­ä»£ç•¶å‰å¯è®Šçš„ scheduleData é™£åˆ—
            scheduleData.forEach(currentRecord => {
                const key = generateRecordKey(currentRecord);
                const originalRecord = originalScheduleDataMap.get(key);
                
                if (originalRecord) {
                    const currentLesson = String(currentRecord['èª²å ‚'] || '').trim();
                    const originalLesson = originalRecord['èª²å ‚']; 
                    
                    const currentTeacher = String(currentRecord['ä¸Šèª²æ•™å¸«'] || '').trim();
                    const originalTeacher = originalRecord['ä¸Šèª²æ•™å¸«']; 
                    
                    const isLessonModified = currentLesson !== originalLesson;
                    const isTeacherModified = currentTeacher !== originalTeacher;
                    
                    if (isLessonModified || isTeacherModified) {
                        // é‚„åŸç‚ºåŸå§‹å€¼
                        currentRecord['èª²å ‚'] = originalRecord['èª²å ‚'];
                        currentRecord['ä¸Šèª²æ•™å¸«'] = originalRecord['ä¸Šèª²æ•™å¸«'];
                        resetCount++;
                    }
                }
            });
            
            // æ›´æ–°æç¤ºè¨Šæ¯
            if (resetCount > 0) {
                adjustmentMessage.textContent = `âœ… å·²æ‰‹å‹•æ¸…é™¤æ‰€æœ‰æœªå„²å­˜çš„èª¿èª²å…§å®¹ (å…± ${resetCount} ç­†è¨˜éŒ„)ï¼Œä¸¦é‚„åŸè‡³åŸå§‹æ’èª²è¡¨ã€‚`;
                adjustmentMessage.style.color = 'green';
            } else {
                adjustmentMessage.textContent = `âš ï¸ æ²’æœ‰åµæ¸¬åˆ°ä»»ä½•æ›´æ”¹ï¼Œç„¡éœ€æ¸…é™¤ã€‚`; // æ¸…é™¤ä¹‹å‰çš„æ¶ˆæ¯
                adjustmentMessage.style.color = 'orange';
            }
            
            // åˆ·æ–°é¡¯ç¤º
            updateDisplays();
        }


        /**
         * æ ¹æ“šæ‰€é¸æ—¥å­ï¼Œç²å–å°æ‡‰çš„ Time-Lesson Mapã€‚
         */
        function getCurrentTimetableMap(day) {
            if (!day) return new Map();

            // ç°¡æ˜“åˆ¤æ–·æ—¥å­é¡å‹
            const dayType = (day === 'æ˜ŸæœŸäº”' || day === 'Friday') ? 'Day5' : 'Day1-4';

            return timetableDayTypeMap.get(dayType) || new Map();
        }

        function timeToMinutes(timeString) {
            if (!timeString || typeof timeString !== 'string') return 0;
            const startTime = timeString.split('-')[0].trim(); 
            const parts = startTime.split(':');
            if (parts.length !== 2) return 0;
            
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);
            return hours * 60 + minutes;
        }

        function splitTeacherList(teacherString) {
            if (!teacherString) return []; 
            // å…è¨± ç©ºæ ¼, é€—è™Ÿ, æ–œç·š, åŠ è™Ÿ ä½œç‚ºåˆ†éš”ç¬¦ï¼Œä¸¦éæ¿¾ç©ºå­—ä¸²å’Œ '---'
            return String(teacherString)
                .split(/[\s,ï¼Œ\/\ï¼+]+/) 
                .map(name => name.trim()) 
                .filter(name => name.length > 0 && name !== '---'); 
        }

        function getStyledTeacherName(teacherName) {
            if (!teacherName || teacherName === '---') return teacherName;

            const grade = teacherGradesMap.get(teacherName);
            let colorStyle = '';

            // Note: P Grade (Primary) corresponds to PSM (ç´…è‰²), S Grade (Secondary) corresponds to SPSM (è—è‰²)
            if (grade === 'P') { 
                colorStyle = 'color: red; font-weight: bold;';
            } else if (grade === 'S') { 
                colorStyle = 'color: blue; font-weight: bold;';
            }

            if (colorStyle) {
                return `<span style="${colorStyle}">${teacherName}</span>`;
            }
            return teacherName;
        }

        function getFreeListStyledTeacherName(teacherName, isPriority) {
            if (!teacherName || teacherName === '---') return teacherName;

            let color = 'inherit'; 
            
            if (isPriority) {
                color = 'orange'; 
            } else {
                const grade = teacherGradesMap.get(teacherName);
                if (grade === 'P') {
                    color = 'red';
                } else if (grade === 'S') {
                    color = 'blue';
                }
            }

            if (color !== 'inherit') {
                return `<span style="color: ${color}; font-weight: bold;">${teacherName}</span>`;
            }
            return teacherName;
        }

        function getAllTeachers() {
            return teacherListCache; 
        }

        function getOccupiedTeachers(day, time) {
            const occupiedSet = new Set();
            scheduleData.forEach(item => {
                if (item['æ—¥å­'] === day && item['æ™‚é–“'] === time) {
                    if (item['ä¸Šèª²æ•™å¸«']) {
                        const teachingNames = splitTeacherList(item['ä¸Šèª²æ•™å¸«']);
                        teachingNames.forEach(name => occupiedSet.add(name));
                    }
                }
            });
            return occupiedSet;
        }

        function calculateDailyFreeLessons(day) {
            // ä½¿ç”¨æ–°çš„ã€æ›´å…¨é¢çš„æ’é™¤åˆ—è¡¨ï¼ŒåŒ…å«æ—©æœƒã€ç­ä¸»ä»»èª²ã€é–±è®€
            const lessonsToExcludeFromCount = NON_COUNTABLE_FOR_FREE_LESSONS; 
            
            // ç¯©é¸å‡ºæ‰€æœ‰åœ¨è©²æ—¥å­çš„æ™‚é–“æ®µä¸­ï¼Œèª²å ‚åç¨±ã€Œä¸ã€å±¬æ–¼æ’é™¤åˆ—è¡¨çš„å”¯ä¸€æ™‚é–“æ®µã€‚
            const relevantUniqueTimeSlots = [...new Set(scheduleData
                .filter(item => 
                    item['æ—¥å­'] === day && 
                    // æ’é™¤æ‰€æœ‰éèª²å ‚æ´»å‹•å’Œä¸æ‡‰è¢«è¨ˆç‚ºç©ºå ‚çš„è·å‹™/æ´»å‹•
                    !lessonsToExcludeFromCount.includes(String(item['èª²å ‚'] || '').trim()) 
                )
                .map(item => item['æ™‚é–“']))
            ];

            const allTeachers = getAllTeachers(); 
            const freeLessonCountMap = new Map();

            allTeachers.forEach(teacher => {
                freeLessonCountMap.set(teacher, 0);
            });

            relevantUniqueTimeSlots.forEach(timeSlot => {
                const occupiedSet = getOccupiedTeachers(day, timeSlot); 
                
                allTeachers.forEach(teacher => {
                    if (!occupiedSet.has(teacher)) {
                        freeLessonCountMap.set(teacher, freeLessonCountMap.get(teacher) + 1);
                    }
                });
            });

            return freeLessonCountMap;
        }


        /**
         * æ ¹æ“šæ‰€é¸æ—¥å­å’Œç¯€æ•¸ï¼Œè½‰æ›ç‚ºå°æ‡‰çš„æ™‚é–“æ®µã€‚
         * @param {string} day - é¸æ“‡çš„æ—¥å­ (ç”¨æ–¼åˆ¤æ–·ä½¿ç”¨å“ªå¥—æ™‚é–“è¡¨)
         * @param {string} lessonNumbersString - è¼¸å…¥çš„ç¯€æ•¸ï¼Œä¾‹å¦‚ "3,4"
         * @returns {string[]} å°æ‡‰çš„æ™‚é–“æ®µï¼Œä¾‹å¦‚ ["09:50-10:20", "10:20-10:50"]
         */
        function getTimeSlotsByLessonNumbers(day, lessonNumbersString) {
            if (!lessonNumbersString) return [];
            
            const lessonNumbers = String(lessonNumbersString)
                .split(/[\s,ï¼Œ]+/)
                .map(num => String(num).trim())
                .filter(num => num.length > 0);
            
            // ç²å–ç•¶å‰æ—¥å­çš„ Time-Lesson Map (Map<Time, LessonNumber>)
            const currentTimetableMap = getCurrentTimetableMap(day); 

            // åè½‰ Map ç‚º Lesson-Time Map (Map<LessonNumber, Time>)
            const lessonToTimeMap = new Map();
            currentTimetableMap.forEach((lesson, time) => {
                const lessonKey = String(lesson).trim();
                // ç”±æ–¼æ™‚é–“è¡¨ CSV æª”æ¡ˆå¯èƒ½æœ‰å¤šç­†ç›¸åŒç¯€æ•¸çš„è¨˜éŒ„ï¼Œåªå–ç¬¬ä¸€å€‹
                if (!lessonToTimeMap.has(lessonKey)) { 
                     lessonToTimeMap.set(lessonKey, time);
                }
            });
            
            const timeSlots = [];
            lessonNumbers.forEach(lessonNum => {
                const time = lessonToTimeMap.get(lessonNum);
                if (time) {
                    timeSlots.push(time);
                }
            });
            
            // ç”±æ–¼æˆ‘å€‘æ˜¯å¾ Lesson-Time Map è½‰æ›å›ä¾†çš„ï¼Œéœ€è¦å†æ¬¡æ’åºä»¥ç¢ºä¿æ™‚é–“é †åº
            timeSlots.sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
            
            return timeSlots;
        }

        /**
         * NEW: æª¢æŸ¥çµ¦å®šçš„è¨˜éŒ„æ˜¯å¦å·²å¾åŸå§‹æ•¸æ“šä¿®æ”¹ (èª²å ‚æˆ–æ•™å¸«)ã€‚
         * @param {object} currentRecord - ç•¶å‰çš„æ’èª²è¨˜éŒ„ã€‚
         * @returns {boolean} å¦‚æœå·²ä¿®æ”¹å‰‡è¿”å› trueã€‚
         */
        function isRecordModified(currentRecord) {
            const key = generateRecordKey(currentRecord);
            const originalRecord = originalScheduleDataMap.get(key);
            
            if (!originalRecord) return false; 
            
            const currentLesson = String(currentRecord['èª²å ‚'] || '').trim();
            const originalLesson = originalRecord['èª²å ‚']; 
            
            const currentTeacher = String(currentRecord['ä¸Šèª²æ•™å¸«'] || '').trim();
            const originalTeacher = originalRecord['ä¸Šèª²æ•™å¸«']; 
            
            const isLessonModified = currentLesson !== originalLesson;
            const isTeacherModified = currentTeacher !== originalTeacher;
            
            // åªè¦èª²å ‚æˆ–æ•™å¸«å…¶ä¸­ä¸€å€‹èˆ‡åŸå§‹å€¼ä¸åŒï¼Œå³è¦–ç‚ºå·²ä¿®æ”¹
            return isLessonModified || isTeacherModified;
        }
        
        // ====================================================================
        // NEW: è¼”åŠ©åŠŸèƒ½ - ç²å–è‡ªå‹•é¡¯ç¤ºçš„ç­åˆ¥ (Modified + Conflicted)
        // ====================================================================
        /**
         * ç²å–æ‰€æœ‰å·²ä¿®æ”¹æˆ–å­˜åœ¨è¡çªçš„ç­åˆ¥åˆ—è¡¨ã€‚
         * è¡çªåŒ…æ‹¬ï¼šç¼ºå°‘è€å¸« (ç²‰ç´…è‰²) æˆ– æ•™å¸«è¡çª (æ©™è‰²)ã€‚
         * @param {string} selectedDay - é¸æ“‡çš„æ—¥å­ã€‚
         * @returns {string[]} å”¯ä¸€ä¸”æ’åºå¾Œçš„ç­åˆ¥åç¨±åˆ—è¡¨ã€‚
         */
        function getAutoClasses(selectedDay) {
            const autoClassesSet = new Set();
            
            // ç²å–è©²æ—¥å­æ‰€æœ‰çš„ç­åˆ¥
            const allClasses = [...new Set(scheduleData.filter(item => item['æ—¥å­'] === selectedDay).map(item => item['ç­åˆ¥']).filter(Boolean))].sort();

            // 1. --- Modified Check (å·²ä¿®æ”¹) ---
            scheduleData.forEach(currentRecord => {
                if (currentRecord['æ—¥å­'] !== selectedDay) return;

                if (isRecordModified(currentRecord)) {
                    autoClassesSet.add(currentRecord['ç­åˆ¥']);
                }
            });

            // 2. --- Conflict Check (ç¼ºå°‘è€å¸« / æ•™å¸«è¡çª) ---
            
            // ç²å–è©²æ—¥å­æ‰€æœ‰éé‡è¤‡çš„æ™‚é–“æ®µ
            const allTimeSlots = [...new Set(scheduleData
                .filter(item => item['æ—¥å­'] === selectedDay && item['æ™‚é–“'])
                .map(item => item['æ™‚é–“']))
            ];
            
            // Group data by time slot and class
            const aggregatedData = new Map();
            scheduleData.forEach(item => {
                if (item['æ—¥å­'] === selectedDay) {
                    if (!aggregatedData.has(item['æ™‚é–“'])) {
                        aggregatedData.set(item['æ™‚é–“'], new Map());
                    }
                    aggregatedData.get(item['æ™‚é–“']).set(item['ç­åˆ¥'], {
                        lesson: String(item['èª²å ‚'] || '---').trim(),
                        teacher: String(item['ä¸Šèª²æ•™å¸«'] || '').trim()
                    });
                }
            });
            
            allTimeSlots.forEach(timeSlot => {
                const teachingTeachers = new Map(); // Map<TeacherName, Set<ClassName>>
                const classDataMap = aggregatedData.get(timeSlot) || new Map();
                
                // 1. First Pass: Detect all teachers teaching in this slot and check for missing teachers
                allClasses.forEach(className => {
                    const classLesson = classDataMap.get(className);
                    if (classLesson) {
                        const lesson = classLesson.lesson;
                        const rawTeacher = classLesson.teacher;
                        const teachers = splitTeacherList(rawTeacher);
                        
                        const isLesson = !NON_LESSON_ACTIVITIES.includes(lesson);

                        // Check for Missing Teacher (Pink Background)
                        if (isLesson && teachers.length === 0) {
                            autoClassesSet.add(className);
                        }

                        // Collect teaching info for conflict check
                        if (isLesson) {
                            teachers.forEach(teacher => {
                                if (teacher.length > 0 && teacher !== '---') { 
                                    if (!teachingTeachers.has(teacher)) {
                                        teachingTeachers.set(teacher, new Set());
                                    }
                                    teachingTeachers.get(teacher).add(className);
                                }
                            });
                        }
                    }
                });

                // 2. Second Pass: Check for Multi-Class Conflict (Orange/Yellow Background)
                const conflictedTeachers = new Set();
                teachingTeachers.forEach((classesSet, teacher) => {
                    if (classesSet.size >= 2) { 
                        conflictedTeachers.add(teacher);
                    }
                });
                
                if (conflictedTeachers.size > 0) {
                    // Find which classes are involved in this conflict
                    allClasses.forEach(className => {
                        const classLesson = classDataMap.get(className);
                        if (classLesson) {
                             const rawTeacher = classLesson.teacher;
                             const teachers = splitTeacherList(rawTeacher);
                             const hasConflict = teachers.some(teacher => conflictedTeachers.has(teacher));
                             if (hasConflict) {
                                  autoClassesSet.add(className);
                             }
                        }
                    });
                }
            });

            return Array.from(autoClassesSet).sort();
        }
        
        function updateDisplays() {
            displaySchedule();
            displayTeacherSchedule();
            // åœ¨æ•¸æ“šæ›´æ–°å¾Œï¼Œç¢ºä¿å„²å­˜æŒ‰éˆ•å¯ç”¨
            saveDataBtn.disabled = false; 
            generateReportBtn.disabled = false; // MODIFIED: Enable Report CSV button
            resetDataBtn.disabled = false; // Enable Reset button
        }
        
        // ====================================================================
        // æ•¸æ“šè¼‰å…¥èˆ‡åˆå§‹åŒ– (ç•¥)
        // ====================================================================

        function loadDataAndPopulateControls() {
             resultMessage.textContent = 'è¼‰å…¥æ’èª²è¡¨...'; 
             teacherResultMessage.textContent = 'è¼‰å…¥æ’èª²è¡¨...';
            loadTeacherList();
        }
        
        function loadTeacherList() {
            Papa.parse(TEACHER_LIST_FILE_PATH, {
                download: true,
                header: false, 
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    if (results.data.length > 0 && results.data[0].length > 0) {
                        teacherListCache = results.data
                            .map(row => String(row[0] || '').trim()) 
                            .filter(name => name.length > 0 && name !== 'Teacher List'); 

                        teacherResultMessage.textContent = `âœ… æ•™å¸«åå–®æª”æ¡ˆè¼‰å…¥æˆåŠŸ (å…± ${teacherListCache.length} ä½æ•™å¸«)ã€‚è¼‰å…¥æ’èª²è¡¨...`;
                    } else {
                        teacherResultMessage.textContent = `âš ï¸ æ•™å¸«åå–®æª”æ¡ˆè¼‰å…¥æˆåŠŸï¼Œä½†å…§å®¹ç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢ºã€‚è¼‰å…¥æ’èª²è¡¨...`;
                    }
                    loadScheduleData();
                },
                error: function(err) {
                    console.error("PapaParse Teacher List Error:", err);
                    teacherResultMessage.textContent = `âŒ è¼‰å…¥æ•™å¸«åå–®æª”æ¡ˆå¤±æ•—ã€‚è«‹ç¢ºèªæª”æ¡ˆ "${TEACHER_LIST_FILE_PATH}" å­˜åœ¨ã€‚è¼‰å…¥æ’èª²è¡¨...`;
                    loadScheduleData();
                }
            });
        }


        function loadScheduleData() {
            Papa.parse(CSV_FILE_PATH, {
                download: true,         
                header: true,           
                skipEmptyLines: true,   
                dynamicTyping: true,    
                complete: function(results) {
                    scheduleData = results.data; 

                    if (scheduleData.length === 0 || !scheduleData[0]['æ—¥å­'] || !scheduleData[0]['ç­åˆ¥']) {
                        const errorMsg = "æ’èª²è¡¨æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆæ•¸æ“šï¼Œæˆ–æ¬„ä½æ¨™é¡Œä¸æ­£ç¢ºã€‚";
                        console.error(errorMsg);
                        resultMessage.textContent = `âŒ æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼š${errorMsg}`;
                        disableAllControls();
                        return;
                    }
                    
                    // --- æ ¸å¿ƒä¿®æ”¹é»: åˆå§‹åŒ–åŸå§‹æ•¸æ“šåœ°åœ– (è¨­å®šåŸºç·š) ---
                    // æ­¤è™•è¨­å®šçš„ baseline ä¸æ‡‰è¢«ä»»ä½•å¾ŒçºŒçš„ loadData å‹•ä½œä¿®æ”¹
                    initializeOriginalDataMap(scheduleData);

                    resultMessage.textContent = 'è¼‰å…¥æ’èª²è¡¨æˆåŠŸã€‚è¼‰å…¥æ•™å¸«ç­‰ç´šæª”æ¡ˆ...'; 
                    
                    if (teacherListCache.length === 0) {
                        teacherListCache = deriveTeachersFromSchedule();
                        teacherResultMessage.textContent += ` (å‚™ç”¨: å¾æ’èª²è¡¨æ¨å°å‡º ${teacherListCache.length} ä½æ•™å¸«åå–®)`;
                    }

                    loadTeacherGrades();
                },
                error: function(err) {
                    console.error("PapaParse Schedule Error:", err);
                    resultMessage.textContent = `âŒ è¼‰å…¥æ’èª²è¡¨æª”æ¡ˆå¤±æ•—ã€‚è«‹ç¢ºèªæª”æ¡ˆ "${CSV_FILE_PATH}" å­˜åœ¨ã€‚`;
                    teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">æ’èª²è¡¨æª”æ¡ˆè¼‰å…¥å¤±æ•—ã€‚</td></tr>`;
                    disableAllControls();
                }
            });
        }
        
        function deriveTeachersFromSchedule() {
            const teacherSet = new Set();
            scheduleData.forEach(item => {
                if (item['ä¸Šèª²æ•™å¸«']) {
                    splitTeacherList(item['ä¸Šèª²æ•™å¸«']).forEach(name => teacherSet.add(name));
                }
                if (item['å¯ä»£èª²æ•™å¸«']) {
                    splitTeacherList(item['å¯ä»£èª²æ•™å¸«']).forEach(name => teacherSet.add(name));
                }
            });
            return Array.from(teacherSet).filter(name => name !== '---' && name.length > 0);
        }


        function loadTeacherGrades() {
            Papa.parse(GRADE_FILE_PATH, {
                download: true,
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(gradeResults) {
                    if (gradeResults.data.length > 0 && gradeResults.data[0]['æ•™å¸«'] && gradeResults.data[0]['Grade']) {
                        gradeResults.data.forEach(item => {
                            if (item['æ•™å¸«'] && item['Grade']) {
                                teacherGradesMap.set(String(item['æ•™å¸«']).trim(), String(item['Grade']).trim());
                            }
                        });
                        teacherResultMessage.textContent += ' âœ… æ•™å¸«ç­‰ç´šæª”æ¡ˆè¼‰å…¥æˆåŠŸã€‚';
                    } else {
                        teacherResultMessage.textContent += ` âš ï¸ æ•™å¸«ç­‰ç´šæª”æ¡ˆè¼‰å…¥æˆåŠŸï¼Œä½†å…§å®¹æ ¼å¼å¯èƒ½ä¸æ­£ç¢ºã€‚`;
                    }
                    
                    loadTimetableData(); 
                },
                error: function(err) {
                    console.error("PapaParse Grade Error:", err);
                    teacherResultMessage.textContent += ` âŒ è¼‰å…¥æ•™å¸«ç­‰ç´šæª”æ¡ˆå¤±æ•—ã€‚è«‹ç¢ºèªæª”æ¡ˆ "${GRADE_FILE_PATH}" å­˜åœ¨ã€‚`;
                    loadTimetableData(); 
                }
            });
        }
        
        // è¼‰å…¥æ™‚é–“è¡¨æ•¸æ“šæ™‚ï¼Œå°‡ä¸åŒæ™‚é–“è¡¨åˆ†çµ„
        function loadTimetableData() {
            Papa.parse(TIMETABLE_FILE_PATH, {
                download: true,
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(timetableResults) {
                    if (timetableResults.data.length > 0 && timetableResults.data[0]['æ™‚é–“'] && timetableResults.data[0]['ç¯€æ•¸']) {
                        
                        // å‡è¨­æ™‚é–“è¡¨çµæ§‹ï¼šDay1-4 çš„è¨˜éŒ„åœ¨å‰ï¼ŒDay5 çš„è¨˜éŒ„åœ¨å¾Œ
                        const defaultSplitIndex = 17; // åŸºæ–¼æ‚¨æä¾›çš„ç¯„ä¾‹ï¼Œ08:00-15:05 çµæŸå¾Œå…± 17 è¡Œ
                        
                        const timetable1 = timetableResults.data.slice(0, defaultSplitIndex);
                        const timetable2 = timetableResults.data.slice(defaultSplitIndex).filter(item => item['æ™‚é–“']); 
                        
                        const finalMap1 = new Map();
                        timetable1.forEach(item => finalMap1.set(String(item['æ™‚é–“']).trim(), String(item['ç¯€æ•¸']).trim()));
                        
                        const finalMap2 = new Map();
                        timetable2.forEach(item => finalMap2.set(String(item['æ™‚é–“']).trim(), String(item['ç¯€æ•¸']).trim()));

                        // å„²å­˜åˆ°æ ¸å¿ƒ Map
                        timetableDayTypeMap.set('Day1-4', finalMap1);
                        timetableDayTypeMap.set('Day5', finalMap2);

                        teacherResultMessage.textContent += ` âœ… ç¯€æ•¸æ™‚é–“è¡¨æª”æ¡ˆè¼‰å…¥æˆåŠŸã€‚å·²è¼‰å…¥ Day1-4 (${finalMap1.size} ç­†) å’Œ Day5 (${finalMap2.size} ç­†) å…©çµ„æ™‚é–“è¡¨ã€‚`;
                    } else {
                        teacherResultMessage.textContent += ` âš ï¸ ç¯€æ•¸æ™‚é–“è¡¨æª”æ¡ˆè¼‰å…¥æˆåŠŸï¼Œä½†å…§å®¹æ ¼å¼å¯èƒ½ä¸æ­£ç¢ºã€‚`;
                    }
                    
                    populateControls(); 
                },
                error: function(err) {
                    console.error("PapaParse Timetable Error:", err);
                    teacherResultMessage.textContent += ` âŒ è¼‰å…¥ç¯€æ•¸æ™‚é–“è¡¨æª”æ¡ˆå¤±æ•—ã€‚è«‹ç¢ºèªæª”æ¡ˆ "${TIMETABLE_FILE_PATH}" å­˜åœ¨ã€‚`;
                    populateControls(); 
                }
            });
        }


        function disableAllControls() {
            daySelect.disabled = true;
            classSelect.disabled = true;
            teacherNameInput.disabled = true; 
            lessonNumberInput.disabled = true; 
            priorityTeacherInput.disabled = true; 
            dutyTeacherInput.disabled = true; 
            
            // Adjustment controls
            classSelectClear.disabled = true; // NEW
            classSelectAdj.disabled = true;
            swapClassesBtn.disabled = true;
            clearTeachersBtn.disabled = true;
            addTeacherBtn.disabled = true;

            // Swap Specific Controls
            swapClass1Select.disabled = true;
            swapLessons1Input.disabled = true;
            swapClass2Select.disabled = true;
            swapLessons2Input.disabled = true;
            
            // Save/Load
            saveDataBtn.disabled = true; 
            loadFileInput.disabled = true;
            loadDataBtn.disabled = true;
            generateReportBtn.disabled = true; // MODIFIED: Disable Report CSV button
            resetDataBtn.disabled = true; // NEW: Disable Reset button
        }

        function populateControls() {
            daySelect.disabled = false;
            classSelect.disabled = false;
            teacherNameInput.disabled = false;
            lessonNumberInput.disabled = false;
            priorityTeacherInput.disabled = false; 
            dutyTeacherInput.disabled = false;
            
            // Adjustment controls
            classSelectClear.disabled = false; // NEW
            classSelectAdj.disabled = false;
            swapClassesBtn.disabled = false;
            clearTeachersBtn.disabled = false;
            addTeacherBtn.disabled = false;

            // Swap Specific Controls
            swapClass1Select.disabled = false;
            swapLessons1Input.disabled = false;
            swapClass2Select.disabled = false;
            swapLessons2Input.disabled = false;
            
            // Save/Load
            saveDataBtn.disabled = false; 
            loadFileInput.disabled = false;
            loadDataBtn.disabled = false;
            generateReportBtn.disabled = false; // MODIFIED: Enable Report CSV button
            resetDataBtn.disabled = false; // NEW: Enable Reset button
            
            const allDays = [...new Set(scheduleData.map(item => item['æ—¥å­']).filter(Boolean))].sort((a, b) => {
                 // ç¢ºä¿æ˜ŸæœŸä¸€åˆ°äº”çš„é †åº
                const order = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­', 'æ˜ŸæœŸæ—¥'];
                return order.indexOf(a) - order.indexOf(b);
            });
            const allClasses = [...new Set(scheduleData.map(item => item['ç­åˆ¥']).filter(Boolean))].sort();

            populateSelect(daySelect, allDays, 'æ—¥å­');
            
            // --- Class Select (Section 2) ---
            classSelect.innerHTML = ''; 
            
            // 0. NEW: Auto Class option
            const autoOption = document.createElement('option');
            autoOption.value = 'AUTO_CONFLICTS';
            autoOption.textContent = '--- è‡ªå‹•é¡¯ç¤ºæœ‰æ›´æ”¹/è¡çªçš„ç­åˆ¥ (Auto) ---';
            classSelect.appendChild(autoOption);

            // 1. ALL option
            const allOption = document.createElement('option');
            allOption.value = 'ALL';
            allOption.textContent = '--- æ‰€æœ‰ç­åˆ¥ (All Classes) ---';
            classSelect.appendChild(allOption);
            
            // 2. NEW Custom Multi-Class option
            const customOption = document.createElement('option');
            customOption.value = 'CUSTOM_MULTI';
            customOption.textContent = '--- è‡ªè¨‚å¤šç­åˆ¥ (Custom Multi-Class) ---';
            classSelect.appendChild(customOption);

            // 3. Individual Class options
            allClasses.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                classSelect.appendChild(opt);
            });

            if (allClasses.length > 0) {
                 classSelect.value = 'AUTO_CONFLICTS'; // NEW Default: Auto
                 // Ensure the multi-class input is hidden initially
                 multiClassInputGroup.style.display = 'none';
            }
            
            // --- Class Select for Clear (Section 3.2) ---
            classSelectClear.innerHTML = '';
            // 1. ALL option (Default for Clear)
            const allOptionClear = document.createElement('option');
            allOptionClear.value = 'ALL';
            allOptionClear.textContent = '--- æ‰€æœ‰ç­åˆ¥ (All Classes) ---';
            classSelectClear.appendChild(allOptionClear);
            // 2. Individual Class options
            allClasses.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                classSelectClear.appendChild(opt);
            });
            if (allClasses.length > 0) classSelectClear.value = 'ALL';
            
            // --- Class Select for Adjustment (Section 3.3) ---
            // classSelectAdj is for Add only, no 'ALL' option
            populateSelect(classSelectAdj, allClasses, 'ç›®æ¨™ç­åˆ¥'); 
            if (allClasses.length > 0) classSelectAdj.value = allClasses[0];

            // --- Class Select for Swap (Section 3.1) ---
            // swapClass1Select and swapClass2Select are for Swap
            populateSelect(swapClass1Select, allClasses, 'A ç­åˆ¥'); 
            populateSelect(swapClass2Select, allClasses, 'B ç­åˆ¥');
            if (allClasses.length > 0) {
                swapClass1Select.value = allClasses[0];
                swapClass2Select.value = allClasses[0];
            }
            
            if (allDays.length > 0) daySelect.value = allDays[0];

            displayTeacherSchedule(); 
            displaySchedule();
        }

        function populateSelect(selectElement, options, name) {
            selectElement.innerHTML = ''; 
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = `--- è«‹é¸æ“‡ ${name} ---`;
            selectElement.appendChild(defaultOption);

            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        }

        // ====================================================================
        // EVENT HANDLER FOR CLASS SELECT
        // ====================================================================
        function handleClassSelectChange() {
            const selectedClass = classSelect.value;
            if (selectedClass === 'CUSTOM_MULTI') {
                // Display the custom input field
                multiClassInputGroup.style.display = 'flex'; 
            } else {
                // Hide the custom input field
                multiClassInputGroup.style.display = 'none'; 
            }
            displaySchedule(); // Update the display based on selection
        }
        
        // ====================================================================
        // NEW EVENT HANDLER FOR CLICK-TO-FILL (SECTION 2) - UPDATED
        // ====================================================================
        function handleScheduleClick(event) {
            let cell = event.target.closest('td');
            if (!cell) return;

            let row = cell.closest('tr');
            if (!row) return;

            const selectedClassMode = classSelect.value;
            let className = '';
            let lessonNumber = '';
            
            const rowCells = Array.from(row.cells);
            const cellIndex = rowCells.indexOf(cell);

            // Check if the clicked cell is one of the initial (non-class) columns
            if (cellIndex === 0 || cellIndex === 1) {
                adjustmentMessage.textContent = 'âš ï¸ è«‹é»æ“Šèª²è¡¨ä¸­çš„ç‰¹å®š**ç­ç´šèª²å ‚å–®å…ƒæ ¼** (éç¯€æ•¸/æ™‚é–“æ¬„) ä¾†è‡ªå‹•å¡«å¯«è³‡è¨Šã€‚';
                adjustmentMessage.style.color = 'orange';
                return;
            }

            if (selectedClassMode === 'ALL' || selectedClassMode === 'CUSTOM_MULTI' || selectedClassMode === 'AUTO_CONFLICTS') {
                // Multi-Class or All-Class View or Auto View
                lessonNumber = row.cells[0].textContent.trim();
                
                const headerRow = scheduleHeader.querySelector('tr');
                if (headerRow) {
                    const headerCell = headerRow.cells[cellIndex];
                    if (headerCell && cellIndex >= 2) { 
                        className = headerCell.textContent.trim();
                    }
                }
                
            } else {
                // Single Class View
                className = selectedClassMode;
                lessonNumber = row.cells[0].textContent.trim();
            }
            
            // Final validation and filling
            if (className && lessonNumber && lessonNumber !== '---') {
                
                // --- NEW LOGIC: Find the exact time slot and current teacher(s) ---
                const selectedDay = daySelect.value;
                
                // 1. Convert lessonNumber to timeSlot
                const timeSlots = getTimeSlotsByLessonNumbers(selectedDay, lessonNumber);
                const timeSlot = timeSlots[0]; // Take the first (and hopefully only) result
                
                let rawTeachers = '';
                
                if (timeSlot) {
                    // 2. Search scheduleData for the exact record
                    const targetRecord = scheduleData.find(record => 
                        String(record['æ—¥å­']).trim() === selectedDay &&
                        String(record['ç­åˆ¥']).trim() === className &&
                        String(record['æ™‚é–“']).trim() === timeSlot
                    );
                    
                    if (targetRecord) {
                        // ç¢ºä¿åªæœ‰éæ´»å‹•èª²å ‚çš„æ•™å¸«æ‰è¢«å¡«å…¥
                        const lesson = String(targetRecord['èª²å ‚'] || '').trim();
                        if (!NON_LESSON_ACTIVITIES.includes(lesson)) {
                            rawTeachers = String(targetRecord['ä¸Šèª²æ•™å¸«'] || '').trim();
                        }
                    }
                }
                // --- END NEW LOGIC ---


                // Fill lessons inputs in 3.2 and 3.3
                clearLessonsInput.value = lessonNumber;
                addLessonsInput.value = lessonNumber;
                
                // NEW: Fill teacher input in 3.2 (Clear Teachers)
                clearTeachersInput.value = rawTeachers;
                
                // Fill class selectors.
                const classToFill = className;
                
                if (Array.from(classSelectClear.options).some(opt => opt.value === classToFill)) {
                    classSelectClear.value = classToFill; 
                }
                if (Array.from(classSelectAdj.options).some(opt => opt.value === classToFill)) {
                    classSelectAdj.value = classToFill; 
                }
                
                adjustmentMessage.textContent = `âœ… å·²å°‡ ${className} ç­ ${lessonNumber} ç¯€ (æ•™å¸«: ${rawTeachers || 'ç„¡'}) çš„è³‡è¨Šå¡«å…¥èª¿å‹•åŠŸèƒ½ã€‚`;
                adjustmentMessage.style.color = 'green';
            } else {
                adjustmentMessage.textContent = 'âš ï¸ é»æ“Šçš„å–®å…ƒæ ¼å…§å®¹ç„¡æ•ˆ (ä¾‹å¦‚: ç¯€æ•¸æˆ–ç­åˆ¥åç¨±ç‚º ---)ã€‚';
                adjustmentMessage.style.color = 'orange';
            }
        }


        // ====================================================================
        // 1. æ•™å¸«ç©ºé–’æŸ¥è©¢ (Teacher Free Time Lookup) - ä¸»å‡½æ•¸ (ç•¥)
        // ====================================================================
        
        function displayFreeTeachersOnly(selectedDay, timeSlots) {
            const allTeachers = getAllTeachers();
            const dailyFreeLessonsMap = calculateDailyFreeLessons(selectedDay); 
            const priorityTeachers = new Set(splitTeacherList(priorityTeacherInput.value.trim()));
            const dutyTeachers = new Set(splitTeacherList(dutyTeacherInput.value.trim()));
            
            const currentTimetableMap = getCurrentTimetableMap(selectedDay); 
            
            teacherScheduleBody.innerHTML = '';
            
            const relevantLessons = scheduleData.filter(item => 
                item['æ—¥å­'] === selectedDay && timeSlots.includes(item['æ™‚é–“'])
            ).sort((a, b) => timeToMinutes(a['æ™‚é–“']) - timeToMinutes(b['æ™‚é–“']));
            
            const uniqueTimeSlots = [...new Set(relevantLessons.map(item => item['æ™‚é–“']))];
            
            if (uniqueTimeSlots.length === 0) {
                teacherResultMessage.textContent = `åœ¨ ${selectedDay}ï¼ŒæŒ‡å®šç¯€æ•¸æ²’æœ‰æ‰¾åˆ°ä»»ä½•èª²å ‚è¨˜éŒ„ã€‚`;
                teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">ç„¡è³‡æ–™ã€‚</td></tr>`;
                return;
            }

            uniqueTimeSlots.forEach(timeSlot => {
                const lessonNumber = currentTimetableMap.get(timeSlot) || '---'; 
                
                const row = teacherScheduleBody.insertRow();
                row.className = 'timeslot-header-row'; 
                
                row.insertCell().textContent = lessonNumber;
                row.insertCell().textContent = timeSlot;
                
                const classesInSlot = relevantLessons.filter(l => l['æ™‚é–“'] === timeSlot)
                    .map(l => {
                        const lesson = l['èª²å ‚'] || '---';
                        const teacher = l['ä¸Šèª²æ•™å¸«'] || '';
                        const styledTeachers = splitTeacherList(teacher || '---')
                            .map(name => getStyledTeacherName(name))
                            .join(' / ');
                        return `**${l['ç­åˆ¥']}**: ${lesson} - ${styledTeachers}`;
                    })
                    .join('<br>');
                    
                const classesCell = row.insertCell();
                classesCell.colSpan = 2; 
                classesCell.innerHTML = classesInSlot || '--- (ç„¡èª²å ‚è¨˜éŒ„) ---';
                
                const occupiedTeachers = getOccupiedTeachers(selectedDay, timeSlot);
                
                const freeTeachersNames = allTeachers.filter(teacher => 
                    !occupiedTeachers.has(teacher) && 
                    !dutyTeachers.has(teacher)
                );
                
                const freeTeachersWithCount = freeTeachersNames.map(teacher => ({
                    name: teacher,
                    freeCount: dailyFreeLessonsMap.get(teacher) || 0 
                }));

                freeTeachersWithCount.sort((a, b) => {
                    const aIsPriority = priorityTeachers.has(a.name);
                    const bIsPriority = priorityTeachers.has(b.name);

                    if (aIsPriority && !bIsPriority) return -1;
                    if (!aIsPriority && bIsPriority) return 1;
                    
                    return b.freeCount - a.freeCount;
                });

                const freeTeachersString = freeTeachersWithCount
                    .map(item => {
                        const isPriority = priorityTeachers.has(item.name);
                        const styledName = getFreeListStyledTeacherName(item.name, isPriority);
                        return `${styledName} (${item.freeCount})`;
                    })
                    .join(', ');

                const freeTeachersCell = row.insertCell();
                freeTeachersCell.innerHTML = freeTeachersString || 'ç„¡æ•™å¸«ç©ºé–’';
            });
            
            teacherResultMessage.textContent = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}ï¼ŒæŒ‡å®šç¯€æ•¸ (${timeSlots.map(t => currentTimetableMap.get(t)).join(', ')}) çš„ç©ºé–’æ•™å¸«åå–® (å…± ${uniqueTimeSlots.length} å€‹æ™‚æ®µ)ã€‚`;
        }


        function displayTeacherSchedule() {
            if (scheduleData.length === 0 || teacherListCache.length === 0) {
                teacherResultMessage.textContent = 'æ•¸æ“šè¼‰å…¥ä¸­ï¼Œæˆ–æ•™å¸«åå–®ç‚ºç©ºã€‚';
                teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">è«‹ç­‰å¾…æ‰€æœ‰æ•¸æ“šè¼‰å…¥ã€‚</td></tr>`; 
                return;
            }

            const selectedDay = daySelect.value;
            const rawInput = teacherNameInput.value.trim(); 
            const teacherNames = splitTeacherList(rawInput);
            
            const lessonNumberString = lessonNumberInput.value.trim(); 
            const filterTimeSlots = getTimeSlotsByLessonNumbers(selectedDay, lessonNumberString); 
            const isFilteringBySlot = filterTimeSlots.length > 0;
            
            const priorityTeachers = new Set(splitTeacherList(priorityTeacherInput.value.trim()));
            const dutyTeachers = new Set(splitTeacherList(dutyTeacherInput.value.trim()));
            
            const currentTimetableMap = getCurrentTimetableMap(selectedDay); 

            teacherScheduleBody.innerHTML = '';
            teacherResultMessage.textContent = '';

            if (!selectedDay) {
                 teacherResultMessage.textContent = 'è«‹å…ˆé¸æ“‡æ—¥å­ã€‚';
                 teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">è«‹å…ˆé¸æ“‡æ—¥å­ã€‚</td></tr>`; 
                 return;
            }

            // Case 2: Lesson Number ONLY
            if (teacherNames.length === 0 && isFilteringBySlot) {
                displayFreeTeachersOnly(selectedDay, filterTimeSlots);
                return;
            }

            // Case 1 & 3: Requires Teacher Name
            if (teacherNames.length === 0) {
                teacherResultMessage.textContent = 'è«‹è¼¸å…¥æ•™å¸«å§“åæˆ–ç¯€æ•¸ä»¥æŸ¥è©¢ç©ºé–’æ•™å¸«ã€‚';
                teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">è«‹è¼¸å…¥æ•™å¸«å§“åæˆ–ç¯€æ•¸ã€‚</td></tr>`; 
                return;
            }
            
            // Proceed with Teacher-based query (Case 1 or 3)
            let combinedTeacherLessons = [];
            const allTeachers = getAllTeachers(); 
            const dailyFreeLessonsMap = calculateDailyFreeLessons(selectedDay); 

            teacherNames.forEach(teacherName => {
                const targetTeacherLessons = scheduleData.filter(item => {
                    if (item['æ—¥å­'] !== selectedDay) return false;
                    
                    // Case 3 Filter: Filter by Slot if specified
                    if (isFilteringBySlot && !filterTimeSlots.includes(item['æ™‚é–“'])) {
                        return false;
                    }
                    
                    const teachingNames = splitTeacherList(item['ä¸Šèª²æ•™å¸«']);
                    return teachingNames.includes(teacherName);
                });
                
                if (targetTeacherLessons.length > 0) {
                    
                    targetTeacherLessons.sort((a, b) => timeToMinutes(a['æ™‚é–“']) - timeToMinutes(b['æ™‚é–“']));
                    
                    const styledHeaderName = getStyledTeacherName(teacherName);
                    combinedTeacherLessons.push({ isHeader: true, name: styledHeaderName });
                    combinedTeacherLessons.push(...targetTeacherLessons);
                }
            });

            if (combinedTeacherLessons.length === 0) {
                teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">åœ¨ ${selectedDay}ï¼Œæ‚¨æŸ¥è©¢çš„æ•™å¸« ${teacherNames.join('ã€')} æ²’æœ‰ä»»æ•™èª²å ‚${isFilteringBySlot ? ` (æ–¼ç¯€æ•¸ ${lessonNumberString})` : ''}ã€‚</td></tr>`; 
                return;
            }
            
            let totalLessonsCount = 0;
            combinedTeacherLessons.forEach(lesson => {
                if (lesson.isHeader) {
                    const row = teacherScheduleBody.insertRow();
                    row.className = 'teacher-header-row';
                    row.insertCell().innerHTML = `æ•™å¸«: ${lesson.name}`; 
                    row.insertCell().colSpan = 4; 
                    row.cells[0].colSpan = 1; 
                    row.cells[1].textContent = 'è©²æ•™å¸«çš„æ’èª²';
                    return;
                }
                
                const row = teacherScheduleBody.insertRow();
                const lessonTime = lesson['æ™‚é–“'] || '---';
                const lessonNumber = currentTimetableMap.get(lessonTime) || '---'; 

                totalLessonsCount++;
                
                const occupiedTeachers = getOccupiedTeachers(selectedDay, lessonTime);
                
                const freeTeachersNames = allTeachers.filter(teacher => 
                    !occupiedTeachers.has(teacher) && 
                    !teacherNames.includes(teacher) && // æ’é™¤ç›®æ¨™æŸ¥è©¢æ•™å¸«
                    !dutyTeachers.has(teacher)
                );

                const freeTeachersWithCount = freeTeachersNames.map(teacher => ({
                    name: teacher,
                    freeCount: dailyFreeLessonsMap.get(teacher) || 0 
                }));

                freeTeachersWithCount.sort((a, b) => {
                    const aIsPriority = priorityTeachers.has(a.name);
                    const bIsPriority = priorityTeachers.has(b.name);

                    if (aIsPriority && !bIsPriority) return -1;
                    if (!aIsPriority && bIsPriority) return 1;
                    
                    return b.freeCount - a.freeCount;
                });

                const freeTeachersString = freeTeachersWithCount
                    .map(item => {
                        const isPriority = priorityTeachers.has(item.name);
                        const styledName = getFreeListStyledTeacherName(item.name, isPriority);
                        return `${styledName} (${item.freeCount})`;
                    })
                    .join(', ');


                row.insertCell().textContent = lessonNumber; 
                row.insertCell().textContent = lessonTime;
                row.insertCell().textContent = lesson['ç­åˆ¥'] || '---';
                row.insertCell().textContent = lesson['èª²å ‚'] || '---';

                const freeTeachersCell = row.insertCell();
                freeTeachersCell.innerHTML = freeTeachersString || 'ç„¡å…¶ä»–æ•™å¸«ç©ºé–’';
            });
            
            let message = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}ï¼Œæ•™å¸« ${teacherNames.join('ã€')} çš„åˆä½µèª²å ‚å®‰æ’ (å…± ${totalLessonsCount} ç¯€)`;
            if(isFilteringBySlot) {
                message += ` (å·²ç¯©é¸ç¯€æ•¸: ${lessonNumberString})`;
            }
            teacherResultMessage.textContent = message + `ã€‚`;
        }

        // ====================================================================
        // 2. ç­ç´šèª²è¡¨æŸ¥è©¢
        // ====================================================================

        function displaySchedule() {
            if (scheduleData.length === 0) return;

            const selectedDay = daySelect.value;
            const selectedClass = classSelect.value;
            
            const singleClassHeader = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th><th>èª²å ‚</th><th>ä¸Šèª²æ•™å¸«</th></tr>';

            if (!selectedDay) {
                resultMessage.textContent = 'è«‹é¸æ“‡æ—¥å­ã€‚';
                scheduleHeader.innerHTML = singleClassHeader;
                scheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">è«‹é¸æ“‡æ—¥å­ã€‚</td></tr>`; 
                return;
            }

            if (selectedClass === 'AUTO_CONFLICTS') {
                displayAutoClassesSchedule(selectedDay);
                return;
            }
            
            if (selectedClass === 'ALL') {
                displayAllClassesSchedule(selectedDay);
                return;
            }
            
            if (selectedClass === 'CUSTOM_MULTI') {
                const customClassesString = multiClassInput.value.trim();
                const customClasses = splitTeacherList(customClassesString); 
                displayCustomMultiClassesSchedule(selectedDay, customClasses);
                return;
            }
            
            // ADDED: The default option for the select is an empty string, handle it.
            if (!selectedClass || selectedClass.startsWith('---')) {
                resultMessage.textContent = 'è«‹é¸æ“‡ç­åˆ¥ä»¥æŸ¥çœ‹èª²è¡¨ã€‚';
                scheduleHeader.innerHTML = singleClassHeader;
                scheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">è«‹é¸æ“‡ç­åˆ¥ã€‚</td></tr>`; 
                return;
            }
            
            // Single Class View Logic
            const currentTimetableMap = getCurrentTimetableMap(selectedDay);
            scheduleHeader.innerHTML = singleClassHeader;

            const filteredSchedule = scheduleData.filter(item => 
                item['æ—¥å­'] === selectedDay && item['ç­åˆ¥'] === selectedClass
            ).sort((a, b) => timeToMinutes(a['æ™‚é–“']) - timeToMinutes(b['æ™‚é–“'])); 

            scheduleBody.innerHTML = ''; // Clear previous results

            if (filteredSchedule.length === 0) {
                resultMessage.textContent = `åœ¨ ${selectedDay}ï¼Œ${selectedClass} ç­æ²’æœ‰æ‰¾åˆ°èª²è¡¨æ•¸æ“šã€‚`;
                scheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">åœ¨ ${selectedDay}ï¼Œ${selectedClass} ç­æ²’æœ‰æ‰¾åˆ°èª²è¡¨æ•¸æ“šã€‚</td></tr>`; 
                return;
            }

            filteredSchedule.forEach(lesson => {
                const row = scheduleBody.insertRow();
                
                const getTime = lesson['æ™‚é–“'] || '---';
                const getLesson = String(lesson['èª²å ‚'] || '---').trim(); 
                
                const rawTeacherValue = lesson['ä¸Šèª²æ•™å¸«'] || ''; 
                
                const getLessonNumber = currentTimetableMap.get(getTime) || '---'; 
                
                let rowStyle = '';
                const isLesson = !NON_LESSON_ACTIVITIES.includes(getLesson);
                const teachersList = splitTeacherList(rawTeacherValue);
                const isTeacherMissing = teachersList.length === 0;
                
                // NEW: Check for modification
                const isModified = isRecordModified(lesson);

                // Priority 1: Missing Teacher (Pink)
                if (isLesson && isTeacherMissing) {
                    rowStyle = 'background-color: #ffc2c2;'; // ç²‰ç´…è‰²åº•è‰²
                } 
                // Priority 2: Modified (Pink-Purple/Lavender) - ONLY if no Pink background is applied.
                else if (isModified) {
                     rowStyle = 'background-color: #E6E6FA;'; // ç²‰ç´«è‰²åº•è‰²
                }
                
                row.style.cssText = rowStyle;
                
                const displayTeacherValue = rawTeacherValue || '---';
                const styledTeachers = teachersList
                    .map(name => getStyledTeacherName(name))
                    .join(', ');

                row.insertCell().textContent = getLessonNumber; 
                row.insertCell().textContent = getTime;
                row.insertCell().textContent = getLesson;
                
                if (NON_LESSON_ACTIVITIES.includes(getLesson)) {
                    row.insertCell().textContent = '---'; 
                } else {
                    row.insertCell().innerHTML = styledTeachers || '---'; 
                }
            });
            
            resultMessage.textContent = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}, ${selectedClass} ç­çš„èª²è¡¨ (å…± ${filteredSchedule.length} ç¯€)ã€‚`;
        }
        
        /**
         * NEW: è‡ªå‹•é¡¯ç¤ºæœ‰æ›´æ”¹/è¡çªçš„ç­åˆ¥çš„èª²è¡¨ã€‚
         * @param {string} selectedDay - é¸æ“‡çš„æ—¥å­ã€‚
         */
        function displayAutoClassesSchedule(selectedDay) {
            const autoClasses = getAutoClasses(selectedDay);

            if (autoClasses.length === 0) {
                resultMessage.textContent = `âœ… åœ¨ ${selectedDay}ï¼Œæ²’æœ‰åµæ¸¬åˆ°ä»»ä½•æ›´æ”¹æˆ–æ’èª²è¡çªçš„ç­åˆ¥ã€‚`;
                scheduleHeader.innerHTML = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th><th>(ç„¡ç­åˆ¥éœ€è¦é—œæ³¨)</th></tr>'; 
                scheduleBody.innerHTML = `<tr><td colspan="3" style="text-align: center;">æ²’æœ‰ä»»ä½•ç­åˆ¥éœ€è¦è‡ªå‹•é¡¯ç¤ºã€‚</td></tr>`;
                return;
            }
            
            // å‘¼å«ç¾æœ‰çš„å¤šç­åˆ¥é¡¯ç¤ºé‚è¼¯
            displayCustomMultiClassesSchedule(selectedDay, autoClasses);
            
            // è¦†å¯«çµæœè¨Šæ¯
            const allTimeSlots = [...new Set(scheduleData
                .filter(item => item['æ—¥å­'] === selectedDay && item['æ™‚é–“'])
                .map(item => item['æ™‚é–“']))
            ];
            
            resultMessage.textContent = `âœ… æˆåŠŸè‡ªå‹•é¡¯ç¤º ${selectedDay}ï¼Œå…± ${autoClasses.length} å€‹æœ‰æ›´æ”¹/è¡çªçš„ç­åˆ¥ (${autoClasses.join('ã€')}) (å…± ${allTimeSlots.length} å€‹æ™‚é–“æ®µ)ã€‚`;
        }


        function displayCustomMultiClassesSchedule(selectedDay, customClasses) {
             if (customClasses.length === 0) {
                resultMessage.textContent = 'è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ¡†è¼¸å…¥è¦é¡¯ç¤ºçš„ç­åˆ¥ (ä¾‹å¦‚: 1A 1B 2C)ã€‚';
                scheduleHeader.innerHTML = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th><th>(è«‹è¼¸å…¥ç­åˆ¥)</th></tr>'; 
                scheduleBody.innerHTML = `<tr><td colspan="3" style="text-align: center;">è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ¡†è¼¸å…¥ç­åˆ¥ã€‚</td></tr>`;
                return;
            }
            
            const allTimeSlots = [...new Set(scheduleData
                .filter(item => item['æ—¥å­'] === selectedDay && item['æ™‚é–“'])
                .map(item => item['æ™‚é–“']))
            ].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
            
            const classMap = new Map();
            [...new Set(scheduleData.map(item => item['ç­åˆ¥']).filter(Boolean))].forEach(className => {
                classMap.set(String(className).trim().toUpperCase(), String(className).trim()); 
            });

            const targetClassesSet = new Set();
            customClasses.forEach(inputClass => {
                const normalizedInput = String(inputClass).trim().toUpperCase();
                // é€™è£¡å¿…é ˆç¢ºèªè©²ç­åˆ¥åœ¨åŸå§‹æ•¸æ“šä¸­æ˜¯å­˜åœ¨çš„
                if (classMap.has(normalizedInput)) {
                    targetClassesSet.add(classMap.get(normalizedInput)); 
                }
            });
            
            const targetClasses = Array.from(targetClassesSet).sort();
            
            const currentTimetableMap = getCurrentTimetableMap(selectedDay); 

            if (targetClasses.length === 0) {
                resultMessage.textContent = `âŒ è¼¸å…¥çš„ç­åˆ¥ ${customClasses.join('ã€')} å‡ç„¡æ•¸æ“šæˆ–æ ¼å¼éŒ¯èª¤ã€‚`;
                scheduleHeader.innerHTML = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th><th>(ç„¡ç­åˆ¥æ•¸æ“š)</th></tr>'; 
                scheduleBody.innerHTML = `<tr><td colspan="${customClasses.length + 2}" style="text-align: center;">è¼¸å…¥çš„ç­åˆ¥æ²’æœ‰æ‰¾åˆ°å°æ‡‰æ•¸æ“šã€‚</td></tr>`;
                return;
            }
            
            const aggregatedData = new Map();
            scheduleData.forEach(item => {
                if (item['æ—¥å­'] === selectedDay && targetClasses.includes(item['ç­åˆ¥'])) { 
                    if (!aggregatedData.has(item['æ™‚é–“'])) {
                        aggregatedData.set(item['æ™‚é–“'], new Map());
                    }
                    aggregatedData.get(item['æ™‚é–“']).set(item['ç­åˆ¥'], {
                        lesson: String(item['èª²å ‚'] || '---').trim(),
                        teacher: String(item['ä¸Šèª²æ•™å¸«'] || '').trim(),
                        // NEW: Pass the full record for modification check
                        record: item 
                    });
                }
            });

            let headerHtml = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th>';
            targetClasses.forEach(className => {
                headerHtml += `<th>${className}</th>`;
            });
            headerHtml += '</tr>';
            scheduleHeader.innerHTML = headerHtml; 
            
            scheduleBody.innerHTML = '';
            
            allTimeSlots.forEach(timeSlot => {
                
                const teachingTeachers = new Map(); 
                const classDataMap = aggregatedData.get(timeSlot) || new Map();
                
                targetClasses.forEach(className => {
                    const classLesson = classDataMap.get(className);
                    if (classLesson) {
                        const rawTeacher = classLesson.teacher;
                        const teachers = splitTeacherList(rawTeacher);
                        
                        const lesson = classLesson.lesson;
                        if (!NON_LESSON_ACTIVITIES.includes(lesson)) {
                            teachers.forEach(teacher => {
                                if (teacher.length > 0 && teacher !== '---') { 
                                    if (!teachingTeachers.has(teacher)) {
                                        teachingTeachers.set(teacher, new Set());
                                    }
                                    teachingTeachers.get(teacher).add(className);
                                }
                            });
                        }
                    }
                });

                const conflictedTeachers = new Set();
                teachingTeachers.forEach((classesSet, teacher) => {
                    if (classesSet.size >= 2) { 
                        conflictedTeachers.add(teacher);
                    }
                });
                
                const row = scheduleBody.insertRow();
                const lessonNumber = currentTimetableMap.get(timeSlot) || '---';
                
                row.insertCell().textContent = lessonNumber;
                row.insertCell().textContent = timeSlot;
                
                
                targetClasses.forEach(className => {
                    const cell = row.insertCell();
                    const classLesson = classDataMap.get(className);
                    
                    if (classLesson) {
                        const lesson = classLesson.lesson;
                        const rawTeacher = classLesson.teacher;
                        const teachers = splitTeacherList(rawTeacher); 
                        
                        let cellStyle = '';
                        
                        const hasConflict = teachers.some(teacher => conflictedTeachers.has(teacher));
                        
                        const isLesson = !NON_LESSON_ACTIVITIES.includes(lesson);
                        const isTeacherMissing = teachers.length === 0;
                        
                        // NEW: Check for modification using the stored record reference
                        const isModified = isRecordModified(classLesson.record);


                        // Priority 1: Teacher Conflict (Orange)
                        if (hasConflict) {
                            cellStyle = 'background-color: #FFC299;'; 
                        } 
                        // Priority 2: Missing Teacher (Pink)
                        else if (isLesson && isTeacherMissing) {
                            cellStyle = 'background-color: #ffc2c2;'; 
                        }
                        // Priority 3: Modified (Pink-Purple/Lavender)
                        else if (isModified) {
                             cellStyle = 'background-color: #E6E6FA;'; 
                        }

                        cell.style.cssText = cellStyle;
                        
                        
                        if (NON_LESSON_ACTIVITIES.includes(lesson)) {
                            cell.textContent = lesson; 
                        } else if (lesson === '---' && rawTeacher === '') {
                            cell.textContent = '---';
                        } else {
                            const displayTeacherValue = rawTeacher || '---';
                            const styledTeachers = splitTeacherList(displayTeacherValue)
                                .map(name => getStyledTeacherName(name))
                                .join(' / '); 
                                
                            cell.innerHTML = `${lesson} - ${styledTeachers}`;
                        }
                    } else {
                        cell.textContent = '---';
                    }
                });
            });

            let message = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}ï¼Œè‡ªè¨‚ ${targetClasses.length} å€‹ç­åˆ¥çš„åˆä½µèª²è¡¨ (${targetClasses.join('ã€')}) (å…± ${allTimeSlots.length} å€‹æ™‚é–“æ®µ)ã€‚`;
            if (classSelect.value === 'AUTO_CONFLICTS') {
                 message = `âœ… æˆåŠŸè‡ªå‹•é¡¯ç¤º ${selectedDay}ï¼Œå…± ${targetClasses.length} å€‹æœ‰æ›´æ”¹/è¡çªçš„ç­åˆ¥ (${targetClasses.join('ã€')}) (å…± ${allTimeSlots.length} å€‹æ™‚é–“æ®µ)ã€‚`;
            }
            resultMessage.textContent = message;
        }

        function displayAllClassesSchedule(selectedDay) {
            // Reuses the logic from displayCustomMultiClassesSchedule with all classes
            const allClasses = [...new Set(scheduleData.map(item => item['ç­åˆ¥']).filter(Boolean))].sort();
            displayCustomMultiClassesSchedule(selectedDay, allClasses); 
            // Overwrite the message to reflect 'All Classes'
            const allTimeSlots = [...new Set(scheduleData
                .filter(item => item['æ—¥å­'] === selectedDay && item['æ™‚é–“'])
                .map(item => item['æ™‚é–“']))
            ];
            resultMessage.textContent = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}ï¼Œæ‰€æœ‰ ${allClasses.length} å€‹ç­åˆ¥çš„åˆä½µèª²è¡¨ (å…± ${allTimeSlots.length} å€‹æ™‚é–“æ®µ)ã€‚`;
        }

        // ====================================================================
        // 4. å„²å­˜èˆ‡è¼‰å…¥åŠŸèƒ½ (Save & Load)
        // ====================================================================
        
        /**
         * ç²å–æ‰€æœ‰å·²ä¿®æ”¹çš„è¨˜éŒ„ï¼Œä¸¦é™„å¸¶åŸå§‹è¨˜éŒ„å’Œæ–°è¨˜éŒ„çš„æ¬„ä½ã€‚
         * @returns {Array<object>} åŒ…å« {..., èª²å ‚_åŸ, æ•™å¸«_åŸ, èª²å ‚_æ–°, æ•™å¸«_æ–°} çš„è¨˜éŒ„ã€‚
         */
        function getModifiedRecordsWithOriginal() {
             return scheduleData.map(currentRecord => {
                const key = generateRecordKey(currentRecord);
                // é€™è£¡å¿…é ˆä½¿ç”¨åŸå§‹æ•¸æ“šåœ°åœ–ä¾†é€²è¡Œæ¯”è¼ƒ
                const originalRecord = originalScheduleDataMap.get(key); 
                
                if (!originalRecord) return null; 

                // ç¢ºä¿æ–°èˆŠå€¼éƒ½ç¶“é trim() è™•ç†ï¼Œä»¥ä¾¿æ¯”è¼ƒ
                const currentLesson = String(currentRecord['èª²å ‚'] || '').trim();
                const originalLesson = originalRecord['èª²å ‚']; 
                
                const currentTeacher = String(currentRecord['ä¸Šèª²æ•™å¸«'] || '').trim();
                const originalTeacher = originalRecord['ä¸Šèª²æ•™å¸«']; 
                
                const isLessonModified = currentLesson !== originalLesson;
                const isTeacherModified = currentTeacher !== originalTeacher;
                
                if (isLessonModified || isTeacherModified) {
                    const lessonTime = currentRecord['æ™‚é–“'] || '---';
                    const lessonNumber = getCurrentTimetableMap(currentRecord['æ—¥å­']).get(lessonTime) || '---';
                    
                    return {
                        'æ—¥å­': currentRecord['æ—¥å­'],
                        'ç­åˆ¥': currentRecord['ç­åˆ¥'],
                        'ç¯€æ•¸': lessonNumber,
                        'æ™‚é–“': lessonTime,
                        'èª²å ‚_åŸ': originalLesson,
                        'èª²å ‚_æ–°': currentLesson,
                        'æ•™å¸«_åŸ': originalTeacher,
                        'æ•™å¸«_æ–°': currentTeacher,
                        'ä¿®æ”¹é¡å‹': (isLessonModified ? 'èª²å ‚' : '') + (isLessonModified && isTeacherModified ? ' & ' : '') + (isTeacherModified ? 'æ•™å¸«' : ''),
                        // åŒ…å«æ‰€æœ‰åŸå§‹æ¬„ä½ï¼Œä½†ä¸éœ€è¦åœ¨ CSV å ±å‘Šä¸­é¡¯ç¤º
                        // ...currentRecord 
                    };
                }
                return null;
            }).filter(item => item !== null);
        }

        // --- MODIFIED: Save function to use .csav extension ---
        function handleSaveClick() {
            if (scheduleData.length === 0) {
                adjustmentMessage.textContent = 'âŒ ç„¡æ•¸æ“šå¯å„²å­˜ã€‚è«‹å…ˆç¢ºèªæ’èª²è¡¨å·²æˆåŠŸè¼‰å…¥ã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            // ä¸‹è¼‰æŒ‰éˆ•åªå„²å­˜ä¿®æ”¹å¾Œçš„è¨˜éŒ„ (åªåŒ…å«æ–°å€¼)
            const modifiedRecords = getModifiedRecordsWithOriginal().map(record => {
                // å¾å ±å‘Šæ ¼å¼ä¸­æå–åŸå§‹æ¬„ä½ (åªåŒ…å«æ–°å€¼)
                const originalRecord = scheduleData.find(r => 
                    r['æ—¥å­'] === record['æ—¥å­'] && 
                    r['ç­åˆ¥'] === record['ç­åˆ¥'] && 
                    r['æ™‚é–“'] === record['æ™‚é–“']
                );
                
                // å‰µå»ºä¸€å€‹åªåŒ…å«åŸå§‹æ¬„ä½çµæ§‹å’Œæ–°å€¼çš„å°è±¡
                // å¿…é ˆåŒ…å«æ‰€æœ‰åŸå§‹æ¬„ä½ï¼Œç¢ºä¿è¼‰å…¥æ™‚èƒ½æ­£ç¢ºåŒ¹é…
                const dataToSave = {};
                const baseFields = Object.keys(scheduleData[0] || {});
                baseFields.forEach(field => {
                    dataToSave[field] = originalRecord[field]; // Get the current (modified) value from scheduleData
                });
                
                return dataToSave;
            });


            if (modifiedRecords.length === 0) {
                adjustmentMessage.textContent = 'âš ï¸ æ²’æœ‰åµæ¸¬åˆ°ä»»ä½•æ’èª²æ•¸æ“šè®Šå‹•ï¼Œç„¡éœ€å„²å­˜ã€‚';
                adjustmentMessage.style.color = 'orange';
                return;
            }
            
            try {
                // ç¢ºä¿ CSV æª”æ¡ˆåŒ…å«æ­£ç¢ºçš„æ¬„ä½é †åºï¼Œæˆ‘å€‘ä½¿ç”¨åŸºç·šæ¬„ä½
                const baseFields = Object.keys(scheduleData[0]); 
                const csv = Papa.unparse(modifiedRecords, { columns: baseFields });
                
                const currentDate = new Date().toISOString().slice(0, 10);
                // --- CORE MODIFICATION: Change extension to .csav ---
                const filename = `å·²èª¿æ•´æ’èª²è¡¨_è®Šæ›´éƒ¨åˆ†_${currentDate}.csav`;
                // --- End Modification ---
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement('a');
                if (link.download !== undefined) { 
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden'; 
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    adjustmentMessage.textContent = `âœ… æˆåŠŸä¸‹è¼‰ ${modifiedRecords.length} ç­†å·²è®Šæ›´çš„æ’èª²è¨˜éŒ„ (åªåŒ…å«æ–°å€¼) ç‚ºæª”æ¡ˆï¼š${filename}ã€‚`;
                    adjustmentMessage.style.color = 'green';
                } else {
                    adjustmentMessage.textContent = 'âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸å®Œå…¨æ”¯æ´è‡ªå‹•ä¸‹è¼‰ï¼Œè«‹è¤‡è£½ä»¥ä¸‹æ•¸æ“šã€‚';
                    adjustmentMessage.style.color = 'orange';
                }
            } catch (error) {
                adjustmentMessage.textContent = `âŒ å„²å­˜å¤±æ•—: ${error.message}`;
                adjustmentMessage.style.color = 'red';
                console.error("Save Error:", error);
            }
        }
        // --- END MODIFIED: Save function ---


        // MODIFIED: CSV Report Generation Function
        function handleGenerateReportCSVClick() {
            if (scheduleData.length === 0) {
                adjustmentMessage.textContent = 'âŒ ç„¡æ•¸æ“šå¯ç”Ÿæˆå ±å‘Šã€‚è«‹å…ˆç¢ºèªæ’èª²è¡¨å·²æˆåŠŸè¼‰å…¥ã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            // ç²å–åŒ…å«åŸå§‹å’Œæ–°å€¼çš„ä¿®æ”¹è¨˜éŒ„
            const modifiedRecordsWithOriginal = getModifiedRecordsWithOriginal();

            if (modifiedRecordsWithOriginal.length === 0) {
                adjustmentMessage.textContent = 'âš ï¸ æ²’æœ‰åµæ¸¬åˆ°ä»»ä½•æ’èª²æ•¸æ“šè®Šå‹•ï¼Œç„¡éœ€ç”Ÿæˆ CSV å ±å‘Šã€‚';
                adjustmentMessage.style.color = 'orange';
                return;
            }
            
            try {
                // PapaParse è‡ªå‹•è™•ç†æ¨™é ­å’Œ CSV æ ¼å¼
                const csv = Papa.unparse(modifiedRecordsWithOriginal, {
                    // ç¢ºä¿æ¬„ä½é †åºç¬¦åˆé æœŸ
                    columns: ['æ—¥å­', 'ç­åˆ¥', 'ç¯€æ•¸', 'æ™‚é–“', 'èª²å ‚_åŸ', 'èª²å ‚_æ–°', 'æ•™å¸«_åŸ', 'æ•™å¸«_æ–°', 'ä¿®æ”¹é¡å‹'],
                    // å…è¨±ä½¿ç”¨ä¸­æ–‡æ¨™é ­
                    header: true
                });
                
                const currentDate = new Date().toISOString().slice(0, 10);
                const filename = `æ’èª²èª¿å‹•å ±å‘Š_å®Œæ•´è®Šæ›´æ¸…å–®_${currentDate}.csv`; // Report remains .csv
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement('a');
                if (link.download !== undefined) { 
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden'; 
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    adjustmentMessage.textContent = `âœ… æˆåŠŸä¸‹è¼‰ ${modifiedRecordsWithOriginal.length} ç­†å·²è®Šæ›´çš„æ’èª²å ±å‘Š (å«æ–°èˆŠå€¼) ç‚ºæª”æ¡ˆï¼š${filename}ã€‚`;
                    adjustmentMessage.style.color = 'green';
                } else {
                    adjustmentMessage.textContent = 'âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸å®Œå…¨æ”¯æ´è‡ªå‹•ä¸‹è¼‰ï¼Œè«‹è¤‡è£½ä»¥ä¸‹æ•¸æ“šã€‚';
                    adjustmentMessage.style.color = 'orange';
                }
            } catch (error) {
                adjustmentMessage.textContent = `âŒ å„²å­˜å ±å‘Šå¤±æ•—: ${error.message}`;
                adjustmentMessage.style.color = 'red';
                console.error("Save Report Error:", error);
            }
        }


        
        function handleLoadClick() {
            const file = loadFileInput.files[0];
            
            if (!file) {
                adjustmentMessage.textContent = 'âŒ è«‹å…ˆé¸æ“‡ä¸€å€‹ CSV æˆ– CSAV æª”æ¡ˆã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            // --- NEW: File extension check and message adjustment ---
            const fileName = file.name;
            let fileTypeMessage = '';
            if (fileName.toLowerCase().endsWith('.csav')) {
                 fileTypeMessage = ' (è¦–ç‚º CSV è¼‰å…¥)';
            }
            // --- End Modification ---

            adjustmentMessage.textContent = `â³ æ­£åœ¨è¼‰å…¥æª”æ¡ˆ "${fileName}"${fileTypeMessage} ä¸¦æ›´æ–°æ’èª²è¨˜éŒ„...`;
            adjustmentMessage.style.color = '#2980b9';
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    if (results.data.length === 0) {
                        adjustmentMessage.textContent = `âš ï¸ è¼‰å…¥æˆåŠŸï¼Œä½†æª”æ¡ˆ "${fileName}" ä¸­æ²’æœ‰æœ‰æ•ˆæ•¸æ“šã€‚`;
                        adjustmentMessage.style.color = 'orange';
                        return;
                    }
                    if (!results.data[0]['æ—¥å­'] || !results.data[0]['ç­åˆ¥'] || !results.data[0]['æ™‚é–“']) {
                        adjustmentMessage.textContent = `âŒ è¼‰å…¥å¤±æ•—: æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œç¼ºå°‘ 'æ—¥å­'/'ç­åˆ¥'/'æ™‚é–“' æ¬„ä½ã€‚`;
                        adjustmentMessage.style.color = 'red';
                        return;
                    }
                    
                    // --- STEP 1: Identify unique days in the loaded data ---
                    const loadedData = results.data;
                    const uniqueDays = [...new Set(loadedData.map(record => String(record['æ—¥å­'] || '').trim()).filter(Boolean))];
                    let autoDaySwitchMessage = '';

                    // --- STEP 2: Handle case where scheduleData is empty (Initial load, shouldn't happen via this button but for robustness) ---
                    if (scheduleData.length === 0) {
                        scheduleData = loadedData;
                        initializeOriginalDataMap(scheduleData);
                        
                        if (uniqueDays.length === 1) {
                            const singleDay = uniqueDays[0];
                            daySelect.value = singleDay;
                            autoDaySwitchMessage = ` (å·²è‡ªå‹•åˆ‡æ›è‡³ ${singleDay})`;
                        }
                        
                        adjustmentMessage.textContent = `âœ… æˆåŠŸè¼‰å…¥æª”æ¡ˆ "${fileName}" (å…± ${scheduleData.length} ç­†è¨˜éŒ„)ã€‚å·²å–ä»£åŸå§‹æ•¸æ“š${autoDaySwitchMessage}ã€‚`;
                        adjustmentMessage.style.color = 'green';
                        populateControls();
                        return;
                    }

                    // --- STEP 3: Update existing records and Original Data Map ---
                    let updateCount = 0;
                    
                    loadedData.forEach(loadedRecord => {
                        const key = generateRecordKey(loadedRecord);
                        if (!key) return;
                        
                        const existingRecord = scheduleData.find(record => generateRecordKey(record) === key);
                        
                        if (existingRecord) {
                            
                            // æª¢æŸ¥ä¸¦æ›´æ–°èª²å ‚å’Œæ•™å¸«æ¬„ä½
                            // å¦‚æœè¼‰å…¥çš„æª”æ¡ˆæœ‰é€™å…©å€‹æ¬„ä½ï¼Œå‰‡è¦†è“‹
                            const loadedLessonValue = loadedRecord['èª²å ‚'] !== undefined ? loadedRecord['èª²å ‚'] : existingRecord['èª²å ‚'];
                            const loadedTeacherValue = loadedRecord['ä¸Šèª²æ•™å¸«'] !== undefined ? loadedRecord['ä¸Šèª²æ•™å¸«'] : existingRecord['ä¸Šèª²æ•™å¸«'];
                            
                            if (existingRecord['èª²å ‚'] !== loadedLessonValue || existingRecord['ä¸Šèª²æ•™å¸«'] !== loadedTeacherValue) {
                                 existingRecord['èª²å ‚'] = loadedLessonValue;
                                 existingRecord['ä¸Šèª²æ•™å¸«'] = loadedTeacherValue;
                                 updateCount++;
                            }
                            
                            // ä¿®æ­£: ç§»é™¤å° originalScheduleDataMap çš„æ›´æ–°ã€‚
                            // originalScheduleDataMap å¿…é ˆä¿æŒç‚ºæœ€åˆå§‹è¼‰å…¥çš„æ•¸æ“šï¼Œä¸æ‡‰è¢«è¼‰å…¥çš„èª¿æ•´æª”æ¡ˆè¦†è“‹ã€‚
                        } 
                    });

                    // --- STEP 4: Auto Day Switch ---
                    if (uniqueDays.length === 1) {
                        const singleDay = uniqueDays[0];
                        if (daySelect.value !== singleDay) {
                            daySelect.value = singleDay;
                            autoDaySwitchMessage = ` (å·²è‡ªå‹•åˆ‡æ›è‡³ ${singleDay})`;
                        }
                    }

                    // --- STEP 5: Final Message and Display Update ---
                    if (updateCount > 0) {
                        adjustmentMessage.textContent = `âœ… æˆåŠŸè¼‰å…¥æª”æ¡ˆ "${fileName}"ï¼Œä¸¦æ›´æ–°äº† ${updateCount} ç­†æ’èª²è¨˜éŒ„${autoDaySwitchMessage}ã€‚`;
                        adjustmentMessage.style.color = 'green';
                        updateDisplays();
                    } else {
                        if (uniqueDays.length === 1 && autoDaySwitchMessage) {
                             // Only switch day if it was necessary and no updates happened
                             adjustmentMessage.textContent = `âš ï¸ æª”æ¡ˆ "${fileName}" è¼‰å…¥å®Œæˆï¼Œæ²’æœ‰æ‰¾åˆ°éœ€è¦æ›´æ–°çš„æ’èª²è¨˜éŒ„${autoDaySwitchMessage}ã€‚`;
                             adjustmentMessage.style.color = 'orange';
                             updateDisplays(); // Refresh to the new day
                        } else {
                            adjustmentMessage.textContent = `âš ï¸ æª”æ¡ˆ "${fileName}" è¼‰å…¥å®Œæˆï¼Œä½†æ²’æœ‰æ‰¾åˆ°éœ€è¦æ›´æ–°çš„æ’èª²è¨˜éŒ„ã€‚`;
                            adjustmentMessage.style.color = 'orange';
                        }
                    }
                },
                error: function(err) {
                    adjustmentMessage.textContent = `âŒ è¼‰å…¥å¤±æ•—: è®€å–æª”æ¡ˆç™¼ç”ŸéŒ¯èª¤ã€‚`;
                    adjustmentMessage.style.color = 'red';
                    console.error("Load Error:", err);
                }
            });
        }


        // 3.1 èª²å ‚å…§å®¹å°èª¿ (Swap) (ç•¥)
        function handleClassSwapClick() {
            const selectedDay = daySelect.value;
            const class1 = swapClass1Select.value;
            const lessons1String = swapLessons1Input.value.trim();
            const class2 = swapClass2Select.value;
            const lessons2String = swapLessons2Input.value.trim();

            if (!selectedDay || !class1 || !class2 || !lessons1String || !lessons2String) {
                adjustmentMessage.textContent = 'âŒ è«‹é¸æ“‡æ—¥å­ã€å…©çµ„ç­åˆ¥ï¼Œä¸¦è¼¸å…¥å…©çµ„ç¯€æ•¸é€²è¡Œå°èª¿ã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            const timeSlots1 = getTimeSlotsByLessonNumbers(selectedDay, lessons1String);
            const timeSlots2 = getTimeSlotsByLessonNumbers(selectedDay, lessons2String);
            
            if (timeSlots1.length === 0 || timeSlots2.length === 0) {
                adjustmentMessage.textContent = `âŒ ç„¡æ•ˆçš„ç¯€æ•¸è¼¸å…¥ã€‚è«‹æª¢æŸ¥è¼¸å…¥çš„ç¯€æ•¸æ˜¯å¦å­˜åœ¨æ–¼ ${selectedDay} çš„æ™‚é–“è¡¨ä¸­ã€‚`;
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            if (timeSlots1.length !== timeSlots2.length) {
                adjustmentMessage.textContent = `âŒ å…©çµ„ç¯€æ•¸çš„æ•¸é‡ä¸ä¸€è‡´ (A: ${timeSlots1.length} ç¯€, B: ${timeSlots2.length} ç¯€)ã€‚å¿…é ˆæ•¸é‡ç›¸ç­‰æ‰èƒ½å°èª¿ã€‚`;
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            const currentRecords1 = new Map(); 
            const currentRecords2 = new Map(); 

            scheduleData.forEach(record => {
                if (record['æ—¥å­'] === selectedDay) {
                    if (record['ç­åˆ¥'] === class1 && timeSlots1.includes(record['æ™‚é–“'])) {
                        currentRecords1.set(record['æ™‚é–“'], { ...record }); 
                    } else if (record['ç­åˆ¥'] === class2 && timeSlots2.includes(record['æ™‚é–“'])) {
                        currentRecords2.set(record['æ™‚é–“'], { ...record }); 
                    }
                }
            });

            if (currentRecords1.size !== timeSlots1.length || currentRecords2.size !== timeSlots2.length) {
                adjustmentMessage.textContent = `âš ï¸ åœ¨ ${class1} å’Œ ${class2} ç­ï¼Œæ²’æœ‰æ‰¾åˆ°å®Œæ•´çš„ ${timeSlots1.length} ç¯€è¨˜éŒ„é€²è¡Œå°èª¿ã€‚è«‹ç¢ºèªç­åˆ¥ã€æ—¥å­å’Œç¯€æ•¸è¼¸å…¥æ­£ç¢ºï¼Œä¸”æ‰€æœ‰ç¯€æ•¸åœ¨æ’èª²è¡¨æ•¸æ“šä¸­éƒ½æœ‰å°æ‡‰çš„è¡Œè¨˜éŒ„ã€‚`;
                adjustmentMessage.style.color = 'orange';
                return;
            }
            
            let swapCount = 0;
            
            scheduleData.forEach(record => {
                if (record['æ—¥å­'] === selectedDay) {
                    const currentTime = record['æ™‚é–“'];
                    
                    if (record['ç­åˆ¥'] === class1 && timeSlots1.includes(currentTime)) {
                        const index = timeSlots1.indexOf(currentTime);
                        const targetTime = timeSlots2[index]; 
                        const recordToSwap = currentRecords2.get(targetTime);
                        
                        if (recordToSwap) {
                            record['èª²å ‚'] = recordToSwap['èª²å ‚'];
                            record['ä¸Šèª²æ•™å¸«'] = recordToSwap['ä¸Šèª²æ•™å¸«'];
                            swapCount++;
                        }
                    } 
                    else if (record['ç­åˆ¥'] === class2 && timeSlots2.includes(currentTime)) {
                        const index = timeSlots2.indexOf(currentTime);
                        const targetTime = timeSlots1[index]; 
                        const recordToSwap = currentRecords1.get(targetTime);

                         if (recordToSwap) {
                            record['èª²å ‚'] = recordToSwap['èª²å ‚'];
                            record['ä¸Šèª²æ•™å¸«'] = recordToSwap['ä¸Šèª²æ•™å¸«'];
                            swapCount++;
                        }
                    }
                }
            });
            
            if (swapCount > 0) {
                adjustmentMessage.textContent = `âœ… æˆåŠŸèª¿æ› ${class1} ç­ ${lessons1String} å’Œ ${class2} ç­ ${lessons2String} çš„èª²å ‚å…§å®¹ (å…±ä¿®æ”¹ ${swapCount} ç­†è¨˜éŒ„)ã€‚è«‹æŸ¥çœ‹ä¸Šæ–¹æŸ¥è©¢çµæœã€‚`;
                adjustmentMessage.style.color = 'green';
                updateDisplays();
            } else {
                adjustmentMessage.textContent = `âš ï¸ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„é€²è¡Œå°èª¿ã€‚è«‹ç¢ºèªæ—¥å­ã€ç­åˆ¥å’Œç¯€æ•¸è¼¸å…¥æ­£ç¢ºã€‚`;
                adjustmentMessage.style.color = 'orange';
            }
        }


        // 3.2 æ¸…ç©ºè€å¸«æ’èª² (Clear) - UPDATED
        function handleTeacherClearClick() {
             const selectedDay = daySelect.value;
             const targetClass = classSelectClear.value;
            const lessonsString = document.getElementById('clear-lessons-input').value.trim();
            const teachersString = document.getElementById('clear-teachers-input').value.trim();

            if (!selectedDay || !lessonsString || !teachersString) {
                adjustmentMessage.textContent = 'âŒ è«‹é¸æ“‡æ—¥å­ã€ğŸ¯ ç›®æ¨™ç­åˆ¥ï¼Œä¸¦è¼¸å…¥è¦æ¸…ç©ºçš„ç¯€æ•¸æˆ– "all" å’Œè€å¸«åå–®ã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            let timeSlots;
            // --- NEW LOGIC FOR "ALL" ---
            if (lessonsString.toLowerCase() === 'all') {
                 // æ”¶é›†è©²æ—¥å­æ‰€æœ‰éé‡è¤‡çš„æ™‚é–“æ®µ
                timeSlots = [...new Set(scheduleData
                    .filter(item => item['æ—¥å­'] === selectedDay && item['æ™‚é–“'])
                    .map(item => item['æ™‚é–“']))
                ];
            } else {
                timeSlots = getTimeSlotsByLessonNumbers(selectedDay, lessonsString);
            }
            // --- END NEW LOGIC ---
            
            const teachersToClear = splitTeacherList(teachersString);
            
            if (timeSlots.length === 0) {
                adjustmentMessage.textContent = `âŒ ç„¡æ•ˆçš„ç¯€æ•¸è¼¸å…¥ã€‚è«‹æª¢æŸ¥è¼¸å…¥çš„ç¯€æ•¸æ˜¯å¦å­˜åœ¨æ–¼ ${selectedDay} çš„æ™‚é–“è¡¨ä¸­ã€‚`;
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            if (teachersToClear.length === 0) {
                 adjustmentMessage.textContent = 'âŒ ç„¡æ•ˆçš„è€å¸«åå–®è¼¸å…¥ã€‚';
                 adjustmentMessage.style.color = 'red';
                 return;
            }

            let clearCount = 0;
            
            scheduleData.forEach(record => {
                const isTargetClass = (targetClass === 'ALL' || record['ç­åˆ¥'] === targetClass);

                if (record['æ—¥å­'] === selectedDay && timeSlots.includes(record['æ™‚é–“']) && isTargetClass) {
                    let currentTeachersString = record['ä¸Šèª²æ•™å¸«'] || '';
                    let currentTeachers = splitTeacherList(currentTeachersString);
                    
                    let originalCount = currentTeachers.length;
                    
                    // åªæœ‰åœ¨èª²å ‚æ´»å‹•ä¸å±¬æ–¼ NON_LESSON_ACTIVITIES æ™‚æ‰é€²è¡Œæ¸…ç©º
                    const lesson = String(record['èª²å ‚'] || '').trim();
                    if (NON_LESSON_ACTIVITIES.includes(lesson)) {
                        return; // ä¸æ¸…ç©ºä¼‘æ¯æˆ–æ´»å‹•æ™‚æ®µçš„æ•™å¸«æ¬„ä½ (é€šå¸¸ç‚ºç©º)
                    }

                    const remainingTeachers = currentTeachers.filter(teacher => 
                        !teachersToClear.includes(teacher)
                    );
                    
                    if (remainingTeachers.length !== originalCount) {
                        record['ä¸Šèª²æ•™å¸«'] = remainingTeachers.length > 0 ? remainingTeachers.join(' ') : ''; 
                        
                        clearCount += (originalCount - remainingTeachers.length);
                    }
                }
            });
            
            let classMessage = targetClass === 'ALL' ? 'æ‰€æœ‰ç­åˆ¥' : `${targetClass} ç­`;
            let lessonsMessage = lessonsString.toLowerCase() === 'all' ? 'æ‰€æœ‰èª²å ‚' : `${lessonsString} ç¯€`;

            if (clearCount > 0) {
                adjustmentMessage.textContent = `âœ… æˆåŠŸæ¸…ç©º ${teachersString} åœ¨ ${classMessage} ${selectedDay} ${lessonsMessage} çš„æ’èª² (å…±æ¸…é™¤ ${clearCount} å€‹æ•™å¸«åˆ†é…)ã€‚è«‹æŸ¥çœ‹ä¸Šæ–¹æŸ¥è©¢çµæœï¼Œ**ç¼ºå°‘è€å¸«çš„èª²å ‚å°‡é¡¯ç¤ºç²‰ç´…è‰²**ã€‚`;
                adjustmentMessage.style.color = 'green';
                updateDisplays();
            } else {
                adjustmentMessage.textContent = `âš ï¸ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è€å¸«æ’èª²é€²è¡Œæ¸…ç©ºã€‚è«‹ç¢ºèªæ—¥å­ã€ç›®æ¨™ç­åˆ¥ã€ç¯€æ•¸å’Œè€å¸«åå–®è¼¸å…¥æ­£ç¢ºã€‚`;
                adjustmentMessage.style.color = 'orange';
            }
        }
        
        // 3.3 æ–°å¢è€å¸«æ’èª² (Add) (ç•¥)
        function handleTeacherAddClick() {
             const selectedDay = daySelect.value;
            const selectedClass = classSelectAdj.value; 
            const lessonsString = document.getElementById('add-lessons-input').value.trim();
            const teachersString = document.getElementById('add-teacher-input').value.trim();

            if (!selectedDay || !selectedClass || !lessonsString || !teachersString) {
                adjustmentMessage.textContent = 'âŒ è«‹é¸æ“‡æ—¥å­ã€ğŸ¯ ç›®æ¨™ç­åˆ¥ï¼Œä¸¦è¼¸å…¥è¦åŠ å…¥çš„ç¯€æ•¸å’Œè€å¸«åå–®ã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            const timeSlots = getTimeSlotsByLessonNumbers(selectedDay, lessonsString);
            const teachersToAdd = splitTeacherList(teachersString);
            
            if (timeSlots.length === 0) {
                adjustmentMessage.textContent = `âŒ ç„¡æ•ˆçš„ç¯€æ•¸è¼¸å…¥ã€‚è«‹æª¢æŸ¥è¼¸å…¥çš„ç¯€æ•¸æ˜¯å¦å­˜åœ¨æ–¼ ${selectedDay} çš„æ™‚é–“è¡¨ä¸­ã€‚`;
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            if (teachersToAdd.length === 0) {
                 adjustmentMessage.textContent = 'âŒ ç„¡æ•ˆçš„è€å¸«åå–®è¼¸å…¥ã€‚';
                 adjustmentMessage.style.color = 'red';
                 return;
            }

            let addCount = 0;
            const teachersToAddSet = new Set(teachersToAdd);
            
            scheduleData.forEach(record => {
                if (record['æ—¥å­'] === selectedDay && record['ç­åˆ¥'] === selectedClass && timeSlots.includes(record['æ™‚é–“'])) {
                    
                    // åªæœ‰åœ¨èª²å ‚æ´»å‹•ä¸å±¬æ–¼ NON_LESSON_ACTIVITIES æ™‚æ‰é€²è¡Œæ–°å¢
                    const lesson = String(record['èª²å ‚'] || '').trim();
                    if (NON_LESSON_ACTIVITIES.includes(lesson)) {
                        return; // ä¸åœ¨ä¼‘æ¯æˆ–æ´»å‹•æ™‚æ®µå¢åŠ æ•™å¸«
                    }

                    let currentTeachersString = record['ä¸Šèª²æ•™å¸«'] || '';
                    let currentTeachers = splitTeacherList(currentTeachersString);
                    let currentTeachersSet = new Set(currentTeachers);
                    
                    let teachersAddedToThisRecord = 0;
                    
                    teachersToAddSet.forEach(newTeacher => {
                        if (!currentTeachersSet.has(newTeacher)) {
                            currentTeachers.push(newTeacher);
                            teachersAddedToThisRecord++;
                        }
                    });
                    
                    if (teachersAddedToThisRecord > 0) {
                        record['ä¸Šèª²æ•™å¸«'] = currentTeachers.join(' '); 
                        addCount += teachersAddedToThisRecord;
                    }
                }
            });
            
            if (addCount > 0) {
                adjustmentMessage.textContent = `âœ… æˆåŠŸåœ¨ ${selectedClass} ç­ ${selectedDay} ${lessonsString} ç¯€åŠ å…¥è€å¸« ${teachersString} (å…±æ–°å¢ ${addCount} å€‹æ•™å¸«åˆ†é…)ã€‚è«‹æŸ¥çœ‹ä¸Šæ–¹æŸ¥è©¢çµæœã€‚`;
                adjustmentMessage.style.color = 'green';
                updateDisplays();
            } else {
                adjustmentMessage.textContent = `âš ï¸ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„èª²å ‚æˆ–æ‰€æœ‰è€å¸«å·²å­˜åœ¨ã€‚è«‹ç¢ºèªç­åˆ¥ã€æ—¥å­å’Œç¯€æ•¸è¼¸å…¥æ­£ç¢ºã€‚`;
                adjustmentMessage.style.color = 'orange';
            }
        }


        // ====================================================================
        // åˆå§‹åŒ–å’Œäº‹ä»¶ç›£è½
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // æŸ¥è©¢åŠŸèƒ½ç›£è½
            
            // --- MODIFIED: æ—¥å­åˆ‡æ›æ™‚ä¸å†è‡ªå‹•æ¸…é™¤ ---
            daySelect.addEventListener('change', () => {
                // resetModifiedDataToOriginal(); // <--- REMOVED
                updateDisplays(); 
            });
            // ------------------------------------
            
            // --- NEW: æ‰‹å‹•æ¸…é™¤æŒ‰éˆ•ç›£è½ ---
            resetDataBtn.addEventListener('click', resetModifiedDataToOriginal);
            // ------------------------------------
            
            classSelect.addEventListener('change', handleClassSelectChange); 
            multiClassInput.addEventListener('input', displaySchedule);
            
            teacherNameInput.addEventListener('input', displayTeacherSchedule); 
            lessonNumberInput.addEventListener('input', displayTeacherSchedule); 
            priorityTeacherInput.addEventListener('input', displayTeacherSchedule); 
            dutyTeacherInput.addEventListener('input', displayTeacherSchedule); 
            
            // èª¿å ‚åŠŸèƒ½ç›£è½
            document.getElementById('swap-classes-btn').addEventListener('click', handleClassSwapClick);
            document.getElementById('clear-teachers-btn').addEventListener('click', handleTeacherClearClick);
            document.getElementById('add-teacher-btn').addEventListener('click', handleTeacherAddClick); 
            
            // SAVE/LOAD LISTENERS (åŠŸèƒ½ 4)
            saveDataBtn.addEventListener('click', handleSaveClick);
            loadDataBtn.addEventListener('click', handleLoadClick);
            // MODIFIED: CSV REPORT GENERATION LISTENER
            generateReportBtn.addEventListener('click', handleGenerateReportCSVClick); // Changed from generatePdfBtn
            
            // Click-to-fill functionality for Section 2
            scheduleBody.addEventListener('click', handleScheduleClick);

            loadDataAndPopulateControls();
        });

    </script>

</body>
</html>