<script>
        const CSV_FILE_PATH = "班別時間總表.csv"; 
        let scheduleData = []; 
        let allTeachersCache = null;

        // DOM 元素引用
        const daySelect = document.getElementById('day-select');
        const classSelect = document.getElementById('class-select');
        const scheduleBody = document.getElementById('schedule-body');
        const resultMessage = document.getElementById('result-message');
        
        const teacherNameInput = document.getElementById('teacher-name-input');
        const teacherScheduleBody = document.getElementById('teacher-schedule-body');
        const teacherResultMessage = document.getElementById('teacher-result-message');
        
        // ====================================================================
        // 新增輔助功能：處理多教師分隔符
        // ====================================================================

        /**
         * 將包含多個教師姓名的字串（用 /、／、+ 分隔）分割成陣列
         * @param {string} teacherString - 來自 CSV 的教師姓名欄位字串
         * @returns {Array<string>} - 處理後的教師姓名陣列
         */
        function splitTeacherNames(teacherString) {
            if (!teacherString) return [];
            // 使用正規表達式匹配 / (半形)、／ (全形)、+ 作為分隔符
            return String(teacherString)
                .split(/[\/\／+]+/) 
                .map(name => name.trim()) // 清理兩側空白
                .filter(name => name.length > 0); // 移除空字串
        }


        // ====================================================================
        // 輔助功能：計算教師名單 (已更新)
        // ====================================================================

        /**
         * 提取所有不重複的教師姓名（從 '上課教師' 和 '可代課教師' 欄位）
         */
        function getAllTeachers() {
            if (allTeachersCache) return allTeachersCache;

            const teacherSet = new Set();
            scheduleData.forEach(item => {
                // 1. 使用新的分割函數處理 '上課教師'
                if (item['上課教師']) {
                    const teachingNames = splitTeacherNames(item['上課教師']);
                    teachingNames.forEach(name => teacherSet.add(name));
                }
                // 2. 從 '可代課教師' 欄位獲取
                if (item['可代課教師']) {
                    const subTeachers = String(item['可代課教師']).trim().split(/\s+/).filter(name => name);
                    subTeachers.forEach(name => teacherSet.add(name));
                }
            });

            allTeachersCache = Array.from(teacherSet).filter(name => name !== '---' && name.length > 0);
            return allTeachersCache;
        }

        /**
         * 獲取特定日子和時間正在上課的教師名單 (已更新)
         * @param {string} day - 日子 (例如: '星期一')
         * @param {string} time - 時間 (例如: '08:00-08:15')
         * @returns {Set<string>} - 正在上課的教師姓名集合
         */
        function getOccupiedTeachers(day, time) {
            const occupiedSet = new Set();
            scheduleData.forEach(item => {
                if (item['日子'] === day && item['時間'] === time) {
                    if (item['上課教師']) {
                        // 使用新的分割函數處理 '上課教師'
                        const teachingNames = splitTeacherNames(item['上課教師']);
                        teachingNames.forEach(name => occupiedSet.add(name));
                    }
                }
            });
            return occupiedSet;
        }
        
        // ====================================================================
        // 數據載入 (PapaParse Logic - 保持不變)
        // ====================================================================

        function loadDataAndPopulateControls() {
             resultMessage.textContent = ''; 
             teacherResultMessage.textContent = '';
            
            Papa.parse(CSV_FILE_PATH, {
                download: true,         
                header: true,           
                skipEmptyLines: true,   
                dynamicTyping: true,    
                complete: function(results) {
                    scheduleData = results.data; 

                    if (scheduleData.length === 0 || !scheduleData[0]['日子'] || !scheduleData[0]['班別']) {
                        const errorMsg = "檔案中沒有有效數據，或欄位標題不正確 (應為 '日子', '班別', '時間', '課堂', '上課教師', '可代課教師')。";
                        console.error(errorMsg);
                        resultMessage.textContent = `❌ 數據載入失敗：${errorMsg}`;
                        daySelect.disabled = true;
                        classSelect.disabled = true;
                        teacherNameInput.disabled = true; 
                        return;
                    }
                    
                    populateControls();
                },
                error: function(err) {
                    console.error("PapaParse Error:", err);
                    resultMessage.textContent = `❌ 載入檔案失敗。請確認檔案 "${CSV_FILE_PATH}" 存在，並使用 Live Server 開啟本頁面。`;
                    daySelect.disabled = true;
                    classSelect.disabled = true;
                    teacherNameInput.disabled = true; 
                    scheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: red;">檔案載入失敗，請檢查主控台錯誤訊息。</td></tr>`;
                    teacherScheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: red;">檔案載入失敗，請檢查主控台錯誤訊息。</td></tr>`;
                }
            });
        }

        // ... (populateControls, populateSelect 和 displaySchedule 保持不變) ...
        function populateControls() {
            daySelect.disabled = false;
            classSelect.disabled = false;
            teacherNameInput.disabled = false;
            
            getAllTeachers(); 

            const allDays = [...new Set(scheduleData.map(item => item['日子']).filter(Boolean))];
            const allClasses = [...new Set(scheduleData.map(item => item['班別']).filter(Boolean))];

            populateSelect(daySelect, allDays, '日子');
            populateSelect(classSelect, allClasses, '班別');
            
            if (allDays.length > 0) daySelect.value = allDays[0];
            if (allClasses.length > 0) classSelect.value = allClasses[0];

            displaySchedule();
            displayTeacherSchedule(); 
        }

        function populateSelect(selectElement, options, name) {
            selectElement.innerHTML = ''; 
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = `--- 請選擇 ${name} ---`;
            selectElement.appendChild(defaultOption);

            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        }
        
        function displaySchedule() {
            if (scheduleData.length === 0) return;

            const selectedDay = daySelect.value;
            const selectedClass = classSelect.value;

            scheduleBody.innerHTML = '';
            resultMessage.textContent = '';

            if (!selectedDay || !selectedClass) {
                resultMessage.textContent = '請選擇日子和班別以查看課表。';
                scheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">請選擇日子和班別。</td></tr>`;
                return;
            }

            const filteredSchedule = scheduleData.filter(item => 
                item['日子'] === selectedDay && item['班別'] === selectedClass
            );

            if (filteredSchedule.length === 0) {
                scheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">在 ${selectedDay}，${selectedClass} 班沒有找到課表數據。</td></tr>`;
                resultMessage.textContent = '';
                return;
            }

            filteredSchedule.forEach(lesson => {
                const row = scheduleBody.insertRow();
                
                const getTime = lesson['時間'] || '---';
                const getLesson = lesson['課堂'] || '---';
                const getTeacher = lesson['上課教師'] || '---';
                const getSubTeachers = lesson['可代課教師'] || '---';

                row.insertCell().textContent = getTime;
                row.insertCell().textContent = getLesson;
                row.insertCell().textContent = getTeacher;
                row.insertCell().textContent = getSubTeachers;
            });
            
            resultMessage.textContent = `✅ 成功顯示 ${selectedDay}, ${selectedClass} 班的課表 (共 ${filteredSchedule.length} 節)。`;
        }


        // ====================================================================
        // 2. 教師空閒查詢 (已更新篩選邏輯)
        // ====================================================================
        
        function displayTeacherSchedule() {
            if (scheduleData.length === 0) return;

            const selectedDay = daySelect.value;
            const rawInput = teacherNameInput.value.trim(); 
            
            teacherScheduleBody.innerHTML = '';
            teacherResultMessage.textContent = '';

            if (!selectedDay) {
                 teacherResultMessage.textContent = '請先選擇日子。';
                 teacherScheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">請先選擇日子。</td></tr>`;
                 return;
            }

            const teacherNames = rawInput.split(/[\s,，]+/).filter(name => name.length > 0);

            if (teacherNames.length === 0) {
                teacherResultMessage.textContent = '請輸入教師姓名以查詢其課堂及空閒教師名單。';
                teacherScheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">請輸入教師姓名。</td></tr>`;
                return;
            }
            
            let combinedTeacherLessons = [];
            const allTeachers = getAllTeachers(); 

            // 遍歷所有輸入的教師姓名
            teacherNames.forEach(teacherName => {
                // 篩選出該教師在當天是「上課教師」的所有課堂
                const targetTeacherLessons = scheduleData.filter(item => {
                    if (item['日子'] !== selectedDay) return false;
                    
                    // NEW: 檢查目標教師姓名是否存在於上課教師欄位中
                    const teachingNames = splitTeacherNames(item['上課教師']);
                    return teachingNames.includes(teacherName);
                });
                
                if (targetTeacherLessons.length > 0) {
                    combinedTeacherLessons.push({ isHeader: true, name: teacherName });
                    combinedTeacherLessons.push(...targetTeacherLessons);
                }
            });

            if (combinedTeacherLessons.length === 0) {
                teacherScheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">在 ${selectedDay}，您查詢的教師 ${teacherNames.join('、')} 沒有任教課堂。</td></tr>`;
                return;
            }
            
            let totalLessonsCount = 0;
            combinedTeacherLessons.forEach(lesson => {
                if (lesson.isHeader) {
                    const row = teacherScheduleBody.insertRow();
                    row.className = 'teacher-header-row';
                    row.insertCell().textContent = `教師: ${lesson.name}`;
                    row.insertCell().colSpan = 3;
                    row.cells[0].colSpan = 1; 
                    row.cells[1].textContent = '該教師的排課';
                    return;
                }
                
                const row = teacherScheduleBody.insertRow();
                const lessonTime = lesson['時間'] || '---';
                const teachingNames = splitTeacherNames(lesson['上課教師']); // 獲取所有任教教師
                const teachingTeacher = lesson.name; // 用於排除查詢的教師自己

                totalLessonsCount++;
                
                // 找出該時段正在上課的所有教師 (已使用更新後的 getOccupiedTeachers)
                const occupiedTeachers = getOccupiedTeachers(selectedDay, lessonTime);
                
                // 計算空閒教師：所有教師 - 正在上課的教師
                const freeTeachers = allTeachers.filter(teacher => 
                    !occupiedTeachers.has(teacher) && !teachingNames.includes(teacher)
                );

                // 插入數據
                row.insertCell().textContent = lessonTime;
                row.insertCell().textContent = lesson['班別'] || '---';
                row.insertCell().textContent = lesson['課堂'] || '---';

                const freeTeachersCell = row.insertCell();
                freeTeachersCell.textContent = freeTeachers.length > 0 ? freeTeachers.join(', ') : '無其他教師空閒';
            });
            
            teacherResultMessage.textContent = `✅ 成功顯示 ${selectedDay}，教師 ${teacherNames.join('、')} 的合併課堂安排 (共 ${totalLessonsCount} 節)。`;
        }

        // ====================================================================
        // 初始化和事件監聽
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            daySelect.addEventListener('change', displaySchedule);
            classSelect.addEventListener('change', displaySchedule);
            
            daySelect.addEventListener('change', displayTeacherSchedule);
            teacherNameInput.addEventListener('input', displayTeacherSchedule); 
            
            loadDataAndPopulateControls();
        });

    </script>
