<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šèª²å ‚èˆ‡æ•™å¸«æŸ¥è©¢ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #2c3e50;
            margin-top: 30px;
            border-left: 5px solid #3498db;
            padding-left: 10px;
        }
        h3 {
            color: #d35400; /* æ©™è‰²å€åˆ†èª¿æ•´å­åŠŸèƒ½ */
            margin-top: 20px;
            border-bottom: 1px dashed #e67e22;
            padding-bottom: 5px;
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 8px;
        }
        .select-group {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
        }
        .input-full-width {
            flex: 1 1 100%; /* ä½”æ»¿æ•´è¡Œ */
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        label {
            font-weight: bold;
            margin-right: 5px;
            /* è®“æ¨™ç±¤åœ¨è¼¸å…¥æ¡†å¯¬åº¦æ”¹è®Šæ™‚ä¸æœƒå¤ªå¿«æ›è¡Œ */
            white-space: nowrap; 
        }
        /* çµ±ä¸€æ‰€æœ‰è¼¸å…¥æ¡†çš„æ¨£å¼ï¼Œä½¿å…¶å¯¬åº¦ä¸€è‡´ä¸”å…·å½ˆæ€§ */
        select, input[type="text"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            min-width: 150px;
            flex-grow: 1; /* è®“è¼¸å…¥æ¡†ä½”ç”¨å‰©é¤˜ç©ºé–“ï¼Œç¢ºä¿å¯¬åº¦ä¸€è‡´ */
        }
        /* é‡å°æª”æ¡ˆä¸Šå‚³è¼¸å…¥æ¡†ï¼Œèª¿æ•´æ¨£å¼ */
        input[type="file"] {
            padding: 5px;
            border: none;
        }
        button {
            padding: 10px 15px;
            margin-top: 10px;
            background-color: #e67e22;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #d35400;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        /* é‡å°æ–°çš„å„²å­˜èˆ‡è¼‰å…¥æŒ‰éˆ•è¨­ç½®ä¸åŒé¡è‰² */
        #save-data-btn {
            background-color: #2ecc71; /* ç¶ è‰² */
        }
        #save-data-btn:hover:not(:disabled) {
            background-color: #27ae60;
        }
        #load-data-btn {
            background-color: #3498db; /* è—è‰² */
        }
        #load-data-btn:hover:not(:disabled) {
            background-color: #2980b9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: white;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: top;
            /* é‡å°å…¨ç­åˆ¥è¦–åœ–ï¼Œè®“å–®å…ƒæ ¼å…§å®¹å¯ä»¥æ›è¡Œ */
            word-break: break-word; 
        }
        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            /* ç¢ºä¿ç­åˆ¥æ¨™é¡Œä¸æœƒæ›è¡Œ */
            white-space: nowrap; 
        }
        .teacher-table th {
             background-color: #2ecc71; /* ç¶ è‰²ï¼Œå€åˆ†æŸ¥è©¢ */
        }
        #teacher-schedule-output td:last-child {
            background-color: #e6f7ff; /* çªå‡ºé¡¯ç¤ºç©ºé–’æ•™å¸«åˆ—è¡¨ */
        }
        /* ç¢ºä¿è¡Œå…§æ¨£å¼å¯ä»¥è¦†è“‹é è¨­çš„äº¤æ›¿è¡Œé¡è‰² */
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        /* å¤šæ•™å¸«æŸ¥è©¢æ™‚çš„åˆ†éš”æ¨™é ­ */
        .teacher-header-row {
            background-color: #ffe082 !important; 
            font-weight: bold;
            text-align: center;
        }
        .teacher-header-row td {
            font-size: 1.1em;
        }
        /* ç‚ºç´”ç¯€æ•¸æŸ¥è©¢è¨­è¨ˆä¸€å€‹æ›´ç°¡æ½”çš„æ¨™é ­ */
        .timeslot-header-row {
            background-color: #d8eaff !important; /* æ·ºè—è‰² */
            font-weight: bold;
            text-align: left;
        }
        .timeslot-header-row td {
            font-size: 1.0em;
        }
        /* 2. ç­ç´šèª²è¡¨æŸ¥è©¢ æç¤ºæ–‡å­—é¡è‰²å®šç¾© */
        p > span[style*="background-color: #ffc2c2"] { /* ç¼ºå°‘è€å¸«çš„ç²‰ç´…è‰² */
            background-color: #ffc2c2;
        }
        p > span[style*="background-color: #FFC299"] { /* æ•™å¸«è¡çªçš„ç²‰æ©™è‰² */
            background-color: #FFC299;
            color: #333; 
        }


        #result-message, #teacher-result-message, #adjustment-message {
            margin-top: 15px;
            font-style: italic;
            font-weight: bold;
            color: #2980b9;
        }
        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>

    <h1>ç­ç´šèª²å ‚èˆ‡æ•™å¸«æŸ¥è©¢ç³»çµ±</h1>
    <p style="color: green;">âœ… æ­£åœ¨è‡ªå‹•è¼‰å…¥ **`ç­åˆ¥æ™‚é–“ç¸½è¡¨.csv`**ã€**`S&PSM_L.csv`**ã€**`Teacher List.csv`** å’Œ **`æ™‚é–“è¡¨.csv`** æª”æ¡ˆ...</p>

    <div class="controls">
        <div class="select-group">
            <label for="day-select">å…±åŒé¸æ“‡æ—¥å­:</label>
            <select id="day-select" disabled>
                <option>è¼‰å…¥ä¸­...</option>
            </select>
        </div>
    </div>
    
    <hr>
    <h2>1. æ•™å¸«ç©ºé–’æŸ¥è©¢ (Teacher Free Time Lookup)</h2>
    <p>â„¹ï¸ **P Grade**/<span style="color: red; font-weight: bold;">ç´…è‰²</span>ï¼Œ**S Grade**/<span style="color: blue; font-weight: bold;">è—è‰²</span>ã€‚å„ªå…ˆä»£èª²è€å¸«ä»¥ <span style="color: orange; font-weight: bold;">æ©™è‰²</span> é¡¯ç¤ºä¸¦æ’æœ€å‰ã€‚**æ—©æœƒã€ç­ä¸»ä»»èª²ã€é–±è®€ã€å°æ¯ã€åˆè†³ã€åˆé–“æ´»å‹•å’Œé€±æœƒï¼èª²é–“æ´»å‹•** ä¸ç´å…¥ç©ºå ‚æ•¸è¨ˆç®—ã€‚å¯å–®ç¨è¼¸å…¥**ç¯€æ•¸**æŸ¥è©¢è©²æ™‚æ®µæ‰€æœ‰ç©ºé–’æ•™å¸«ã€‚</p>
    
    <div class="controls">
        <div class="input-full-width">
            <label for="teacher-name-input">è¼¸å…¥éœ€è¦èª²å ‚èª¿å‹•æ•™å¸«å§“å (é¸å¡«):</label>
            <input type="text" id="teacher-name-input" placeholder="ä¾‹å¦‚: å©· é´»" disabled>
        </div>

        <div class="input-full-width">
            <label for="lesson-number-input" style="color: #3498db;">æŸ¥è©¢ç¯€æ•¸ (ä¾‹å¦‚: 3,4,5) (é¸å¡«):</label>
            <input type="text" id="lesson-number-input" placeholder="ä¾‹å¦‚: 3,4,5" disabled>
        </div>
        
        <div class="input-full-width">
            <label for="priority-teacher-input" style="color: orange;">å„ªå…ˆä»£èª²è€å¸«åå–® (æ©™è‰²ï¼Œæ’æœ€å‰):</label>
            <input type="text" id="priority-teacher-input" placeholder="ä¾‹å¦‚: é›… é­" disabled>
        </div>
        
        <div class="input-full-width">
            <label for="duty-teacher-input" style="color: #900;">å·²æœ‰å…¬å‹™è€å¸«åå–® (æ’é™¤åå–®):</label>
            <input type="text" id="duty-teacher-input" placeholder="ä¾‹å¦‚: ç›§ æ¬£" disabled>
        </div>
    </div>
    
    <div id="teacher-schedule-output">
        <table class="teacher-table">
            <thead>
                <tr>
                    <th>ç¯€æ•¸</th>
                    <th>æ™‚é–“</th>
                    <th>ç­åˆ¥</th>
                    <th>èª²å ‚</th>
                    <th>ç©ºé–’æ•™å¸« (å¯ä»£èª²åå–®) - æŒ‰å„ªå…ˆç´šåŠç©ºå ‚æ•¸æ’åº</th>
                </tr>
            </thead>
            <tbody id="teacher-schedule-body">
                <tr><td colspan="5" style="text-align: center;">è«‹è¼¸å…¥æ•™å¸«å§“åæˆ–ç¯€æ•¸ä¸¦é¸æ“‡æ—¥å­</td></tr>
            </tbody>
        </table>
        <p id="teacher-result-message"></p>
    </div>

    
    <hr>
    <h2>2. ç­ç´šèª²è¡¨æŸ¥è©¢ (Class Schedule Lookup)</h2>
    <p>â„¹ï¸ **P Grade** æ•™å¸«ä»¥ <span style="color: red; font-weight: bold;">ç´…è‰²</span> é¡¯ç¤ºï¼Œ**S Grade** æ•™å¸«ä»¥ <span style="color: blue; font-weight: bold;">è—è‰²</span> é¡¯ç¤ºã€‚**æ²’æœ‰æ•™å¸«çš„å¸¸è¦/æŒ‡å®šèª²å ‚** å°‡ä»¥ <span style="background-color: #ffc2c2; font-weight: bold;">ç²‰ç´…è‰²åº•è‰²</span> é¡¯ç¤ºã€‚**å¦‚æœåŒä¸€æ•™å¸«åœ¨åŒä¸€ç¯€æ•¸å‡ºç¾åœ¨å…©ç­ä»¥ä¸Šèª²å ‚**ï¼Œå°‡ä»¥ <span style="background-color: #FFC299; color: #333; font-weight: bold;">ç²‰æ©™è‰²åº•è‰²</span> é¡¯ç¤º (åœ¨ã€Œæ‰€æœ‰ç­åˆ¥ã€æˆ–ã€Œè‡ªè¨‚å¤šç­åˆ¥ã€è¦–åœ–)ã€‚</p>
    
    <div class="controls">
        <div class="select-group">
            <label for="class-select">é¸æ“‡ç­åˆ¥:</label>
            <select id="class-select" disabled>
                <option>è¼‰å…¥ä¸­...</option>
            </select>
        </div>
        <div class="input-full-width" id="multi-class-input-group" style="display: none; margin-top: 10px;">
            <label for="multi-class-input" style="color: #2980b9;">è¼¸å…¥è¦é¡¯ç¤ºçš„ç­åˆ¥ (ä¾‹å¦‚: 1A 1B 2C) :</label>
            <input type="text" id="multi-class-input" placeholder="ä¾‹å¦‚: 1A 1B 2C">
        </div>
    </div>

    <div id="schedule-output">
        <table>
            <thead id="schedule-header">
                <tr>
                    <th>ç¯€æ•¸</th>
                    <th>æ™‚é–“</th>
                    <th>èª²å ‚</th>
                    <th>ä¸Šèª²æ•™å¸«</th>
                </tr>
            </thead>
            <tbody id="schedule-body">
                <tr><td colspan="4" style="text-align: center;">æ•¸æ“šè¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</td></tr>
            </tbody>
        </table>
        <p id="result-message"></p>
    </div>

    <hr>
    <h2>3. èª¿å ‚åŠŸèƒ½ (Class/Teacher Assignment Adjustment)</h2>
    <p style="color: orange;">âš ï¸ **æ³¨æ„:** ä»¥ä¸‹æ“ä½œå°‡ä¿®æ”¹ç•¶å‰ç¶²é çš„æ’èª²è³‡æ–™ã€‚è«‹ä½¿ç”¨ä¸‹æ–¹çš„ã€Œå„²å­˜ã€åŠŸèƒ½ä¾†ä¸‹è¼‰å·²èª¿æ•´çš„æ•¸æ“šã€‚</p>
    
    <div class="controls">
        
        <h3>3.1. èª²å ‚å…§å®¹å°èª¿ (Swap - æ”¯æ´è·¨ç­åˆ¥/è·¨ç´šåˆ¥)</h3>
        <p>æ­¤åŠŸèƒ½å°‡èª¿æ›**å…©çµ„ç¨ç«‹æ’èª²ä½ç½®**çš„èª²å ‚å’Œä¸Šèª²æ•™å¸«æ¬„ä½ã€‚é€™å¯ç”¨æ–¼**è·¨ç­åˆ¥ã€è·¨ç´šåˆ¥**æˆ–åœ¨**åŒä¸€ç­åˆ¥**å…§èª¿å‹•ã€‚</p>
        
        <div class="input-full-width" style="background-color: #f7f3e8; padding: 5px; border-radius: 4px;">
            <label for="swap-class-1-select" style="min-width: 60px;">A ç­åˆ¥:</label>
            <select id="swap-class-1-select" disabled style="flex-grow: 0; margin-right: 10px;"></select>
            <label for="swap-lessons-1-input" style="min-width: 60px;">A ç¯€æ•¸ (ä¾‹å¦‚: 3,4):</label>
            <input type="text" id="swap-lessons-1-input" placeholder="3,4">
        </div>

        <div class="input-full-width" style="background-color: #e8f7f3; padding: 5px; border-radius: 4px;">
            <label for="swap-class-2-select" style="min-width: 60px;">B ç­åˆ¥:</label>
            <select id="swap-class-2-select" disabled style="flex-grow: 0; margin-right: 10px;"></select>
            <label for="swap-lessons-2-input" style="min-width: 60px;">B ç¯€æ•¸ (ä¾‹å¦‚: 7,8):</label>
            <input type="text" id="swap-lessons-2-input" placeholder="7,8">
        </div>

        <button id="swap-classes-btn" disabled>åŸ·è¡Œèª²å ‚å°èª¿ (Swap)</button>

        <hr style="margin: 20px 0;">
        
        <h3>3.2. æ¸…ç©ºè€å¸«æ’èª² (Clear)</h3>
        <p>æ­¤åŠŸèƒ½å°‡å¾**æ‰€æœ‰ç­åˆ¥**ä¸­ï¼Œæ¸…é™¤æŒ‡å®šè€å¸«åœ¨**æ‰€é¸æ—¥å­**å’Œ**æŒ‡å®šç¯€æ•¸**ä¸Šçš„æ’èª²ã€‚</p>
        <div class="input-full-width">
            <label for="clear-lessons-input">æ¸…ç©ºã€Œç¯€æ•¸ã€ (ä¾‹å¦‚: 3,4):</label>
            <input type="text" id="clear-lessons-input" placeholder="3,4">
        </div>
        <div class="input-full-width">
            <label for="clear-teachers-input" style="color: #900;">æ¸…ç©ºæ’èª²è€å¸«åå–® (ä¾‹å¦‚: ç›§ æ¬£):</label>
            <input type="text" id="clear-teachers-input" placeholder="ç›§ æ¬£">
        </div>
        <button id="clear-teachers-btn" disabled>åŸ·è¡Œæ¸…ç©ºæ’èª² (Clear)</button>
        
        <h3>3.3. æ–°å¢è€å¸«æ’èª² (Add)</h3>
        <p>æ­¤åŠŸèƒ½å°‡åœ¨ **ğŸ¯ æ‰€é¸ç­åˆ¥** çš„ **æŒ‡å®šç¯€æ•¸** ä¸Šï¼ŒåŠ å…¥æŒ‡å®šçš„è€å¸«åˆ°æ’èª²åå–®ã€‚å¦‚æœè©²ä½ç½®å·²æœ‰è€å¸«ï¼Œå‰‡æœƒé™„åŠ è€å¸«åå–®ã€‚</p>
        
        <div class="select-group">
            <label for="class-select-adj">ğŸ¯ **é¸æ“‡è¦èª¿æ•´è€å¸«æ’èª²çš„ç­åˆ¥** (åªç”¨æ–¼ä»¥ä¸‹**æ–°å¢è€å¸«**åŠŸèƒ½):</label>
            <select id="class-select-adj" disabled>
                <option>è¼‰å…¥ä¸­...</option>
            </select>
        </div>
        
        <div class="input-full-width">
            <label for="add-lessons-input">åŠ å…¥ã€Œç¯€æ•¸ã€ (ä¾‹å¦‚: 3,4):</label>
            <input type="text" id="add-lessons-input" placeholder="3,4">
        </div>
        <div class="input-full-width">
            <label for="add-teacher-input" style="color: #007bff;">æ–°å¢è€å¸«åå–® (ä¾‹å¦‚: ç›§ æ¬£):</label>
            <input type="text" id="add-teacher-input" placeholder="ç›§ æ¬£">
        </div>
        <button id="add-teacher-btn" disabled>åŸ·è¡Œæ–°å¢æ’èª² (Add)</button>

    </div>
    
    <div class="controls">
        <h3>3.4. å„²å­˜èˆ‡è¼‰å…¥åŠŸèƒ½ (Save & Load)</h3>
        <p>ğŸ’¡ **ä¸‹è¼‰ (Save)** æŒ‰éˆ•åªæœƒå„²å­˜èˆ‡è¼‰å…¥æ™‚çš„æ•¸æ“š**æœ‰å·®ç•°çš„è¨˜éŒ„**ã€‚**è¼‰å…¥ (Load)** æŒ‰éˆ•åªæœƒæ›´æ–°èˆ‡ä¸Šå‚³æª”æ¡ˆ**éµå€¼å»åˆçš„è¨˜éŒ„**ã€‚</p>
        <div class="select-group">
            <button id="save-data-btn" disabled style="background-color: #2ecc71;">ğŸ“¥ ä¸‹è¼‰å·²èª¿æ•´æ’èª²è¡¨ (Save Modified Only)</button>
        </div>
        <div class="input-full-width" style="margin-top: 20px;">
            <label for="load-file-input">ä¸Šå‚³èª¿æ•´éçš„æ’èª²è¡¨ CSV æª”æ¡ˆ (Load):</label>
            <input type="file" id="load-file-input" accept=".csv" disabled>
            <button id="load-data-btn" disabled style="background-color: #3498db; margin-left: 10px;">â¬†ï¸ è¼‰å…¥æ’èª²è¡¨ (Update Existing)</button>
        </div>
    </div>


    <p id="adjustment-message" style="margin-top: 15px; font-weight: bold;"></p>

    <script>
        const CSV_FILE_PATH = "ç­åˆ¥æ™‚é–“ç¸½è¡¨.csv"; 
        const GRADE_FILE_PATH = "S&PSM_L.csv"; 
        const TEACHER_LIST_FILE_PATH = "Teacher List.csv";
        const TIMETABLE_FILE_PATH = "æ™‚é–“è¡¨.csv"; 
        
        // --- æ ¸å¿ƒä¿®æ”¹é» 1: æ›´æ–°æ’é™¤åˆ—è¡¨ ---
        // 1. æ´»å‹•åç¨±åªé¡¯ç¤ºï¼Œä¸é¡¯ç¤ºæ•™å¸« (ç”¨æ–¼ displaySchedule)
        const NON_LESSON_ACTIVITIES = ['å°æ¯', 'åˆè†³', 'åˆé–“æ´»å‹•', 'é€±æœƒï¼èª²é–“æ´»å‹•'];
        
        // 2. æ´»å‹•ä¸ç´å…¥ç©ºå ‚è¨ˆç®— (ç”¨æ–¼ calculateDailyFreeLessons)
        // åŒ…å«æ‰€æœ‰ NON_LESSON_ACTIVITIESï¼Œä»¥åŠéœ€è¦è€å¸«ä½†ä¸èƒ½ä»£èª²çš„è·å‹™/æ´»å‹•
        const NON_COUNTABLE_FOR_FREE_LESSONS = [...NON_LESSON_ACTIVITIES, 'æ—©æœƒ', 'ç­ä¸»ä»»èª²', 'é–±è®€'];
        // --- æ ¸å¿ƒä¿®æ”¹é» 1 çµæŸ ---
        
        let scheduleData = []; 
        let teacherGradesMap = new Map(); 
        let teacherListCache = []; 
        
        // Key: 'æ—¥å­|ç­åˆ¥|æ™‚é–“', Value: {èª²å ‚: string, ä¸Šèª²æ•™å¸«: string}
        let originalScheduleDataMap = new Map(); 

        // çµæ§‹: Map<DayType, Map<Time, LessonNumber>>
        let timetableDayTypeMap = new Map(); 
        
        // DOM å…ƒç´ å¼•ç”¨
        const daySelect = document.getElementById('day-select');
        const classSelect = document.getElementById('class-select');
        const scheduleHeader = document.getElementById('schedule-header'); 
        const scheduleBody = document.getElementById('schedule-body');
        const resultMessage = document.getElementById('result-message');
        
        // NEW CUSTOM MULTI-CLASS ELEMENTS
        const multiClassInputGroup = document.getElementById('multi-class-input-group');
        const multiClassInput = document.getElementById('multi-class-input');
        
        const teacherNameInput = document.getElementById('teacher-name-input');
        const lessonNumberInput = document.getElementById('lesson-number-input'); 
        const teacherScheduleBody = document.getElementById('teacher-schedule-body');
        const teacherResultMessage = document.getElementById('teacher-result-message');
        
        const priorityTeacherInput = document.getElementById('priority-teacher-input');
        const dutyTeacherInput = document.getElementById('duty-teacher-input');

        // ADJUSTMENT CONTROLS
        const classSelectAdj = document.getElementById('class-select-adj'); // For Add only
        const swapClassesBtn = document.getElementById('swap-classes-btn');
        const clearTeachersBtn = document.getElementById('clear-teachers-btn');
        const addTeacherBtn = document.getElementById('add-teacher-btn');
        
        // NEW SWAP CONTROLS
        const swapClass1Select = document.getElementById('swap-class-1-select');
        const swapLessons1Input = document.getElementById('swap-lessons-1-input');
        const swapClass2Select = document.getElementById('swap-class-2-select');
        const swapLessons2Input = document.getElementById('swap-lessons-2-input');
        
        // SAVE/LOAD CONTROLS
        const saveDataBtn = document.getElementById('save-data-btn');
        const loadFileInput = document.getElementById('load-file-input');
        const loadDataBtn = document.getElementById('load-data-btn');
        
        const adjustmentMessage = document.getElementById('adjustment-message');
        
        // ====================================================================
        // æ ¸å¿ƒè¼”åŠ©åŠŸèƒ½
        // ====================================================================

        /**
         * æ ¹æ“šæ—¥å­ã€ç­åˆ¥å’Œæ™‚é–“ç”Ÿæˆå”¯ä¸€çš„éµå€¼ã€‚
         * @param {object} record - ä¸€æ¢æ’èª²è¨˜éŒ„ã€‚
         * @returns {string|null} éµå€¼ï¼Œä¾‹å¦‚ 'æ˜ŸæœŸä¸€|1A|08:35-09:05'ã€‚
         */
        function generateRecordKey(record) {
            if (!record || !record['æ—¥å­'] || !record['ç­åˆ¥'] || !record['æ™‚é–“']) return null;
            // ç¢ºä¿æ‰€æœ‰çµ„æˆéµçš„æ¬„ä½éƒ½æ˜¯å­—ä¸²ä¸¦å»é™¤ç©ºç™½
            return `${String(record['æ—¥å­']).trim()}|${String(record['ç­åˆ¥']).trim()}|${String(record['æ™‚é–“']).trim()}`;
        }
        
        /**
         * åˆå§‹åŒ–æˆ–é‡è¨­åŸå§‹æ•¸æ“šåœ°åœ– (baseline)ã€‚
         * @param {Array<object>} data - è¦è¨­å®šç‚ºåŸºç·šçš„æ’èª²æ•¸æ“šã€‚
         */
        function initializeOriginalDataMap(data) {
            originalScheduleDataMap.clear();
            data.forEach(record => {
                const key = generateRecordKey(record);
                if (key) {
                    // åªè¿½è¹¤å¯è®Šå‹•çš„æ¬„ä½: èª²å ‚ å’Œ ä¸Šèª²æ•™å¸«
                    originalScheduleDataMap.set(key, {
                        'èª²å ‚': String(record['èª²å ‚'] || '').trim(), 
                        'ä¸Šèª²æ•™å¸«': String(record['ä¸Šèª²æ•™å¸«'] || '').trim()
                    });
                }
            });
        }


        /**
         * æ ¹æ“šæ‰€é¸æ—¥å­ï¼Œç²å–å°æ‡‰çš„ Time-Lesson Mapã€‚
         * ç”±æ–¼ CSV ä¸­æœ‰å…©å¥—æ™‚é–“è¡¨ï¼Œæˆ‘å€‘éœ€è¦åˆ¤æ–·è©²ä½¿ç”¨å“ªä¸€å¥—ã€‚
         * å‡è¨­ï¼šæ˜ŸæœŸä¸€è‡³å››æ˜¯ Day1-4ï¼Œæ˜ŸæœŸäº”æ˜¯ Day5ã€‚
         */
        function getCurrentTimetableMap(day) {
            if (!day) return new Map();

            // ç°¡æ˜“åˆ¤æ–·æ—¥å­é¡å‹
            const dayType = (day === 'æ˜ŸæœŸäº”' || day === 'Friday') ? 'Day5' : 'Day1-4';

            return timetableDayTypeMap.get(dayType) || new Map();
        }

        function timeToMinutes(timeString) {
            if (!timeString || typeof timeString !== 'string') return 0;
            const startTime = timeString.split('-')[0].trim(); 
            const parts = startTime.split(':');
            if (parts.length !== 2) return 0;
            
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);
            return hours * 60 + minutes;
        }

        function splitTeacherList(teacherString) {
            if (!teacherString) return []; 
            // å…è¨± ç©ºæ ¼, é€—è™Ÿ, æ–œç·š, åŠ è™Ÿ ä½œç‚ºåˆ†éš”ç¬¦ï¼Œä¸¦éæ¿¾ç©ºå­—ä¸²å’Œ '---'
            return String(teacherString)
                .split(/[\s,ï¼Œ\/\ï¼+]+/) 
                .map(name => name.trim()) 
                .filter(name => name.length > 0 && name !== '---'); 
        }

        function getStyledTeacherName(teacherName) {
            if (!teacherName || teacherName === '---') return teacherName;

            const grade = teacherGradesMap.get(teacherName);
            let colorStyle = '';

            if (grade === 'P') {
                colorStyle = 'color: red; font-weight: bold;';
            } else if (grade === 'S') {
                colorStyle = 'color: blue; font-weight: bold;';
            }

            if (colorStyle) {
                return `<span style="${colorStyle}">${teacherName}</span>`;
            }
            return teacherName;
        }

        function getFreeListStyledTeacherName(teacherName, isPriority) {
            if (!teacherName || teacherName === '---') return teacherName;

            let color = 'inherit'; 
            
            if (isPriority) {
                color = 'orange'; 
            } else {
                const grade = teacherGradesMap.get(teacherName);
                if (grade === 'P') {
                    color = 'red';
                } else if (grade === 'S') {
                    color = 'blue';
                }
            }

            if (color !== 'inherit') {
                return `<span style="color: ${color}; font-weight: bold;">${teacherName}</span>`;
            }
            return teacherName;
        }

        function getAllTeachers() {
            return teacherListCache; 
        }

        function getOccupiedTeachers(day, time) {
            const occupiedSet = new Set();
            scheduleData.forEach(item => {
                if (item['æ—¥å­'] === day && item['æ™‚é–“'] === time) {
                    if (item['ä¸Šèª²æ•™å¸«']) {
                        const teachingNames = splitTeacherList(item['ä¸Šèª²æ•™å¸«']);
                        teachingNames.forEach(name => occupiedSet.add(name));
                    }
                }
            });
            return occupiedSet;
        }

        // --- æ ¸å¿ƒä¿®æ”¹é» 2: æ›´æ”¹ç©ºå ‚è¨ˆç®—é‚è¼¯ ---
        function calculateDailyFreeLessons(day) {
            // ä½¿ç”¨æ–°çš„ã€æ›´å…¨é¢çš„æ’é™¤åˆ—è¡¨ï¼ŒåŒ…å«æ—©æœƒã€ç­ä¸»ä»»èª²ã€é–±è®€
            const lessonsToExcludeFromCount = NON_COUNTABLE_FOR_FREE_LESSONS; 
            
            // ç¯©é¸å‡ºæ‰€æœ‰åœ¨è©²æ—¥å­çš„æ™‚é–“æ®µä¸­ï¼Œèª²å ‚åç¨±ã€Œä¸ã€å±¬æ–¼æ’é™¤åˆ—è¡¨çš„å”¯ä¸€æ™‚é–“æ®µã€‚
            const relevantUniqueTimeSlots = [...new Set(scheduleData
                .filter(item => 
                    item['æ—¥å­'] === day && 
                    // æ’é™¤æ‰€æœ‰éèª²å ‚æ´»å‹•å’Œä¸æ‡‰è¢«è¨ˆç‚ºç©ºå ‚çš„è·å‹™/æ´»å‹•
                    !lessonsToExcludeFromCount.includes(String(item['èª²å ‚'] || '').trim()) 
                )
                .map(item => item['æ™‚é–“']))
            ];

            const allTeachers = getAllTeachers(); 
            const freeLessonCountMap = new Map();

            allTeachers.forEach(teacher => {
                freeLessonCountMap.set(teacher, 0);
            });

            relevantUniqueTimeSlots.forEach(timeSlot => {
                const occupiedSet = getOccupiedTeachers(day, timeSlot); 
                
                allTeachers.forEach(teacher => {
                    if (!occupiedSet.has(teacher)) {
                        freeLessonCountMap.set(teacher, freeLessonCountMap.get(teacher) + 1);
                    }
                });
            });

            return freeLessonCountMap;
        }
        // --- æ ¸å¿ƒä¿®æ”¹é» 2 çµæŸ ---


        /**
         * æ ¹æ“šæ‰€é¸æ—¥å­å’Œç¯€æ•¸ï¼Œè½‰æ›ç‚ºå°æ‡‰çš„æ™‚é–“æ®µã€‚
         * @param {string} day - é¸æ“‡çš„æ—¥å­ (ç”¨æ–¼åˆ¤æ–·ä½¿ç”¨å“ªå¥—æ™‚é–“è¡¨)
         * @param {string} lessonNumbersString - è¼¸å…¥çš„ç¯€æ•¸ï¼Œä¾‹å¦‚ "3,4"
         * @returns {string[]} å°æ‡‰çš„æ™‚é–“æ®µï¼Œä¾‹å¦‚ ["09:50-10:20", "10:20-10:50"]
         */
        function getTimeSlotsByLessonNumbers(day, lessonNumbersString) {
            if (!lessonNumbersString) return [];
            
            const lessonNumbers = String(lessonNumbersString)
                .split(/[\s,ï¼Œ]+/)
                .map(num => String(num).trim())
                .filter(num => num.length > 0);
            
            // ç²å–ç•¶å‰æ—¥å­çš„ Time-Lesson Map (Map<Time, LessonNumber>)
            const currentTimetableMap = getCurrentTimetableMap(day); 

            // åè½‰ Map ç‚º Lesson-Time Map (Map<LessonNumber, Time>)
            const lessonToTimeMap = new Map();
            currentTimetableMap.forEach((lesson, time) => {
                // å¦‚æœ lesson æ˜¯ 'æ—©æœƒ' æˆ– 'é–±è®€' ç­‰æ´»å‹•åç¨±ï¼Œä¹Ÿå˜—è©¦å°‡å…¶è¦–ç‚ºä¸€å€‹ã€Œç¯€æ•¸ã€è™•ç†
                const lessonKey = String(lesson).trim();
                if (!lessonToTimeMap.has(lessonKey)) {
                     lessonToTimeMap.set(lessonKey, time);
                }
            });
            
            const timeSlots = [];
            lessonNumbers.forEach(lessonNum => {
                const time = lessonToTimeMap.get(lessonNum);
                if (time) {
                    timeSlots.push(time);
                }
            });
            
            // ç”±æ–¼æˆ‘å€‘æ˜¯å¾ Lesson-Time Map è½‰æ›å›ä¾†çš„ï¼Œéœ€è¦å†æ¬¡æ’åºä»¥ç¢ºä¿æ™‚é–“é †åº
            timeSlots.sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
            
            return timeSlots;
        }

        function updateDisplays() {
            displaySchedule();
            displayTeacherSchedule();
            // åœ¨æ•¸æ“šæ›´æ–°å¾Œï¼Œç¢ºä¿å„²å­˜æŒ‰éˆ•å¯ç”¨
            saveDataBtn.disabled = false; 
        }
        
        // ====================================================================
        // æ•¸æ“šè¼‰å…¥èˆ‡åˆå§‹åŒ–
        // ====================================================================

        function loadDataAndPopulateControls() {
             resultMessage.textContent = 'è¼‰å…¥æ’èª²è¡¨...'; 
             teacherResultMessage.textContent = 'è¼‰å…¥æ’èª²è¡¨...';
            loadTeacherList();
        }
        
        function loadTeacherList() {
            Papa.parse(TEACHER_LIST_FILE_PATH, {
                download: true,
                header: false, 
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    if (results.data.length > 0 && results.data[0].length > 0) {
                        teacherListCache = results.data
                            .map(row => String(row[0] || '').trim()) 
                            .filter(name => name.length > 0 && name !== 'Teacher List'); 

                        teacherResultMessage.textContent = `âœ… æ•™å¸«åå–®æª”æ¡ˆè¼‰å…¥æˆåŠŸ (å…± ${teacherListCache.length} ä½æ•™å¸«)ã€‚è¼‰å…¥æ’èª²è¡¨...`;
                    } else {
                        teacherResultMessage.textContent = `âš ï¸ æ•™å¸«åå–®æª”æ¡ˆè¼‰å…¥æˆåŠŸï¼Œä½†å…§å®¹ç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢ºã€‚è¼‰å…¥æ’èª²è¡¨...`;
                    }
                    loadScheduleData();
                },
                error: function(err) {
                    console.error("PapaParse Teacher List Error:", err);
                    teacherResultMessage.textContent = `âŒ è¼‰å…¥æ•™å¸«åå–®æª”æ¡ˆå¤±æ•—ã€‚è«‹ç¢ºèªæª”æ¡ˆ "${TEACHER_LIST_FILE_PATH}" å­˜åœ¨ã€‚è¼‰å…¥æ’èª²è¡¨...`;
                    loadScheduleData();
                }
            });
        }


        function loadScheduleData() {
            Papa.parse(CSV_FILE_PATH, {
                download: true,         
                header: true,           
                skipEmptyLines: true,   
                dynamicTyping: true,    
                complete: function(results) {
                    scheduleData = results.data; 

                    if (scheduleData.length === 0 || !scheduleData[0]['æ—¥å­'] || !scheduleData[0]['ç­åˆ¥']) {
                        const errorMsg = "æ’èª²è¡¨æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆæ•¸æ“šï¼Œæˆ–æ¬„ä½æ¨™é¡Œä¸æ­£ç¢ºã€‚";
                        console.error(errorMsg);
                        resultMessage.textContent = `âŒ æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼š${errorMsg}`;
                        disableAllControls();
                        return;
                    }
                    
                    // --- æ ¸å¿ƒä¿®æ”¹é»: åˆå§‹åŒ–åŸå§‹æ•¸æ“šåœ°åœ– (è¨­å®šåŸºç·š) ---
                    initializeOriginalDataMap(scheduleData);

                    resultMessage.textContent = 'è¼‰å…¥æ’èª²è¡¨æˆåŠŸã€‚è¼‰å…¥æ•™å¸«ç­‰ç´šæª”æ¡ˆ...'; 
                    
                    if (teacherListCache.length === 0) {
                        teacherListCache = deriveTeachersFromSchedule();
                        teacherResultMessage.textContent += ` (å‚™ç”¨: å¾æ’èª²è¡¨æ¨å°å‡º ${teacherListCache.length} ä½æ•™å¸«åå–®)`;
                    }

                    loadTeacherGrades();
                },
                error: function(err) {
                    console.error("PapaParse Schedule Error:", err);
                    resultMessage.textContent = `âŒ è¼‰å…¥æ’èª²è¡¨æª”æ¡ˆå¤±æ•—ã€‚è«‹ç¢ºèªæª”æ¡ˆ "${CSV_FILE_PATH}" å­˜åœ¨ã€‚`;
                    teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">æ’èª²è¡¨æª”æ¡ˆè¼‰å…¥å¤±æ•—ã€‚</td></tr>`;
                    disableAllControls();
                }
            });
        }
        
        function deriveTeachersFromSchedule() {
            const teacherSet = new Set();
            scheduleData.forEach(item => {
                if (item['ä¸Šèª²æ•™å¸«']) {
                    splitTeacherList(item['ä¸Šèª²æ•™å¸«']).forEach(name => teacherSet.add(name));
                }
                if (item['å¯ä»£èª²æ•™å¸«']) {
                    splitTeacherList(item['å¯ä»£èª²æ•™å¸«']).forEach(name => teacherSet.add(name));
                }
            });
            return Array.from(teacherSet).filter(name => name !== '---' && name.length > 0);
        }


        function loadTeacherGrades() {
            Papa.parse(GRADE_FILE_PATH, {
                download: true,
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(gradeResults) {
                    if (gradeResults.data.length > 0 && gradeResults.data[0]['æ•™å¸«'] && gradeResults.data[0]['Grade']) {
                        gradeResults.data.forEach(item => {
                            if (item['æ•™å¸«'] && item['Grade']) {
                                teacherGradesMap.set(String(item['æ•™å¸«']).trim(), String(item['Grade']).trim());
                            }
                        });
                        teacherResultMessage.textContent += ' âœ… æ•™å¸«ç­‰ç´šæª”æ¡ˆè¼‰å…¥æˆåŠŸã€‚';
                    } else {
                        teacherResultMessage.textContent += ` âš ï¸ æ•™å¸«ç­‰ç´šæª”æ¡ˆè¼‰å…¥æˆåŠŸï¼Œä½†å…§å®¹æ ¼å¼å¯èƒ½ä¸æ­£ç¢ºã€‚`;
                    }
                    
                    loadTimetableData(); 
                },
                error: function(err) {
                    console.error("PapaParse Grade Error:", err);
                    teacherResultMessage.textContent += ` âŒ è¼‰å…¥æ•™å¸«ç­‰ç´šæª”æ¡ˆå¤±æ•—ã€‚è«‹ç¢ºèªæª”æ¡ˆ "${GRADE_FILE_PATH}" å­˜åœ¨ã€‚`;
                    loadTimetableData(); 
                }
            });
        }
        
        // è¼‰å…¥æ™‚é–“è¡¨æ•¸æ“šæ™‚ï¼Œå°‡ä¸åŒæ™‚é–“è¡¨åˆ†çµ„
        function loadTimetableData() {
            Papa.parse(TIMETABLE_FILE_PATH, {
                download: true,
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(timetableResults) {
                    if (timetableResults.data.length > 0 && timetableResults.data[0]['æ™‚é–“'] && timetableResults.data[0]['ç¯€æ•¸']) {
                        
                        // æ ¹æ“š CSV çµæ§‹æ¨æ¸¬çš„åˆ†éš”é»
                        const splitIndex = timetableResults.data.findIndex(item => item['æ™‚é–“'] && item['æ™‚é–“'].includes('08:00') && item['ç¯€æ•¸'] === 'ç­ä¸»ä»»èª²');
                        
                        // ä½¿ç”¨ 0-16 ä½œç‚º Day1-4 (å‡è¨­æª”æ¡ˆçµæ§‹ä¸è®Šï¼Œé€™æ˜¯åŸå§‹ Day1-4 çš„æ•¸æ“šç¯„åœ)
                        const defaultSplitIndex = 17; 

                        const timetable1 = timetableResults.data.slice(0, defaultSplitIndex);
                        const timetable2 = timetableResults.data.slice(defaultSplitIndex).filter(item => item['æ™‚é–“']); 
                        
                        const finalMap1 = new Map();
                        timetable1.forEach(item => finalMap1.set(String(item['æ™‚é–“']).trim(), String(item['ç¯€æ•¸']).trim()));
                        
                        const finalMap2 = new Map();
                        timetable2.forEach(item => finalMap2.set(String(item['æ™‚é–“']).trim(), String(item['ç¯€æ•¸']).trim()));

                        // å„²å­˜åˆ°æ ¸å¿ƒ Map
                        timetableDayTypeMap.set('Day1-4', finalMap1);
                        timetableDayTypeMap.set('Day5', finalMap2);

                        teacherResultMessage.textContent += ` âœ… ç¯€æ•¸æ™‚é–“è¡¨æª”æ¡ˆè¼‰å…¥æˆåŠŸã€‚å·²è¼‰å…¥ Day1-4 (${finalMap1.size} ç­†) å’Œ Day5 (${finalMap2.size} ç­†) å…©çµ„æ™‚é–“è¡¨ã€‚`;
                    } else {
                        teacherResultMessage.textContent += ` âš ï¸ ç¯€æ•¸æ™‚é–“è¡¨æª”æ¡ˆè¼‰å…¥æˆåŠŸï¼Œä½†å…§å®¹æ ¼å¼å¯èƒ½ä¸æ­£ç¢ºã€‚`;
                    }
                    
                    populateControls(); 
                },
                error: function(err) {
                    console.error("PapaParse Timetable Error:", err);
                    teacherResultMessage.textContent += ` âŒ è¼‰å…¥ç¯€æ•¸æ™‚é–“è¡¨æª”æ¡ˆå¤±æ•—ã€‚è«‹ç¢ºèªæª”æ¡ˆ "${TIMETABLE_FILE_PATH}" å­˜åœ¨ã€‚`;
                    populateControls(); 
                }
            });
        }


        function disableAllControls() {
            daySelect.disabled = true;
            classSelect.disabled = true;
            teacherNameInput.disabled = true; 
            lessonNumberInput.disabled = true; 
            priorityTeacherInput.disabled = true; 
            dutyTeacherInput.disabled = true; 
            
            // Adjustment controls
            classSelectAdj.disabled = true;
            swapClassesBtn.disabled = true;
            clearTeachersBtn.disabled = true;
            addTeacherBtn.disabled = true;

            // Swap Specific Controls
            swapClass1Select.disabled = true;
            swapLessons1Input.disabled = true;
            swapClass2Select.disabled = true;
            swapLessons2Input.disabled = true;
            
            // Save/Load
            saveDataBtn.disabled = true; 
            loadFileInput.disabled = true;
            loadDataBtn.disabled = true;
        }

        function populateControls() {
            daySelect.disabled = false;
            classSelect.disabled = false;
            teacherNameInput.disabled = false;
            lessonNumberInput.disabled = false;
            priorityTeacherInput.disabled = false; 
            dutyTeacherInput.disabled = false;
            
            // Adjustment controls
            classSelectAdj.disabled = false;
            swapClassesBtn.disabled = false;
            clearTeachersBtn.disabled = false;
            addTeacherBtn.disabled = false;

            // Swap Specific Controls
            swapClass1Select.disabled = false;
            swapLessons1Input.disabled = false;
            swapClass2Select.disabled = false;
            swapLessons2Input.disabled = false;
            
            // Save/Load
            saveDataBtn.disabled = false; 
            loadFileInput.disabled = false;
            loadDataBtn.disabled = false;
            
            const allDays = [...new Set(scheduleData.map(item => item['æ—¥å­']).filter(Boolean))].sort((a, b) => {
                 // ç¢ºä¿æ˜ŸæœŸä¸€åˆ°äº”çš„é †åº
                const order = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­', 'æ˜ŸæœŸæ—¥'];
                return order.indexOf(a) - order.indexOf(b);
            });
            const allClasses = [...new Set(scheduleData.map(item => item['ç­åˆ¥']).filter(Boolean))].sort();

            populateSelect(daySelect, allDays, 'æ—¥å­');
            
            // --- Class Select (Section 2) ---
            classSelect.innerHTML = ''; 
            
            // 1. ALL option
            const allOption = document.createElement('option');
            allOption.value = 'ALL';
            allOption.textContent = '--- æ‰€æœ‰ç­åˆ¥ (All Classes) ---';
            classSelect.appendChild(allOption);
            
            // 2. NEW Custom Multi-Class option
            const customOption = document.createElement('option');
            customOption.value = 'CUSTOM_MULTI';
            customOption.textContent = '--- è‡ªè¨‚å¤šç­åˆ¥ (Custom Multi-Class) ---';
            classSelect.appendChild(customOption);

            // 3. Individual Class options
            allClasses.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                classSelect.appendChild(opt);
            });

            if (allClasses.length > 0) {
                 classSelect.value = 'ALL'; 
                 // Ensure the multi-class input is hidden initially
                 multiClassInputGroup.style.display = 'none';
            }
            
            // --- Class Select for Adjustment (Section 3) ---
            // classSelectAdj is for Add only
            populateSelect(classSelectAdj, allClasses, 'æ–°å¢è€å¸«ç›®æ¨™ç­åˆ¥'); 
            if (allClasses.length > 0) classSelectAdj.value = allClasses[0];

            // --- Class Select for Swap (Section 3.1) ---
            // swapClass1Select and swapClass2Select are for Swap
            populateSelect(swapClass1Select, allClasses, 'A ç­åˆ¥'); 
            populateSelect(swapClass2Select, allClasses, 'B ç­åˆ¥');
            if (allClasses.length > 0) {
                swapClass1Select.value = allClasses[0];
                swapClass2Select.value = allClasses[0];
            }
            
            if (allDays.length > 0) daySelect.value = allDays[0];

            displayTeacherSchedule(); 
            displaySchedule();
        }

        function populateSelect(selectElement, options, name) {
            selectElement.innerHTML = ''; 
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = `--- è«‹é¸æ“‡ ${name} ---`;
            selectElement.appendChild(defaultOption);

            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        }

        // ====================================================================
        // NEW EVENT HANDLER FOR CLASS SELECT
        // ====================================================================
        function handleClassSelectChange() {
            const selectedClass = classSelect.value;
            if (selectedClass === 'CUSTOM_MULTI') {
                // Display the custom input field
                multiClassInputGroup.style.display = 'flex'; 
            } else {
                // Hide the custom input field
                multiClassInputGroup.style.display = 'none'; 
            }
            displaySchedule(); // Update the display based on selection
        }

        // ====================================================================
        // NEW FUNCTION: åªé¡¯ç¤ºæŒ‡å®šç¯€æ•¸çš„ç©ºé–’æ•™å¸«
        // ====================================================================
        function displayFreeTeachersOnly(selectedDay, timeSlots) {
            const allTeachers = getAllTeachers();
            const dailyFreeLessonsMap = calculateDailyFreeLessons(selectedDay); 
            const priorityTeachers = new Set(splitTeacherList(priorityTeacherInput.value.trim()));
            const dutyTeachers = new Set(splitTeacherList(dutyTeacherInput.value.trim()));
            
            const currentTimetableMap = getCurrentTimetableMap(selectedDay); // ç²å–ç•¶å‰æ—¥å­çš„æ™‚é–“è¡¨
            
            teacherScheduleBody.innerHTML = '';
            
            // æ‰¾å‡ºæ‰€æœ‰å—å½±éŸ¿çš„ç­ç´šåŠå…¶æ’èª²ï¼ŒæŒ‰æ™‚é–“æ’åº
            const relevantLessons = scheduleData.filter(item => 
                item['æ—¥å­'] === selectedDay && timeSlots.includes(item['æ™‚é–“'])
            ).sort((a, b) => timeToMinutes(a['æ™‚é–“']) - timeToMinutes(b['æ™‚é–“']));
            
            // Group by Time Slot to ensure unique Time Slot rows
            const uniqueTimeSlots = [...new Set(relevantLessons.map(item => item['æ™‚é–“']))];
            
            if (uniqueTimeSlots.length === 0) {
                teacherResultMessage.textContent = `åœ¨ ${selectedDay}ï¼ŒæŒ‡å®šç¯€æ•¸æ²’æœ‰æ‰¾åˆ°ä»»ä½•èª²å ‚è¨˜éŒ„ã€‚`;
                teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">ç„¡è³‡æ–™ã€‚</td></tr>`;
                return;
            }

            uniqueTimeSlots.forEach(timeSlot => {
                // å¾æ–°çš„ Map çµæ§‹ä¸­ç²å–ç¯€æ•¸
                const lessonNumber = currentTimetableMap.get(timeSlot) || '---'; 
                
                const row = teacherScheduleBody.insertRow();
                row.className = 'timeslot-header-row'; 
                
                // é¡¯ç¤ºç¯€æ•¸ã€æ™‚é–“
                row.insertCell().textContent = lessonNumber;
                row.insertCell().textContent = timeSlot;
                
                // é¡¯ç¤ºè©²æ™‚æ®µæ‰€æœ‰ä¸Šèª²ç­ç´šå’Œèª²å ‚
                const classesInSlot = relevantLessons.filter(l => l['æ™‚é–“'] === timeSlot)
                    .map(l => {
                        const lesson = l['èª²å ‚'] || '---';
                        const teacher = l['ä¸Šèª²æ•™å¸«'] || '';
                        const styledTeachers = splitTeacherList(teacher || '---')
                            .map(name => getStyledTeacherName(name))
                            .join(' / ');
                        return `**${l['ç­åˆ¥']}**: ${lesson} - ${styledTeachers}`;
                    })
                    .join('<br>');
                    
                const classesCell = row.insertCell();
                classesCell.colSpan = 2; // åˆä½µç­åˆ¥å’Œèª²å ‚æ¬„ä½
                classesCell.innerHTML = classesInSlot || '--- (ç„¡èª²å ‚è¨˜éŒ„) ---';
                
                // -----------------------------------------------------
                // Find occupied teachers for this slot
                const occupiedTeachers = getOccupiedTeachers(selectedDay, timeSlot);
                
                // Filter free teachers
                const freeTeachersNames = allTeachers.filter(teacher => 
                    !occupiedTeachers.has(teacher) && 
                    !dutyTeachers.has(teacher)
                );
                
                const freeTeachersWithCount = freeTeachersNames.map(teacher => ({
                    name: teacher,
                    freeCount: dailyFreeLessonsMap.get(teacher) || 0 
                }));

                freeTeachersWithCount.sort((a, b) => {
                    const aIsPriority = priorityTeachers.has(a.name);
                    const bIsPriority = priorityTeachers.has(b.name);

                    if (aIsPriority && !bIsPriority) return -1;
                    if (!aIsPriority && bIsPriority) return 1;
                    
                    return b.freeCount - a.freeCount;
                });

                const freeTeachersString = freeTeachersWithCount
                    .map(item => {
                        const isPriority = priorityTeachers.has(item.name);
                        const styledName = getFreeListStyledTeacherName(item.name, isPriority);
                        return `${styledName} (${item.freeCount})`;
                    })
                    .join(', ');

                const freeTeachersCell = row.insertCell();
                freeTeachersCell.innerHTML = freeTeachersString || 'ç„¡æ•™å¸«ç©ºé–’';
            });
            
            teacherResultMessage.textContent = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}ï¼ŒæŒ‡å®šç¯€æ•¸ (${timeSlots.map(t => currentTimetableMap.get(t)).join(', ')}) çš„ç©ºé–’æ•™å¸«åå–® (å…± ${uniqueTimeSlots.length} å€‹æ™‚æ®µ)ã€‚`;
        }

        // ====================================================================
        // 1. æ•™å¸«ç©ºé–’æŸ¥è©¢ (Teacher Free Time Lookup) - ä¸»å‡½æ•¸
        // ====================================================================
        
        function displayTeacherSchedule() {
            if (scheduleData.length === 0 || teacherListCache.length === 0) {
                teacherResultMessage.textContent = 'æ•¸æ“šè¼‰å…¥ä¸­ï¼Œæˆ–æ•™å¸«åå–®ç‚ºç©ºã€‚';
                teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">è«‹ç­‰å¾…æ‰€æœ‰æ•¸æ“šè¼‰å…¥ã€‚</td></tr>`; 
                return;
            }

            const selectedDay = daySelect.value;
            const rawInput = teacherNameInput.value.trim(); 
            const teacherNames = splitTeacherList(rawInput);
            
            const lessonNumberString = lessonNumberInput.value.trim(); 
            // å‚³éæ—¥å­çµ¦ getTimeSlotsByLessonNumbers
            const filterTimeSlots = getTimeSlotsByLessonNumbers(selectedDay, lessonNumberString); 
            const isFilteringBySlot = filterTimeSlots.length > 0;
            
            const priorityTeachers = new Set(splitTeacherList(priorityTeacherInput.value.trim()));
            const dutyTeachers = new Set(splitTeacherList(dutyTeacherInput.value.trim()));
            
            const currentTimetableMap = getCurrentTimetableMap(selectedDay); // ç²å–ç•¶å‰æ—¥å­çš„æ™‚é–“è¡¨

            teacherScheduleBody.innerHTML = '';
            teacherResultMessage.textContent = '';

            if (!selectedDay) {
                 teacherResultMessage.textContent = 'è«‹å…ˆé¸æ“‡æ—¥å­ã€‚';
                 teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">è«‹å…ˆé¸æ“‡æ—¥å­ã€‚</td></tr>`; 
                 return;
            }

            // Case 2: Lesson Number ONLY
            if (teacherNames.length === 0 && isFilteringBySlot) {
                displayFreeTeachersOnly(selectedDay, filterTimeSlots);
                return;
            }

            // Case 1 & 3: Requires Teacher Name
            if (teacherNames.length === 0) {
                teacherResultMessage.textContent = 'è«‹è¼¸å…¥æ•™å¸«å§“åæˆ–ç¯€æ•¸ä»¥æŸ¥è©¢ç©ºé–’æ•™å¸«ã€‚';
                teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">è«‹è¼¸å…¥æ•™å¸«å§“åæˆ–ç¯€æ•¸ã€‚</td></tr>`; 
                return;
            }
            
            // Proceed with Teacher-based query (Case 1 or 3)
            let combinedTeacherLessons = [];
            const allTeachers = getAllTeachers(); 
            // ç©ºå ‚è¨ˆç®—å°‡ä½¿ç”¨æ–°çš„æ’é™¤åˆ—è¡¨
            const dailyFreeLessonsMap = calculateDailyFreeLessons(selectedDay); 

            teacherNames.forEach(teacherName => {
                const targetTeacherLessons = scheduleData.filter(item => {
                    if (item['æ—¥å­'] !== selectedDay) return false;
                    
                    // Case 3 Filter: Filter by Slot if specified
                    if (isFilteringBySlot && !filterTimeSlots.includes(item['æ™‚é–“'])) {
                        return false;
                    }
                    
                    const teachingNames = splitTeacherList(item['ä¸Šèª²æ•™å¸«']);
                    return teachingNames.includes(teacherName);
                });
                
                if (targetTeacherLessons.length > 0) {
                    
                    targetTeacherLessons.sort((a, b) => timeToMinutes(a['æ™‚é–“']) - timeToMinutes(b['æ™‚é–“']));
                    
                    const styledHeaderName = getStyledTeacherName(teacherName);
                    combinedTeacherLessons.push({ isHeader: true, name: styledHeaderName });
                    combinedTeacherLessons.push(...targetTeacherLessons);
                }
            });

            if (combinedTeacherLessons.length === 0) {
                teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">åœ¨ ${selectedDay}ï¼Œæ‚¨æŸ¥è©¢çš„æ•™å¸« ${teacherNames.join('ã€')} æ²’æœ‰ä»»æ•™èª²å ‚${isFilteringBySlot ? ` (æ–¼ç¯€æ•¸ ${lessonNumberString})` : ''}ã€‚</td></tr>`; 
                return;
            }
            
            let totalLessonsCount = 0;
            combinedTeacherLessons.forEach(lesson => {
                if (lesson.isHeader) {
                    const row = teacherScheduleBody.insertRow();
                    row.className = 'teacher-header-row';
                    row.insertCell().innerHTML = `æ•™å¸«: ${lesson.name}`; 
                    row.insertCell().colSpan = 4; 
                    row.cells[0].colSpan = 1; 
                    row.cells[1].textContent = 'è©²æ•™å¸«çš„æ’èª²';
                    return;
                }
                
                const row = teacherScheduleBody.insertRow();
                const lessonTime = lesson['æ™‚é–“'] || '---';
                // å¾æ–°çš„ Map çµæ§‹ä¸­ç²å–ç¯€æ•¸
                const lessonNumber = currentTimetableMap.get(lessonTime) || '---'; 

                totalLessonsCount++;
                
                const occupiedTeachers = getOccupiedTeachers(selectedDay, lessonTime);
                
                // æ‰€æœ‰æ•™å¸« - æ­£åœ¨ä¸Šèª²çš„æ•™å¸« - æŸ¥è©¢ç›®æ¨™æ•™å¸« - å…¬å‹™æ•™å¸« = ç©ºé–’æ•™å¸«
                const freeTeachersNames = allTeachers.filter(teacher => 
                    !occupiedTeachers.has(teacher) && 
                    !teacherNames.includes(teacher) && // æ’é™¤ç›®æ¨™æŸ¥è©¢æ•™å¸«
                    !dutyTeachers.has(teacher)
                );

                const freeTeachersWithCount = freeTeachersNames.map(teacher => ({
                    name: teacher,
                    freeCount: dailyFreeLessonsMap.get(teacher) || 0 
                }));

                freeTeachersWithCount.sort((a, b) => {
                    const aIsPriority = priorityTeachers.has(a.name);
                    const bIsPriority = priorityTeachers.has(b.name);

                    if (aIsPriority && !bIsPriority) return -1;
                    if (!aIsPriority && bIsPriority) return 1;
                    
                    return b.freeCount - a.freeCount;
                });

                const freeTeachersString = freeTeachersWithCount
                    .map(item => {
                        const isPriority = priorityTeachers.has(item.name);
                        const styledName = getFreeListStyledTeacherName(item.name, isPriority);
                        return `${styledName} (${item.freeCount})`;
                    })
                    .join(', ');


                row.insertCell().textContent = lessonNumber; 
                row.insertCell().textContent = lessonTime;
                row.insertCell().textContent = lesson['ç­åˆ¥'] || '---';
                row.insertCell().textContent = lesson['èª²å ‚'] || '---';

                const freeTeachersCell = row.insertCell();
                freeTeachersCell.innerHTML = freeTeachersString || 'ç„¡å…¶ä»–æ•™å¸«ç©ºé–’';
            });
            
            let message = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}ï¼Œæ•™å¸« ${teacherNames.join('ã€')} çš„åˆä½µèª²å ‚å®‰æ’ (å…± ${totalLessonsCount} ç¯€)`;
            if(isFilteringBySlot) {
                message += ` (å·²ç¯©é¸ç¯€æ•¸: ${lessonNumberString})`;
            }
            teacherResultMessage.textContent = message + `ã€‚`;
        }

        // ====================================================================
        // 2. ç­ç´šèª²è¡¨æŸ¥è©¢
        // ====================================================================

        function displaySchedule() {
            if (scheduleData.length === 0) return;

            const selectedDay = daySelect.value;
            const selectedClass = classSelect.value;
            
            const currentTimetableMap = getCurrentTimetableMap(selectedDay); // ç²å–ç•¶å‰æ—¥å­çš„æ™‚é–“è¡¨

            scheduleBody.innerHTML = '';
            resultMessage.textContent = '';
            
            // é è¨­å–®ç­åˆ¥è¡¨é ­ (4 æ¬„)
            const singleClassHeader = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th><th>èª²å ‚</th><th>ä¸Šèª²æ•™å¸«</th></tr>';

            if (!selectedDay) {
                resultMessage.textContent = 'è«‹é¸æ“‡æ—¥å­ã€‚';
                scheduleHeader.innerHTML = singleClassHeader;
                scheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">è«‹é¸æ“‡æ—¥å­ã€‚</td></tr>`; 
                return;
            }

            // --- é‚è¼¯: é¡¯ç¤ºæ‰€æœ‰ç­åˆ¥ ---
            if (selectedClass === 'ALL') {
                displayAllClassesSchedule(selectedDay);
                return;
            }
            
            // --- NEW é‚è¼¯: é¡¯ç¤ºè‡ªè¨‚å¤šç­åˆ¥ ---
            if (selectedClass === 'CUSTOM_MULTI') {
                const customClassesString = multiClassInput.value.trim();
                // Reuse splitTeacherList for class names parsing
                const customClasses = splitTeacherList(customClassesString); 
                displayCustomMultiClassesSchedule(selectedDay, customClasses);
                return;
            }
            
            // --- é‚è¼¯: é¡¯ç¤ºå–®ä¸€ç­åˆ¥ ---
            
            if (!selectedClass) {
                resultMessage.textContent = 'è«‹é¸æ“‡ç­åˆ¥ä»¥æŸ¥çœ‹èª²è¡¨ã€‚';
                scheduleHeader.innerHTML = singleClassHeader;
                scheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">è«‹é¸æ“‡ç­åˆ¥ã€‚</td></tr>`; 
                return;
            }
            
            // ç¢ºä¿è¡¨é ­å›åˆ°å–®ç­åˆ¥æ¨¡å¼
            scheduleHeader.innerHTML = singleClassHeader;

            const filteredSchedule = scheduleData.filter(item => 
                item['æ—¥å­'] === selectedDay && item['ç­åˆ¥'] === selectedClass
            ).sort((a, b) => timeToMinutes(a['æ™‚é–“']) - timeToMinutes(b['æ™‚é–“'])); // ç¢ºä¿æ’åº

            if (filteredSchedule.length === 0) {
                resultMessage.textContent = `åœ¨ ${selectedDay}ï¼Œ${selectedClass} ç­æ²’æœ‰æ‰¾åˆ°èª²è¡¨æ•¸æ“šã€‚`;
                scheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">åœ¨ ${selectedDay}ï¼Œ${selectedClass} ç­æ²’æœ‰æ‰¾åˆ°èª²è¡¨æ•¸æ“šã€‚</td></tr>`; 
                return;
            }

            filteredSchedule.forEach(lesson => {
                const row = scheduleBody.insertRow();
                
                const getTime = lesson['æ™‚é–“'] || '---';
                const getLesson = String(lesson['èª²å ‚'] || '---').trim(); // ç¢ºä¿èª²å ‚åç¨±è¢«ä¿®å‰ª
                
                // *** 1. å–å¾—åŸå§‹æ•™å¸«å€¼ï¼Œç”¨æ–¼ç¼ºå¤±æª¢æŸ¥ (å¯èƒ½æ˜¯ '', '---', æˆ– 'å©· æ¬£')
                const rawTeacherValue = lesson['ä¸Šèª²æ•™å¸«'] || ''; 
                
                // å¾æ–°çš„ Map çµæ§‹ä¸­ç²å–ç¯€æ•¸
                const getLessonNumber = currentTimetableMap.get(getTime) || '---'; 
                
                // --- ä¿®æ­£ï¼šç²‰ç´…è‰²è­¦ç¤ºé‚è¼¯ (å–®ä¸€ç­åˆ¥) ---
                let rowStyle = '';
                // æª¢æŸ¥æ˜¯å¦ç‚ºåªé¡¯ç¤ºæ´»å‹•åç¨±çš„é …ç›®
                const isLesson = !NON_LESSON_ACTIVITIES.includes(getLesson);
                
                // æª¢æŸ¥æ•™å¸«æ˜¯å¦ç¼ºå¤±ï¼šåªè¦ splitTeacherList çµæœç‚ºç©ºï¼Œå°±è¦–ç‚ºç¼ºå¤±
                const isTeacherMissing = splitTeacherList(rawTeacherValue).length === 0;

                // åªè¦æ˜¯ã€Œèª²å ‚ã€æˆ–ã€ŒæŒ‡å®šè·å‹™æ´»å‹•ã€(æ—©æœƒ/ç­ä¸»ä»»èª²/é–±è®€)ï¼Œä¸”æ•™å¸«ç¼ºå¤±ï¼Œå°±é¡¯ç¤ºç²‰ç´…è‰²
                if (isLesson && isTeacherMissing) {
                    rowStyle = 'background-color: #ffc2c2;'; // ç²‰ç´…è‰²åº•è‰²
                }
                
                row.style.cssText = rowStyle;
                // ------------------------------------

                // *** 2. æº–å‚™é¡¯ç¤ºç”¨çš„æ•™å¸«åç¨± (å¦‚æœåŸå§‹å€¼æ˜¯ç©ºå­—ä¸²ï¼Œå‰‡é¡¯ç¤º '---')
                const displayTeacherValue = rawTeacherValue || '---';
                const styledTeachers = splitTeacherList(displayTeacherValue)
                    .map(name => getStyledTeacherName(name))
                    .join(', ');

                row.insertCell().textContent = getLessonNumber; 
                row.insertCell().textContent = getTime;
                row.insertCell().textContent = getLesson;
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºåªé¡¯ç¤ºèª²å ‚åç¨±çš„æ´»å‹• (NON_LESSON_ACTIVITIES)
                if (NON_LESSON_ACTIVITIES.includes(getLesson)) {
                    row.insertCell().textContent = '---'; // é€™äº›æ´»å‹•ä¸é¡¯ç¤ºæ•™å¸«åå–®
                } else {
                    // å…¶ä»–æ‰€æœ‰æ´»å‹• (åŒ…æ‹¬ æ—©æœƒ/ç­ä¸»ä»»èª²/é–±è®€ å’Œå¸¸è¦èª²å ‚) å‡é¡¯ç¤ºæ•™å¸«åå–®
                    row.insertCell().innerHTML = styledTeachers || '---'; 
                }
            });
            
            resultMessage.textContent = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}, ${selectedClass} ç­çš„èª²è¡¨ (å…± ${filteredSchedule.length} ç¯€)ã€‚`;
        }
        
        // å‡½æ•¸ï¼šé¡¯ç¤ºè‡ªè¨‚å¤šç­åˆ¥çš„åˆä½µèª²è¡¨
        function displayCustomMultiClassesSchedule(selectedDay, customClasses) {
             if (customClasses.length === 0) {
                resultMessage.textContent = 'è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ¡†è¼¸å…¥è¦é¡¯ç¤ºçš„ç­åˆ¥ (ä¾‹å¦‚: 1A 1B 2C)ã€‚';
                scheduleHeader.innerHTML = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th><th>(è«‹è¼¸å…¥ç­åˆ¥)</th></tr>'; 
                scheduleBody.innerHTML = `<tr><td colspan="3" style="text-align: center;">è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ¡†è¼¸å…¥ç­åˆ¥ã€‚</td></tr>`;
                return;
            }
            
            const allTimeSlots = [...new Set(scheduleData
                .filter(item => item['æ—¥å­'] === selectedDay && item['æ™‚é–“'])
                .map(item => item['æ™‚é–“']))
            ].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
            
            // --- START: NEW CASE-INSENSITIVE CLASS FILTERING LOGIC ---
            // 1. å»ºç«‹ç¾æœ‰ç­åˆ¥çš„æ­£è¦åŒ–å°ç…§è¡¨ (Key: UPPERCASE, Value: Original Case)
            const classMap = new Map();
            [...new Set(scheduleData.map(item => item['ç­åˆ¥']).filter(Boolean))].forEach(className => {
                // ä½¿ç”¨æ•¸æ“šä¸­çš„åŸå§‹ç­åˆ¥åç¨±ä½œç‚º Value
                classMap.set(String(className).trim().toUpperCase(), String(className).trim()); 
            });

            // 2. ç¯©é¸å‡ºç¬¦åˆç”¨æˆ¶è¼¸å…¥ï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰çš„ç­åˆ¥ï¼Œä¸¦ä½¿ç”¨åŸå§‹ç­åˆ¥åç¨±
            const targetClassesSet = new Set();
            customClasses.forEach(inputClass => {
                const normalizedInput = String(inputClass).trim().toUpperCase();
                if (classMap.has(normalizedInput)) {
                    // ä½¿ç”¨æ•¸æ“šä¸­çš„åŸå§‹ç­åˆ¥åç¨± (ä¾‹å¦‚: 1A, è€Œé 1a)
                    targetClassesSet.add(classMap.get(normalizedInput)); 
                }
            });
            
            // 3. æ’åºæœ€çµ‚ç›®æ¨™ç­åˆ¥åˆ—è¡¨
            const targetClasses = Array.from(targetClassesSet).sort();
            // --- END: NEW CASE-INSENSITIVE CLASS FILTERING LOGIC ---

            const currentTimetableMap = getCurrentTimetableMap(selectedDay); // ç²å–ç•¶å‰æ—¥å­çš„æ™‚é–“è¡¨

            if (targetClasses.length === 0) {
                resultMessage.textContent = `âŒ è¼¸å…¥çš„ç­åˆ¥ ${customClasses.join('ã€')} å‡ç„¡æ•¸æ“šæˆ–æ ¼å¼éŒ¯èª¤ã€‚`;
                scheduleHeader.innerHTML = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th><th>(ç„¡ç­åˆ¥æ•¸æ“š)</th></tr>'; 
                scheduleBody.innerHTML = `<tr><td colspan="${customClasses.length + 2}" style="text-align: center;">è¼¸å…¥çš„ç­åˆ¥æ²’æœ‰æ‰¾åˆ°å°æ‡‰æ•¸æ“šã€‚</td></tr>`;
                return;
            }
            
            // 4. å½™æ•´æ•¸æ“š: { time: { class: {èª²å ‚, ä¸Šèª²æ•™å¸«} } }
            const aggregatedData = new Map();
            scheduleData.forEach(item => {
                if (item['æ—¥å­'] === selectedDay && targetClasses.includes(item['ç­åˆ¥'])) { 
                    if (!aggregatedData.has(item['æ™‚é–“'])) {
                        aggregatedData.set(item['æ™‚é–“'], new Map());
                    }
                    aggregatedData.get(item['æ™‚é–“']).set(item['ç­åˆ¥'], {
                        lesson: item['èª²å ‚'] || '---',
                        teacher: item['ä¸Šèª²æ•™å¸«'] || '' 
                    });
                }
            });

            // 5. ç”Ÿæˆè¡¨é ­ - åªåŒ…å« targetClasses
            let headerHtml = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th>';
            targetClasses.forEach(className => {
                headerHtml += `<th>${className}</th>`;
            });
            headerHtml += '</tr>';
            scheduleHeader.innerHTML = headerHtml; 
            
            // 6. ç”Ÿæˆè¡¨æ ¼å…§å®¹
            scheduleBody.innerHTML = '';
            
            allTimeSlots.forEach(timeSlot => {
                
                // --- CONFLICT DETECTION LOGIC (Only for targetClasses) ---
                const teachingTeachers = new Map(); // Map<TeacherName, Set<ClassName>>
                const classDataMap = aggregatedData.get(timeSlot) || new Map();
                
                targetClasses.forEach(className => {
                    const classLesson = classDataMap.get(className);
                    if (classLesson) {
                        const rawTeacher = String(classLesson.teacher).trim();
                        const teachers = splitTeacherList(rawTeacher);
                        
                        // ç¢ºä¿åªæœ‰éä¼‘æ¯æ´»å‹•æ‰æª¢æŸ¥æ•™å¸«è¡çª
                        const lesson = String(classLesson.lesson).trim();
                        if (!NON_LESSON_ACTIVITIES.includes(lesson)) {
                            teachers.forEach(teacher => {
                                if (teacher.length > 0 && teacher !== '---') { 
                                    if (!teachingTeachers.has(teacher)) {
                                        teachingTeachers.set(teacher, new Set());
                                    }
                                    teachingTeachers.get(teacher).add(className);
                                }
                            });
                        }
                    }
                });

                const conflictedTeachers = new Set();
                teachingTeachers.forEach((classesSet, teacher) => {
                    // è¡çªæ¢ä»¶ï¼šä¸€ä½è€å¸«æ’åœ¨ 2 å€‹æˆ–æ›´å¤šç­ç´šä¸­
                    if (classesSet.size >= 2) { 
                        conflictedTeachers.add(teacher);
                    }
                });
                // --- END CONFLICT DETECTION LOGIC ---
                
                const row = scheduleBody.insertRow();
                // å¾æ–°çš„ Map çµæ§‹ä¸­ç²å–ç¯€æ•¸
                const lessonNumber = currentTimetableMap.get(timeSlot) || '---';
                
                // Col 1 & 2: ç¯€æ•¸, æ™‚é–“
                row.insertCell().textContent = lessonNumber;
                row.insertCell().textContent = timeSlot;
                
                
                targetClasses.forEach(className => {
                    const cell = row.insertCell();
                    const classLesson = classDataMap.get(className);
                    
                    if (classLesson) {
                        const lesson = String(classLesson.lesson).trim();
                        // åŸå§‹æ•™å¸«å€¼
                        const rawTeacher = String(classLesson.teacher).trim();
                        const teachers = splitTeacherList(rawTeacher); // Split for checking conflicts/missing
                        
                        let cellStyle = '';
                        
                        // --- å„ªå…ˆæª¢æŸ¥ï¼šç²‰æ©™è‰²è­¦ç¤ºé‚è¼¯ (æ•™å¸«è¡çª) ---
                        const hasConflict = teachers.some(teacher => conflictedTeachers.has(teacher));
                        
                        if (hasConflict) {
                            cellStyle = 'background-color: #FFC299;'; // ç²‰æ©™è‰²åº•è‰² (Light Salmon/Pinkish Orange)
                        } else {
                            // --- å…¶æ¬¡æª¢æŸ¥ï¼šç²‰ç´…è‰²è­¦ç¤ºé‚è¼¯ (æ•™å¸«ç¼ºå¤±) ---
                            // æª¢æŸ¥æ˜¯å¦ç‚ºåªé¡¯ç¤ºæ´»å‹•åç¨±çš„é …ç›®
                            const isLesson = !NON_LESSON_ACTIVITIES.includes(lesson);
                            // æª¢æŸ¥æ•™å¸«æ˜¯å¦ç¼ºå¤±
                            const isTeacherMissing = teachers.length === 0;

                            if (isLesson && isTeacherMissing) {
                                cellStyle = 'background-color: #ffc2c2;'; // ç²‰ç´…è‰²åº•è‰²
                            }
                        }
                        cell.style.cssText = cellStyle;
                        
                        
                        // è™•ç†å–®å…ƒæ ¼é¡¯ç¤ºæ ¼å¼
                        if (NON_LESSON_ACTIVITIES.includes(lesson)) {
                            // é€™äº›æ´»å‹• (å°æ¯/åˆè†³) åªé¡¯ç¤ºæ´»å‹•åç¨±
                            cell.textContent = lesson; 
                        } else if (lesson === '---' && rawTeacher === '') {
                            // å¦‚æœèª²å ‚å’Œæ•™å¸«éƒ½ç¼ºå¤±ï¼Œå‰‡é¡¯ç¤º ---
                            cell.textContent = '---';
                        } else {
                            // æ‰€æœ‰å¸¸è¦èª²å ‚ã€æ—©æœƒã€ç­ä¸»ä»»èª²ã€é–±è®€éƒ½ä»¥ èª²å ‚ - æ•™å¸« æ ¼å¼é¡¯ç¤º
                             // æº–å‚™é¡¯ç¤ºç”¨çš„æ•™å¸«åç¨± (å¦‚æœåŸå§‹å€¼æ˜¯ç©ºå­—ä¸²ï¼Œå‰‡é¡¯ç¤º '---')
                            const displayTeacherValue = rawTeacher || '---';
                            const styledTeachers = splitTeacherList(displayTeacherValue)
                                .map(name => getStyledTeacherName(name))
                                .join(' / '); 
                                
                            cell.innerHTML = `${lesson} - ${styledTeachers}`;
                        }
                    } else {
                        // è©²ç­åˆ¥åœ¨è©²æ™‚é–“æ®µæ²’æœ‰æ•¸æ“š
                        cell.textContent = '---';
                    }
                });
            });

            resultMessage.textContent = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}ï¼Œè‡ªè¨‚ ${targetClasses.length} å€‹ç­åˆ¥çš„åˆä½µèª²è¡¨ (${targetClasses.join('ã€')}) (å…± ${allTimeSlots.length} å€‹æ™‚é–“æ®µ)ã€‚`;
        }

        // å‡½æ•¸ï¼šé¡¯ç¤ºæ‰€æœ‰ç­åˆ¥çš„åˆä½µèª²è¡¨
        function displayAllClassesSchedule(selectedDay) {
            
            const allTimeSlots = [...new Set(scheduleData
                .filter(item => item['æ—¥å­'] === selectedDay && item['æ™‚é–“'])
                .map(item => item['æ™‚é–“']))
            ].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
            
            const allClasses = [...new Set(scheduleData.map(item => item['ç­åˆ¥']).filter(Boolean))].sort();
            
            const currentTimetableMap = getCurrentTimetableMap(selectedDay); 

            if (allTimeSlots.length === 0) {
                resultMessage.textContent = `åœ¨ ${selectedDay}ï¼Œæ²’æœ‰æ‰¾åˆ°ä»»ä½•èª²è¡¨æ•¸æ“šã€‚`;
                scheduleHeader.innerHTML = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th><th>(ç„¡ç­åˆ¥æ•¸æ“š)</th></tr>'; 
                scheduleBody.innerHTML = `<tr><td colspan="${allClasses.length + 2}" style="text-align: center;">æ²’æœ‰æ•¸æ“šã€‚</td></tr>`;
                return;
            }
            
            // 2. å½™æ•´æ•¸æ“š: { time: { class: {èª²å ‚, ä¸Šèª²æ•™å¸«} } }
            const aggregatedData = new Map();
            scheduleData.forEach(item => {
                if (item['æ—¥å­'] === selectedDay && item['ç­åˆ¥']) { 
                    if (!aggregatedData.has(item['æ™‚é–“'])) {
                        aggregatedData.set(item['æ™‚é–“'], new Map());
                    }
                    aggregatedData.get(item['æ™‚é–“']).set(item['ç­åˆ¥'], {
                        lesson: item['èª²å ‚'] || '---',
                        teacher: item['ä¸Šèª²æ•™å¸«'] || '' 
                    });
                }
            });

            // 3. ç”Ÿæˆè¡¨é ­
            let headerHtml = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th>';
            allClasses.forEach(className => {
                headerHtml += `<th>${className}</th>`;
            });
            headerHtml += '</tr>';
            scheduleHeader.innerHTML = headerHtml; 
            
            // 4. ç”Ÿæˆè¡¨æ ¼å…§å®¹
            scheduleBody.innerHTML = '';
            
            allTimeSlots.forEach(timeSlot => {
                
                // --- CONFLICT DETECTION LOGIC ---
                const teachingTeachers = new Map(); // Map<TeacherName, Set<ClassName>>
                const classDataMap = aggregatedData.get(timeSlot) || new Map();
                
                allClasses.forEach(className => {
                    const classLesson = classDataMap.get(className);
                    if (classLesson) {
                        const rawTeacher = String(classLesson.teacher).trim();
                        const teachers = splitTeacherList(rawTeacher);
                        
                        const lesson = String(classLesson.lesson).trim();
                        if (!NON_LESSON_ACTIVITIES.includes(lesson)) {
                            teachers.forEach(teacher => {
                                if (teacher.length > 0 && teacher !== '---') { 
                                    if (!teachingTeachers.has(teacher)) {
                                        teachingTeachers.set(teacher, new Set());
                                    }
                                    teachingTeachers.get(teacher).add(className);
                                }
                            });
                        }
                    }
                });

                const conflictedTeachers = new Set();
                teachingTeachers.forEach((classesSet, teacher) => {
                    if (classesSet.size >= 2) { 
                        conflictedTeachers.add(teacher);
                    }
                });
                // --- END CONFLICT DETECTION LOGIC ---
                
                const row = scheduleBody.insertRow();
                const lessonNumber = currentTimetableMap.get(timeSlot) || '---';
                
                // Col 1 & 2: ç¯€æ•¸, æ™‚é–“
                row.insertCell().textContent = lessonNumber;
                row.insertCell().textContent = timeSlot;
                
                
                allClasses.forEach(className => {
                    const cell = row.insertCell();
                    const classLesson = classDataMap.get(className);
                    
                    if (classLesson) {
                        const lesson = String(classLesson.lesson).trim();
                        const rawTeacher = String(classLesson.teacher).trim();
                        const teachers = splitTeacherList(rawTeacher); 
                        
                        let cellStyle = '';
                        
                        const hasConflict = teachers.some(teacher => conflictedTeachers.has(teacher));
                        
                        if (hasConflict) {
                            cellStyle = 'background-color: #FFC299;'; 
                        } else {
                            // æª¢æŸ¥æ˜¯å¦ç‚ºåªé¡¯ç¤ºæ´»å‹•åç¨±çš„é …ç›®
                            const isLesson = !NON_LESSON_ACTIVITIES.includes(lesson);
                            const isTeacherMissing = teachers.length === 0;

                            if (isLesson && isTeacherMissing) {
                                cellStyle = 'background-color: #ffc2c2;'; 
                            }
                        }
                        cell.style.cssText = cellStyle;
                        
                        
                        if (NON_LESSON_ACTIVITIES.includes(lesson)) {
                            cell.textContent = lesson; 
                        } else if (lesson === '---' && rawTeacher === '') {
                            cell.textContent = '---';
                        } else {
                            // åŒ…æ‹¬ æ—©æœƒ/ç­ä¸»ä»»èª²/é–±è®€ åœ¨å…§çš„æ‰€æœ‰æ´»å‹•å‡ä½¿ç”¨æ­¤æ ¼å¼
                            const displayTeacherValue = rawTeacher || '---';
                            const styledTeachers = splitTeacherList(displayTeacherValue)
                                .map(name => getStyledTeacherName(name))
                                .join(' / '); 
                                
                            cell.innerHTML = `${lesson} - ${styledTeachers}`;
                        }
                    } else {
                        cell.textContent = '---';
                    }
                });
            });

            resultMessage.textContent = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}ï¼Œæ‰€æœ‰ ${allClasses.length} å€‹ç­åˆ¥çš„åˆä½µèª²è¡¨ (å…± ${allTimeSlots.length} å€‹æ™‚é–“æ®µ)ã€‚`;
        }

        // ====================================================================
        // 3.4. å„²å­˜èˆ‡è¼‰å…¥åŠŸèƒ½ (Save & Load) - ä¿®æ­£éƒ¨åˆ†å„²å­˜/æ›´æ–°é‚è¼¯
        // ====================================================================
        
        // å„²å­˜åŠŸèƒ½ï¼šåªå°‡ã€Œæœ‰è®Šæ›´ã€çš„æ•¸æ“šä¸‹è¼‰ç‚º CSV æª”æ¡ˆ
        function handleSaveClick() {
            if (scheduleData.length === 0) {
                adjustmentMessage.textContent = 'âŒ ç„¡æ•¸æ“šå¯å„²å­˜ã€‚è«‹å…ˆç¢ºèªæ’èª²è¡¨å·²æˆåŠŸè¼‰å…¥ã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            // --- æ ¸å¿ƒä¿®æ”¹é»: ç¯©é¸å‡ºå·²ä¿®æ”¹çš„è¨˜éŒ„ ---
            const modifiedRecords = scheduleData.filter(currentRecord => {
                const key = generateRecordKey(currentRecord);
                const originalRecord = originalScheduleDataMap.get(key);
                
                if (!originalRecord) return true; // å¦‚æœæ‰¾ä¸åˆ°åŸå§‹è¨˜éŒ„ï¼Œå®‰å…¨èµ·è¦‹å°‡å…¶è¦–ç‚ºå·²ä¿®æ”¹ (ç†è«–ä¸Šä¸æ‡‰ç™¼ç”Ÿ)

                // æ¯”è¼ƒå¯è®Šå‹•çš„æ¬„ä½: èª²å ‚ å’Œ ä¸Šèª²æ•™å¸« (éœ€ç¢ºä¿å­—ä¸²åŒ–å’Œå»ç©ºç™½ï¼Œä»¥ç¢ºä¿æº–ç¢ºæ¯”å°)
                const currentLesson = String(currentRecord['èª²å ‚'] || '').trim();
                const originalLesson = originalRecord['èª²å ‚']; // å·²ç¶“åœ¨ initializeOriginalDataMap ä¸­è™•ç†é
                
                const currentTeacher = String(currentRecord['ä¸Šèª²æ•™å¸«'] || '').trim();
                const originalTeacher = originalRecord['ä¸Šèª²æ•™å¸«']; // å·²ç¶“åœ¨ initializeOriginalDataMap ä¸­è™•ç†é
                
                const isLessonModified = currentLesson !== originalLesson;
                // æ³¨æ„ï¼šä¸Šèª²æ•™å¸«æ¬„ä½å¯èƒ½åœ¨èª¿æ•´å¾Œè®Šæˆ '' (ç©ºå­—ä¸²) è€Œé '---'ï¼Œé€™èˆ‡è¼‰å…¥æ™‚çš„åŸºç·šä¸åŒ
                const isTeacherModified = currentTeacher !== originalTeacher;
                
                return isLessonModified || isTeacherModified;
            });
            // ------------------------------------------

            if (modifiedRecords.length === 0) {
                adjustmentMessage.textContent = 'âš ï¸ æ²’æœ‰åµæ¸¬åˆ°ä»»ä½•æ’èª²æ•¸æ“šè®Šå‹•ï¼Œç„¡éœ€å„²å­˜ã€‚';
                adjustmentMessage.style.color = 'orange';
                return;
            }
            
            try {
                // Papa.unparse å°‡ç¯©é¸å¾Œçš„ JSON æ•¸æ“šè½‰æ›å› CSV å­—ç¬¦ä¸²
                const csv = Papa.unparse(modifiedRecords);
                
                const currentDate = new Date().toISOString().slice(0, 10);
                const filename = `å·²èª¿æ•´æ’èª²è¡¨_è®Šæ›´éƒ¨åˆ†_${currentDate}.csv`;
                
                // å‰µå»º Blob æ•¸æ“š
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                
                // å‰µå»ºä¸‹è¼‰é€£çµ
                const link = document.createElement('a');
                if (link.download !== undefined) { 
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden'; // éš±è—é€£çµ
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    adjustmentMessage.textContent = `âœ… æˆåŠŸä¸‹è¼‰ ${modifiedRecords.length} ç­†å·²è®Šæ›´çš„æ’èª²è¨˜éŒ„ç‚ºæª”æ¡ˆï¼š${filename}ã€‚`;
                    adjustmentMessage.style.color = 'green';
                } else {
                    adjustmentMessage.textContent = 'âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸å®Œå…¨æ”¯æ´è‡ªå‹•ä¸‹è¼‰ï¼Œè«‹è¤‡è£½ä»¥ä¸‹æ•¸æ“šã€‚';
                    adjustmentMessage.style.color = 'orange';
                }
            } catch (error) {
                adjustmentMessage.textContent = `âŒ å„²å­˜å¤±æ•—: ${error.message}`;
                adjustmentMessage.style.color = 'red';
                console.error("Save Error:", error);
            }
        }
        
        // è¼‰å…¥åŠŸèƒ½ï¼šåªæ›´æ–°èˆ‡ç¾æœ‰æ•¸æ“šéµå€¼å»åˆçš„è¨˜éŒ„
        function handleLoadClick() {
            const file = loadFileInput.files[0];
            
            if (!file) {
                adjustmentMessage.textContent = 'âŒ è«‹å…ˆé¸æ“‡ä¸€å€‹ CSV æª”æ¡ˆã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            adjustmentMessage.textContent = `â³ æ­£åœ¨è¼‰å…¥æª”æ¡ˆ "${file.name}" ä¸¦æ›´æ–°æ’èª²è¨˜éŒ„...`;
            adjustmentMessage.style.color = '#2980b9';
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    if (results.data.length === 0) {
                        adjustmentMessage.textContent = `âš ï¸ è¼‰å…¥æˆåŠŸï¼Œä½†æª”æ¡ˆ "${file.name}" ä¸­æ²’æœ‰æœ‰æ•ˆæ•¸æ“šã€‚`;
                        adjustmentMessage.style.color = 'orange';
                        return;
                    }
                    if (!results.data[0]['æ—¥å­'] || !results.data[0]['ç­åˆ¥'] || !results.data[0]['æ™‚é–“']) {
                        adjustmentMessage.textContent = `âŒ è¼‰å…¥å¤±æ•—: æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œç¼ºå°‘ 'æ—¥å­'/'ç­åˆ¥'/'æ™‚é–“' æ¬„ä½ã€‚`;
                        adjustmentMessage.style.color = 'red';
                        return;
                    }
                    
                    if (scheduleData.length === 0) {
                        // å¦‚æœåŸºç¤æ•¸æ“šç‚ºç©ºï¼Œå‰‡ç›´æ¥ç”¨è¼‰å…¥çš„æ•¸æ“šæ›¿æ›
                        scheduleData = results.data;
                        initializeOriginalDataMap(scheduleData);
                        adjustmentMessage.textContent = `âœ… æˆåŠŸè¼‰å…¥æª”æ¡ˆ "${file.name}" (å…± ${scheduleData.length} ç­†è¨˜éŒ„)ã€‚å·²å–ä»£åŸå§‹æ•¸æ“šã€‚`;
                        adjustmentMessage.style.color = 'green';
                        updateDisplays();
                        return;
                    }

                    const loadedData = results.data;
                    let updateCount = 0;
                    
                    loadedData.forEach(loadedRecord => {
                        const key = generateRecordKey(loadedRecord);
                        if (!key) return;
                        
                        // æ‰¾åˆ°å…¨å±€ scheduleData é™£åˆ—ä¸­å°æ‡‰çš„è¨˜éŒ„ç´¢å¼•
                        const existingRecordIndex = scheduleData.findIndex(record => generateRecordKey(record) === key);
                        
                        if (existingRecordIndex !== -1) {
                            const existingRecord = scheduleData[existingRecordIndex];
                            
                            // è¼‰å…¥çš„èª²å ‚å’Œæ•™å¸«æ•¸æ“š (å¦‚æœ loadedRecord ä¸­æ¬„ä½ä¸å­˜åœ¨ï¼Œå‰‡ä¿æŒ existingRecord çš„å€¼)
                            const loadedLessonValue = loadedRecord['èª²å ‚'] !== undefined ? loadedRecord['èª²å ‚'] : existingRecord['èª²å ‚'];
                            const loadedTeacherValue = loadedRecord['ä¸Šèª²æ•™å¸«'] !== undefined ? loadedRecord['ä¸Šèª²æ•™å¸«'] : existingRecord['ä¸Šèª²æ•™å¸«'];
                            
                            // åƒ…æ›´æ–°å¯è®Šå‹•çš„æ¬„ä½
                            if (existingRecord['èª²å ‚'] !== loadedLessonValue || existingRecord['ä¸Šèª²æ•™å¸«'] !== loadedTeacherValue) {
                                 existingRecord['èª²å ‚'] = loadedLessonValue;
                                 existingRecord['ä¸Šèª²æ•™å¸«'] = loadedTeacherValue;
                                 updateCount++;
                            }
                            
                            // --- æ ¸å¿ƒä¿®æ”¹é»: æ›´æ–°åŸå§‹æ•¸æ“šåœ°åœ– (è¨­å®šæ–°çš„åŸºç·š) ---
                            originalScheduleDataMap.set(key, {
                                'èª²å ‚': String(loadedLessonValue || '').trim(), 
                                'ä¸Šèª²æ•™å¸«': String(loadedTeacherValue || '').trim()
                            });
                        } 
                    });

                    if (updateCount > 0) {
                        adjustmentMessage.textContent = `âœ… æˆåŠŸè¼‰å…¥æª”æ¡ˆ "${file.name}"ï¼Œä¸¦æ›´æ–°äº† ${updateCount} ç­†æ’èª²è¨˜éŒ„ã€‚`;
                        adjustmentMessage.style.color = 'green';
                        updateDisplays();
                    } else {
                        adjustmentMessage.textContent = `âš ï¸ æª”æ¡ˆ "${file.name}" è¼‰å…¥å®Œæˆï¼Œä½†æ²’æœ‰æ‰¾åˆ°éœ€è¦æ›´æ–°çš„æ’èª²è¨˜éŒ„ã€‚`;
                        adjustmentMessage.style.color = 'orange';
                    }
                },
                error: function(err) {
                    adjustmentMessage.textContent = `âŒ è¼‰å…¥å¤±æ•—: è®€å–æª”æ¡ˆç™¼ç”ŸéŒ¯èª¤ã€‚`;
                    adjustmentMessage.style.color = 'red';
                    console.error("Load Error:", err);
                }
            });
        }


        // 3.1 èª²å ‚å…§å®¹å°èª¿ (Swap)
        function handleClassSwapClick() {
            const selectedDay = daySelect.value;
            // Get classes from dedicated swap selectors
            const class1 = swapClass1Select.value;
            const lessons1String = swapLessons1Input.value.trim();
            const class2 = swapClass2Select.value;
            const lessons2String = swapLessons2Input.value.trim();

            if (!selectedDay || !class1 || !class2 || !lessons1String || !lessons2String) {
                adjustmentMessage.textContent = 'âŒ è«‹é¸æ“‡æ—¥å­ã€å…©çµ„ç­åˆ¥ï¼Œä¸¦è¼¸å…¥å…©çµ„ç¯€æ•¸é€²è¡Œå°èª¿ã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            // å‚³éæ—¥å­çµ¦ getTimeSlotsByLessonNumbers
            const timeSlots1 = getTimeSlotsByLessonNumbers(selectedDay, lessons1String);
            const timeSlots2 = getTimeSlotsByLessonNumbers(selectedDay, lessons2String);
            
            if (timeSlots1.length === 0 || timeSlots2.length === 0) {
                adjustmentMessage.textContent = `âŒ ç„¡æ•ˆçš„ç¯€æ•¸è¼¸å…¥ã€‚è«‹æª¢æŸ¥è¼¸å…¥çš„ç¯€æ•¸æ˜¯å¦å­˜åœ¨æ–¼ ${selectedDay} çš„æ™‚é–“è¡¨ä¸­ã€‚`;
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            if (timeSlots1.length !== timeSlots2.length) {
                adjustmentMessage.textContent = `âŒ å…©çµ„ç¯€æ•¸çš„æ•¸é‡ä¸ä¸€è‡´ (A: ${timeSlots1.length} ç¯€, B: ${timeSlots2.length} ç¯€)ã€‚å¿…é ˆæ•¸é‡ç›¸ç­‰æ‰èƒ½å°èª¿ã€‚`;
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            // --- Step 1: æå–åŸå§‹æ•¸æ“š (ç”¨ä½œå°èª¿å…§å®¹ï¼Œå› æ­¤éœ€è¦ç¢ºä¿æ˜¯ç•¶å‰å…§å®¹) ---
            // ç”±æ–¼å¯èƒ½è·¨ç­ï¼Œæˆ‘å€‘éœ€è¦å…©å€‹ç¨ç«‹çš„ Map ä¾†å­˜å„²ç•¶å‰è¨˜éŒ„
            const currentRecords1 = new Map(); // Key: TimeSlot, Value: Record
            const currentRecords2 = new Map(); 

            scheduleData.forEach(record => {
                if (record['æ—¥å­'] === selectedDay) {
                    if (record['ç­åˆ¥'] === class1 && timeSlots1.includes(record['æ™‚é–“'])) {
                        // ä½¿ç”¨å±•é–‹é‹ç®—ç¬¦ç¢ºä¿æˆ‘å€‘è¤‡è£½äº†ä¸€å€‹è¨˜éŒ„
                        currentRecords1.set(record['æ™‚é–“'], { ...record }); 
                    } else if (record['ç­åˆ¥'] === class2 && timeSlots2.includes(record['æ™‚é–“'])) {
                        currentRecords2.set(record['æ™‚é–“'], { ...record }); 
                    }
                }
            });

            if (currentRecords1.size !== timeSlots1.length || currentRecords2.size !== timeSlots2.length) {
                adjustmentMessage.textContent = `âš ï¸ åœ¨ ${class1} å’Œ ${class2} ç­ï¼Œæ²’æœ‰æ‰¾åˆ°å®Œæ•´çš„ ${timeSlots1.length} ç¯€è¨˜éŒ„é€²è¡Œå°èª¿ã€‚è«‹ç¢ºèªç­åˆ¥ã€æ—¥å­å’Œç¯€æ•¸è¼¸å…¥æ­£ç¢ºï¼Œä¸”æ‰€æœ‰ç¯€æ•¸åœ¨æ’èª²è¡¨æ•¸æ“šä¸­éƒ½æœ‰å°æ‡‰çš„è¡Œè¨˜éŒ„ã€‚`;
                adjustmentMessage.style.color = 'orange';
                return;
            }
            
            // --- Step 2: åŸ·è¡Œå°èª¿ ---
            let swapCount = 0;
            
            scheduleData.forEach(record => {
                if (record['æ—¥å­'] === selectedDay) {
                    const currentTime = record['æ™‚é–“'];
                    
                    // æª¢æŸ¥æ˜¯å¦æ˜¯ A ç­çš„ç›®æ¨™ç¯€æ•¸
                    if (record['ç­åˆ¥'] === class1 && timeSlots1.includes(currentTime)) {
                        const index = timeSlots1.indexOf(currentTime);
                        const targetTime = timeSlots2[index]; // å°æ‡‰åˆ° B ç­çš„ç¯€æ•¸æ™‚é–“
                        const recordToSwap = currentRecords2.get(targetTime);
                        
                        if (recordToSwap) {
                            record['èª²å ‚'] = recordToSwap['èª²å ‚'];
                            record['ä¸Šèª²æ•™å¸«'] = recordToSwap['ä¸Šèª²æ•™å¸«'];
                            // ä¸ä¿®æ”¹ç­åˆ¥å’Œæ—¥å­
                            swapCount++;
                        }
                    } 
                    // æª¢æŸ¥æ˜¯å¦æ˜¯ B ç­çš„ç›®æ¨™ç¯€æ•¸
                    else if (record['ç­åˆ¥'] === class2 && timeSlots2.includes(currentTime)) {
                        const index = timeSlots2.indexOf(currentTime);
                        const targetTime = timeSlots1[index]; // å°æ‡‰åˆ° A ç­çš„ç¯€æ•¸æ™‚é–“
                        const recordToSwap = currentRecords1.get(targetTime);

                         if (recordToSwap) {
                            record['èª²å ‚'] = recordToSwap['èª²å ‚'];
                            record['ä¸Šèª²æ•™å¸«'] = recordToSwap['ä¸Šèª²æ•™å¸«'];
                            // ä¸ä¿®æ”¹ç­åˆ¥å’Œæ—¥å­
                            swapCount++;
                        }
                    }
                }
            });
            
            if (swapCount > 0) {
                adjustmentMessage.textContent = `âœ… æˆåŠŸèª¿æ› ${class1} ç­ ${lessons1String} å’Œ ${class2} ç­ ${lessons2String} çš„èª²å ‚å…§å®¹ (å…±ä¿®æ”¹ ${swapCount} ç­†è¨˜éŒ„)ã€‚è«‹æŸ¥çœ‹ä¸Šæ–¹æŸ¥è©¢çµæœã€‚`;
                adjustmentMessage.style.color = 'green';
                updateDisplays();
            } else {
                adjustmentMessage.textContent = `âš ï¸ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„é€²è¡Œå°èª¿ã€‚è«‹ç¢ºèªæ—¥å­ã€ç­åˆ¥å’Œç¯€æ•¸è¼¸å…¥æ­£ç¢ºã€‚`;
                adjustmentMessage.style.color = 'orange';
            }
        }


        // 3.2 æ¸…ç©ºè€å¸«æ’èª² (Clear)
        function handleTeacherClearClick() {
             const selectedDay = daySelect.value;
            const lessonsString = document.getElementById('clear-lessons-input').value.trim();
            const teachersString = document.getElementById('clear-teachers-input').value.trim();
            // æ³¨æ„ï¼šé€™è£¡ä¸å†ä½¿ç”¨ classSelectAdj.valueï¼Œå› ç‚ºé€™æ˜¯è·¨ç­åˆ¥æ¸…ç©ºçš„åŠŸèƒ½ã€‚

            if (!selectedDay || !lessonsString || !teachersString) {
                adjustmentMessage.textContent = 'âŒ è«‹é¸æ“‡æ—¥å­ï¼Œä¸¦è¼¸å…¥è¦æ¸…ç©ºçš„ç¯€æ•¸å’Œè€å¸«åå–®ã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            // å‚³éæ—¥å­çµ¦ getTimeSlotsByLessonNumbers
            const timeSlots = getTimeSlotsByLessonNumbers(selectedDay, lessonsString);
            const teachersToClear = splitTeacherList(teachersString);
            
            if (timeSlots.length === 0) {
                adjustmentMessage.textContent = `âŒ ç„¡æ•ˆçš„ç¯€æ•¸è¼¸å…¥ã€‚è«‹æª¢æŸ¥è¼¸å…¥çš„ç¯€æ•¸æ˜¯å¦å­˜åœ¨æ–¼ ${selectedDay} çš„æ™‚é–“è¡¨ä¸­ã€‚`;
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            if (teachersToClear.length === 0) {
                 adjustmentMessage.textContent = 'âŒ ç„¡æ•ˆçš„è€å¸«åå–®è¼¸å…¥ã€‚';
                 adjustmentMessage.style.color = 'red';
                 return;
            }

            let clearCount = 0;
            
            scheduleData.forEach(record => {
                // æ¸…ç©ºè€å¸«çš„æ’èª²æ˜¯è·¨ç­åˆ¥åŸ·è¡Œçš„ï¼Œåªè¦æ—¥å­å’Œæ™‚é–“å»åˆï¼Œå°±é€²è¡Œæª¢æŸ¥å’Œæ¸…ç†
                if (record['æ—¥å­'] === selectedDay && timeSlots.includes(record['æ™‚é–“'])) {
                    let currentTeachersString = record['ä¸Šèª²æ•™å¸«'] || '';
                    let currentTeachers = splitTeacherList(currentTeachersString);
                    
                    let originalCount = currentTeachers.length;
                    
                    const remainingTeachers = currentTeachers.filter(teacher => 
                        !teachersToClear.includes(teacher)
                    );
                    
                    if (remainingTeachers.length !== originalCount) {
                        // å¦‚æœç§»é™¤å¾Œæ²’æœ‰è€å¸«ï¼Œè¨­ç½®ç‚ºç©ºå­—ä¸² ''ï¼Œé€™å°æª¢æŸ¥ç¼ºå¤±æ˜¯æº–ç¢ºçš„
                        record['ä¸Šèª²æ•™å¸«'] = remainingTeachers.length > 0 ? remainingTeachers.join(' ') : ''; 
                        
                        clearCount += (originalCount - remainingTeachers.length);
                    }
                }
            });
            
            if (clearCount > 0) {
                adjustmentMessage.textContent = `âœ… æˆåŠŸæ¸…ç©º ${teachersString} åœ¨ ${selectedDay} ${lessonsString} ç¯€çš„æ’èª² (å…±æ¸…é™¤ ${clearCount} å€‹æ•™å¸«åˆ†é…)ã€‚è«‹æŸ¥çœ‹ä¸Šæ–¹æŸ¥è©¢çµæœï¼Œ**ç¼ºå°‘è€å¸«çš„èª²å ‚å°‡é¡¯ç¤ºç²‰ç´…è‰²**ã€‚`;
                adjustmentMessage.style.color = 'green';
                updateDisplays();
            } else {
                adjustmentMessage.textContent = `âš ï¸ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è€å¸«æ’èª²é€²è¡Œæ¸…ç©ºã€‚è«‹ç¢ºèªæ—¥å­ã€ç¯€æ•¸å’Œè€å¸«åå–®è¼¸å…¥æ­£ç¢ºã€‚`;
                adjustmentMessage.style.color = 'orange';
            }
        }
        
        // 3.3 æ–°å¢è€å¸«æ’èª² (Add)
        function handleTeacherAddClick() {
             const selectedDay = daySelect.value;
            const selectedClass = classSelectAdj.value; // é€™è£¡å¿…é ˆä½¿ç”¨ classSelectAdj.value
            const lessonsString = document.getElementById('add-lessons-input').value.trim();
            const teachersString = document.getElementById('add-teacher-input').value.trim();

            if (!selectedDay || !selectedClass || !lessonsString || !teachersString) {
                adjustmentMessage.textContent = 'âŒ è«‹é¸æ“‡æ—¥å­ã€ğŸ¯ ç›®æ¨™ç­åˆ¥ï¼Œä¸¦è¼¸å…¥è¦åŠ å…¥çš„ç¯€æ•¸å’Œè€å¸«åå–®ã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            // å‚³éæ—¥å­çµ¦ getTimeSlotsByLessonNumbers
            const timeSlots = getTimeSlotsByLessonNumbers(selectedDay, lessonsString);
            const teachersToAdd = splitTeacherList(teachersString);
            
            if (timeSlots.length === 0) {
                adjustmentMessage.textContent = `âŒ ç„¡æ•ˆçš„ç¯€æ•¸è¼¸å…¥ã€‚è«‹æª¢æŸ¥è¼¸å…¥çš„ç¯€æ•¸æ˜¯å¦å­˜åœ¨æ–¼ ${selectedDay} çš„æ™‚é–“è¡¨ä¸­ã€‚`;
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            if (teachersToAdd.length === 0) {
                 adjustmentMessage.textContent = 'âŒ ç„¡æ•ˆçš„è€å¸«åå–®è¼¸å…¥ã€‚';
                 adjustmentMessage.style.color = 'red';
                 return;
            }

            let addCount = 0;
            const teachersToAddSet = new Set(teachersToAdd);
            
            scheduleData.forEach(record => {
                // é€™è£¡å¿…é ˆæª¢æŸ¥ç›®æ¨™ç­åˆ¥
                if (record['æ—¥å­'] === selectedDay && record['ç­åˆ¥'] === selectedClass && timeSlots.includes(record['æ™‚é–“'])) {
                    
                    let currentTeachersString = record['ä¸Šèª²æ•™å¸«'] || '';
                    let currentTeachers = splitTeacherList(currentTeachersString);
                    let currentTeachersSet = new Set(currentTeachers);
                    
                    let teachersAddedToThisRecord = 0;
                    
                    teachersToAddSet.forEach(newTeacher => {
                        if (!currentTeachersSet.has(newTeacher)) {
                            currentTeachers.push(newTeacher);
                            teachersAddedToThisRecord++;
                        }
                    });
                    
                    if (teachersAddedToThisRecord > 0) {
                        // Join with a space, as per existing data convention
                        record['ä¸Šèª²æ•™å¸«'] = currentTeachers.join(' '); 
                        addCount += teachersAddedToThisRecord;
                    }
                }
            });
            
            if (addCount > 0) {
                adjustmentMessage.textContent = `âœ… æˆåŠŸåœ¨ ${selectedClass} ç­ ${selectedDay} ${lessonsString} ç¯€åŠ å…¥è€å¸« ${teachersString} (å…±æ–°å¢ ${addCount} å€‹æ•™å¸«åˆ†é…)ã€‚è«‹æŸ¥çœ‹ä¸Šæ–¹æŸ¥è©¢çµæœã€‚`;
                adjustmentMessage.style.color = 'green';
                updateDisplays();
            } else {
                adjustmentMessage.textContent = `âš ï¸ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„èª²å ‚æˆ–æ‰€æœ‰è€å¸«å·²å­˜åœ¨ã€‚è«‹ç¢ºèªç­åˆ¥ã€æ—¥å­å’Œç¯€æ•¸è¼¸å…¥æ­£ç¢ºã€‚`;
                adjustmentMessage.style.color = 'orange';
            }
        }


        // ====================================================================
        // åˆå§‹åŒ–å’Œäº‹ä»¶ç›£è½
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // æŸ¥è©¢åŠŸèƒ½ç›£è½
            daySelect.addEventListener('change', updateDisplays);
            // Modified listener for class select
            classSelect.addEventListener('change', handleClassSelectChange); 
            // New listener for custom multi-class input
            multiClassInput.addEventListener('input', displaySchedule);
            
            teacherNameInput.addEventListener('input', displayTeacherSchedule); 
            lessonNumberInput.addEventListener('input', displayTeacherSchedule); 
            priorityTeacherInput.addEventListener('input', displayTeacherSchedule); 
            dutyTeacherInput.addEventListener('input', displayTeacherSchedule); 
            
            // èª¿å ‚åŠŸèƒ½ç›£è½
            document.getElementById('swap-classes-btn').addEventListener('click', handleClassSwapClick);
            document.getElementById('clear-teachers-btn').addEventListener('click', handleTeacherClearClick);
            document.getElementById('add-teacher-btn').addEventListener('click', handleTeacherAddClick); 
            
            // NEW SAVE/LOAD LISTENERS
            saveDataBtn.addEventListener('click', handleSaveClick);
            loadDataBtn.addEventListener('click', handleLoadClick);
            
            loadDataAndPopulateControls();
        });
        
        // ********************************************************************
        // å‡½æ•¸ï¼šé¡¯ç¤ºæ‰€æœ‰ç­åˆ¥çš„åˆä½µèª²è¡¨ (èˆ‡ displayCustomMultiClassesSchedule å…±ç”¨é‚è¼¯)
        // ********************************************************************
        
        function displayAllClassesSchedule(selectedDay) {
            
            const allTimeSlots = [...new Set(scheduleData
                .filter(item => item['æ—¥å­'] === selectedDay && item['æ™‚é–“'])
                .map(item => item['æ™‚é–“']))
            ].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
            
            const allClasses = [...new Set(scheduleData.map(item => item['ç­åˆ¥']).filter(Boolean))].sort();
            
            const currentTimetableMap = getCurrentTimetableMap(selectedDay); 

            if (allTimeSlots.length === 0) {
                resultMessage.textContent = `åœ¨ ${selectedDay}ï¼Œæ²’æœ‰æ‰¾åˆ°ä»»ä½•èª²è¡¨æ•¸æ“šã€‚`;
                scheduleHeader.innerHTML = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th><th>(ç„¡ç­åˆ¥æ•¸æ“š)</th></tr>'; 
                scheduleBody.innerHTML = `<tr><td colspan="${allClasses.length + 2}" style="text-align: center;">æ²’æœ‰æ•¸æ“šã€‚</td></tr>`;
                return;
            }
            
            // 2. å½™æ•´æ•¸æ“š: { time: { class: {èª²å ‚, ä¸Šèª²æ•™å¸«} } }
            const aggregatedData = new Map();
            scheduleData.forEach(item => {
                if (item['æ—¥å­'] === selectedDay && item['ç­åˆ¥']) { 
                    if (!aggregatedData.has(item['æ™‚é–“'])) {
                        aggregatedData.set(item['æ™‚é–“'], new Map());
                    }
                    aggregatedData.get(item['æ™‚é–“']).set(item['ç­åˆ¥'], {
                        lesson: item['èª²å ‚'] || '---',
                        teacher: item['ä¸Šèª²æ•™å¸«'] || '' 
                    });
                }
            });

            // 3. ç”Ÿæˆè¡¨é ­
            let headerHtml = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th>';
            allClasses.forEach(className => {
                headerHtml += `<th>${className}</th>`;
            });
            headerHtml += '</tr>';
            scheduleHeader.innerHTML = headerHtml; 
            
            // 4. ç”Ÿæˆè¡¨æ ¼å…§å®¹
            scheduleBody.innerHTML = '';
            
            allTimeSlots.forEach(timeSlot => {
                
                // --- CONFLICT DETECTION LOGIC ---
                const teachingTeachers = new Map(); 
                const classDataMap = aggregatedData.get(timeSlot) || new Map();
                
                allClasses.forEach(className => {
                    const classLesson = classDataMap.get(className);
                    if (classLesson) {
                        const rawTeacher = String(classLesson.teacher).trim();
                        const teachers = splitTeacherList(rawTeacher);
                        
                        const lesson = String(classLesson.lesson).trim();
                        // åªæª¢æŸ¥éä¼‘æ¯æ´»å‹•çš„æ•™å¸«è¡çª
                        if (!NON_LESSON_ACTIVITIES.includes(lesson)) {
                            teachers.forEach(teacher => {
                                if (teacher.length > 0 && teacher !== '---') { 
                                    if (!teachingTeachers.has(teacher)) {
                                        teachingTeachers.set(teacher, new Set());
                                    }
                                    teachingTeachers.get(teacher).add(className);
                                }
                            });
                        }
                    }
                });

                const conflictedTeachers = new Set();
                teachingTeachers.forEach((classesSet, teacher) => {
                    if (classesSet.size >= 2) { 
                        conflictedTeachers.add(teacher);
                    }
                });
                // --- END CONFLICT DETECTION LOGIC ---
                
                const row = scheduleBody.insertRow();
                const lessonNumber = currentTimetableMap.get(timeSlot) || '---';
                
                // Col 1 & 2: ç¯€æ•¸, æ™‚é–“
                row.insertCell().textContent = lessonNumber;
                row.insertCell().textContent = timeSlot;
                
                
                allClasses.forEach(className => {
                    const cell = row.insertCell();
                    const classLesson = classDataMap.get(className);
                    
                    if (classLesson) {
                        const lesson = String(classLesson.lesson).trim();
                        const rawTeacher = String(classLesson.teacher).trim();
                        const teachers = splitTeacherList(rawTeacher); 
                        
                        let cellStyle = '';
                        
                        const hasConflict = teachers.some(teacher => conflictedTeachers.has(teacher));
                        
                        if (hasConflict) {
                            cellStyle = 'background-color: #FFC299;'; 
                        } else {
                            // æª¢æŸ¥æ˜¯å¦ç‚ºåªé¡¯ç¤ºæ´»å‹•åç¨±çš„é …ç›®
                            const isLesson = !NON_LESSON_ACTIVITIES.includes(lesson);
                            const isTeacherMissing = teachers.length === 0;

                            if (isLesson && isTeacherMissing) {
                                cellStyle = 'background-color: #ffc2c2;'; 
                            }
                        }
                        cell.style.cssText = cellStyle;
                        
                        
                        if (NON_LESSON_ACTIVITIES.includes(lesson)) {
                            cell.textContent = lesson; 
                        } else if (lesson === '---' && rawTeacher === '') {
                            cell.textContent = '---';
                        } else {
                            // åŒ…æ‹¬ æ—©æœƒ/ç­ä¸»ä»»èª²/é–±è®€ åœ¨å…§çš„æ‰€æœ‰æ´»å‹•å‡ä½¿ç”¨æ­¤æ ¼å¼
                            const displayTeacherValue = rawTeacher || '---';
                            const styledTeachers = splitTeacherList(displayTeacherValue)
                                .map(name => getStyledTeacherName(name))
                                .join(' / '); 
                                
                            cell.innerHTML = `${lesson} - ${styledTeachers}`;
                        }
                    } else {
                        cell.textContent = '---';
                    }
                });
            });

            resultMessage.textContent = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}ï¼Œæ‰€æœ‰ ${allClasses.length} å€‹ç­åˆ¥çš„åˆä½µèª²è¡¨ (å…± ${allTimeSlots.length} å€‹æ™‚é–“æ®µ)ã€‚`;
        }

    </script>

</body>
</html>