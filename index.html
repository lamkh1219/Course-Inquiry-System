<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­ç´šèª²å ‚èˆ‡æ•™å¸«æŸ¥è©¢ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #2c3e50;
            margin-top: 30px;
            border-left: 5px solid #3498db;
            padding-left: 10px;
        }
        h3 {
            color: #d35400; /* æ©™è‰²å€åˆ†èª¿æ•´å­åŠŸèƒ½ */
            margin-top: 20px;
            border-bottom: 1px dashed #e67e22;
            padding-bottom: 5px;
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 8px;
        }
        .select-group {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
        }
        .input-full-width {
            flex: 1 1 100%; /* ä½”æ»¿æ•´è¡Œ */
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        label {
            font-weight: bold;
            margin-right: 5px;
            /* è®“æ¨™ç±¤åœ¨è¼¸å…¥æ¡†å¯¬åº¦æ”¹è®Šæ™‚ä¸æœƒå¤ªå¿«æ›è¡Œ */
            white-space: nowrap; 
        }
        /* çµ±ä¸€æ‰€æœ‰è¼¸å…¥æ¡†çš„æ¨£å¼ï¼Œä½¿å…¶å¯¬åº¦ä¸€è‡´ä¸”å…·å½ˆæ€§ */
        select, input[type="text"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            min-width: 150px;
            flex-grow: 1; /* è®“è¼¸å…¥æ¡†ä½”ç”¨å‰©é¤˜ç©ºé–“ï¼Œç¢ºä¿å¯¬åº¦ä¸€è‡´ */
        }
        /* é‡å°æª”æ¡ˆä¸Šå‚³è¼¸å…¥æ¡†ï¼Œèª¿æ•´æ¨£å¼ */
        input[type="file"] {
            padding: 5px;
            border: none;
        }
        button {
            padding: 10px 15px;
            margin-top: 10px;
            background-color: #e67e22;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #d35400;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        /* é‡å°æ–°çš„å„²å­˜èˆ‡è¼‰å…¥æŒ‰éˆ•è¨­ç½®ä¸åŒé¡è‰² */
        #save-data-btn {
            background-color: #2ecc71; /* ç¶ è‰² */
        }
        #save-data-btn:hover:not(:disabled) {
            background-color: #27ae60;
        }
        #load-data-btn {
            background-color: #3498db; /* è—è‰² */
        }
        #load-data-btn:hover:not(:disabled) {
            background-color: #2980b9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: white;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
            vertical-align: top;
            /* é‡å°å…¨ç­åˆ¥è¦–åœ–ï¼Œè®“å–®å…ƒæ ¼å…§å®¹å¯ä»¥æ›è¡Œ */
            word-break: break-word; 
        }
        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            /* ç¢ºä¿ç­åˆ¥æ¨™é¡Œä¸æœƒæ›è¡Œ */
            white-space: nowrap; 
        }
        .teacher-table th {
             background-color: #2ecc71; /* ç¶ è‰²ï¼Œå€åˆ†æŸ¥è©¢ */
        }
        #teacher-schedule-output td:last-child {
            background-color: #e6f7ff;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .teacher-header-row {
            background-color: #ffe082 !important; 
            font-weight: bold;
            text-align: center;
        }
        .teacher-header-row td {
            font-size: 1.1em;
        }
        .timeslot-header-row {
            background-color: #d8eaff !important; /* æ·ºè—è‰² */
            font-weight: bold;
            text-align: left;
        }
        .timeslot-header-row td {
            font-size: 1.0em;
        }
        p > span[style*="background-color: #ffc2c2"] { /* ç¼ºå°‘è€å¸«çš„ç²‰ç´…è‰² */
            background-color: #ffc2c2;
        }
        p > span[style*="background-color: #FFC299"] { /* æ•™å¸«è¡çªçš„ç²‰æ©™è‰² */
            background-color: #FFC299;
            color: #333; 
        }


        #result-message, #teacher-result-message, #adjustment-message {
            margin-top: 15px;
            font-style: italic;
            font-weight: bold;
            color: #2980b9;
        }
        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>

    <h1>ç­ç´šèª²å ‚èˆ‡æ•™å¸«æŸ¥è©¢ç³»çµ±</h1>
    <p style="color: green;">âœ… æ­£åœ¨è‡ªå‹•è¼‰å…¥ **`ç­åˆ¥æ™‚é–“ç¸½è¡¨.csv`**ã€**`S&PSM_L.csv`**ã€**`Teacher List.csv`** å’Œ **`æ™‚é–“è¡¨.csv`** æª”æ¡ˆ...</p>

    <div class="controls">
        <div class="select-group">
            <label for="day-select">å…±åŒé¸æ“‡æ—¥å­:</label>
            <select id="day-select" disabled>
                <option>è¼‰å…¥ä¸­...</option>
            </select>
        </div>
    </div>
    
    <hr>
    <h2>1. æ•™å¸«ç©ºé–’æŸ¥è©¢ (Teacher Free Time Lookup)</h2>
    <p>â„¹ï¸ **P Grade**/<span style="color: red; font-weight: bold;">ç´…è‰²</span>ï¼Œ**S Grade**/<span style="color: blue; font-weight: bold;">è—è‰²</span>ã€‚å„ªå…ˆä»£èª²è€å¸«ä»¥ <span style="color: orange; font-weight: bold;">æ©™è‰²</span> é¡¯ç¤ºä¸¦æ’æœ€å‰ã€‚å¯å–®ç¨è¼¸å…¥**ç¯€æ•¸**æŸ¥è©¢è©²æ™‚æ®µæ‰€æœ‰ç©ºé–’æ•™å¸«ã€‚</p>
    
    <div class="controls">
        <div class="input-full-width">
            <label for="teacher-name-input">è¼¸å…¥éœ€è¦èª²å ‚èª¿å‹•æ•™å¸«å§“å (é¸å¡«):</label>
            <input type="text" id="teacher-name-input" placeholder="ä¾‹å¦‚: å©· é´»" disabled>
        </div>

        <div class="input-full-width">
            <label for="lesson-number-input" style="color: #3498db;">æŸ¥è©¢ç¯€æ•¸ (ä¾‹å¦‚: 3,4,5) (é¸å¡«):</label>
            <input type="text" id="lesson-number-input" placeholder="ä¾‹å¦‚: 3,4,5" disabled>
        </div>
        
        <div class="input-full-width">
            <label for="priority-teacher-input" style="color: orange;">å„ªå…ˆä»£èª²è€å¸«åå–® (æ©™è‰²ï¼Œæ’æœ€å‰):</label>
            <input type="text" id="priority-teacher-input" placeholder="ä¾‹å¦‚: é›… é­" disabled>
        </div>
        
        <div class="input-full-width">
            <label for="duty-teacher-input" style="color: #900;">å·²æœ‰å…¬å‹™è€å¸«åå–® (æ’é™¤åå–®):</label>
            <input type="text" id="duty-teacher-input" placeholder="ä¾‹å¦‚: ç›§ æ¬£" disabled>
        </div>
    </div>
    
    <div id="teacher-schedule-output">
        <table class="teacher-table">
            <thead>
                <tr>
                    <th>ç¯€æ•¸</th>
                    <th>æ™‚é–“</th>
                    <th>ç­åˆ¥</th>
                    <th>èª²å ‚</th>
                    <th>ç©ºé–’æ•™å¸« (å¯ä»£èª²åå–®) - æŒ‰å„ªå…ˆç´šåŠç©ºå ‚æ•¸æ’åº</th>
                </tr>
            </thead>
            <tbody id="teacher-schedule-body">
                <tr><td colspan="5" style="text-align: center;">è«‹è¼¸å…¥æ•™å¸«å§“åæˆ–ç¯€æ•¸ä¸¦é¸æ“‡æ—¥å­</td></tr>
            </tbody>
        </table>
        <p id="teacher-result-message"></p>
    </div>

    
    <hr>
    <h2>2. ç­ç´šèª²è¡¨æŸ¥è©¢ (Class Schedule Lookup)</h2>
    <p>â„¹ï¸ **P Grade** æ•™å¸«ä»¥ <span style="color: red; font-weight: bold;">ç´…è‰²</span> é¡¯ç¤ºï¼Œ**S Grade** æ•™å¸«ä»¥ <span style="color: blue; font-weight: bold;">è—è‰²</span> é¡¯ç¤ºã€‚**æ²’æœ‰æ•™å¸«çš„å¸¸è¦/æŒ‡å®šèª²å ‚** å°‡ä»¥ <span style="background-color: #ffc2c2; font-weight: bold;">ç²‰ç´…è‰²åº•è‰²</span> é¡¯ç¤ºã€‚**å¦‚æœåŒä¸€æ•™å¸«åœ¨åŒä¸€ç¯€æ•¸å‡ºç¾åœ¨å…©ç­ä»¥ä¸Šèª²å ‚**ï¼Œå°‡ä»¥ <span style="background-color: #FFC299; color: #333; font-weight: bold;">ç²‰æ©™è‰²åº•è‰²</span> é¡¯ç¤º (åƒ…åœ¨ã€Œæ‰€æœ‰ç­åˆ¥ã€è¦–åœ–)ã€‚</p>
    
    <div class="controls">
        <div class="select-group">
            <label for="class-select">é¸æ“‡ç­åˆ¥:</label>
            <select id="class-select" disabled>
                <option>è¼‰å…¥ä¸­...</option>
            </select>
        </div>
    </div>

    <div id="schedule-output">
        <table>
            <thead id="schedule-header">
                <tr>
                    <th>ç¯€æ•¸</th>
                    <th>æ™‚é–“</th>
                    <th>èª²å ‚</th>
                    <th>ä¸Šèª²æ•™å¸«</th>
                </tr>
            </thead>
            <tbody id="schedule-body">
                <tr><td colspan="4" style="text-align: center;">æ•¸æ“šè¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</td></tr>
            </tbody>
        </table>
        <p id="result-message"></p>
    </div>

    <hr>
    <h2>3. èª¿å ‚åŠŸèƒ½ (Class/Teacher Assignment Adjustment)</h2>
    <p style="color: orange;">âš ï¸ **æ³¨æ„:** ä»¥ä¸‹æ“ä½œå°‡ä¿®æ”¹ç•¶å‰ç¶²é çš„æ’èª²è³‡æ–™ã€‚è«‹ä½¿ç”¨ä¸‹æ–¹çš„ã€Œå„²å­˜ã€åŠŸèƒ½ä¾†ä¸‹è¼‰å·²èª¿æ•´çš„æ•¸æ“šã€‚</p>
    
    <div class="controls">
        
        <h3>3.1. èª²å ‚å…§å®¹å°èª¿ (Swap - æ”¯æ´è·¨ç­åˆ¥/è·¨ç´šåˆ¥)</h3>
        <p>æ­¤åŠŸèƒ½å°‡èª¿æ›**å…©çµ„ç¨ç«‹æ’èª²ä½ç½®**çš„èª²å ‚å’Œä¸Šèª²æ•™å¸«æ¬„ä½ã€‚é€™å¯ç”¨æ–¼**è·¨ç­åˆ¥ã€è·¨ç´šåˆ¥**æˆ–åœ¨**åŒä¸€ç­åˆ¥**å…§èª¿å‹•ã€‚</p>
        
        <div class="input-full-width" style="background-color: #f7f3e8; padding: 5px; border-radius: 4px;">
            <label for="swap-class-1-select" style="min-width: 60px;">A ç­åˆ¥:</label>
            <select id="swap-class-1-select" disabled style="flex-grow: 0; margin-right: 10px;"></select>
            <label for="swap-lessons-1-input" style="min-width: 60px;">A ç¯€æ•¸ (ä¾‹å¦‚: 3,4):</label>
            <input type="text" id="swap-lessons-1-input" placeholder="3,4">
        </div>

        <div class="input-full-width" style="background-color: #e8f7f3; padding: 5px; border-radius: 4px;">
            <label for="swap-class-2-select" style="min-width: 60px;">B ç­åˆ¥:</label>
            <select id="swap-class-2-select" disabled style="flex-grow: 0; margin-right: 10px;"></select>
            <label for="swap-lessons-2-input" style="min-width: 60px;">B ç¯€æ•¸ (ä¾‹å¦‚: 7,8):</label>
            <input type="text" id="swap-lessons-2-input" placeholder="7,8">
        </div>

        <button id="swap-classes-btn" disabled>åŸ·è¡Œèª²å ‚å°èª¿ (Swap)</button>

        <hr style="margin: 20px 0;">
        
        <div class="select-group">
            <label for="class-select-adj">ğŸ¯ **é¸æ“‡è¦èª¿æ•´è€å¸«æ’èª²çš„ç­åˆ¥** (åªç”¨æ–¼ä»¥ä¸‹**æ–°å¢è€å¸«**åŠŸèƒ½):</label>
            <select id="class-select-adj" disabled>
                <option>è¼‰å…¥ä¸­...</option>
            </select>
        </div>

        <h3>3.2. æ¸…ç©ºè€å¸«æ’èª² (Clear)</h3>
        <p>æ­¤åŠŸèƒ½å°‡å¾**æ‰€æœ‰ç­åˆ¥**ä¸­ï¼Œæ¸…é™¤æŒ‡å®šè€å¸«åœ¨**æ‰€é¸æ—¥å­**å’Œ**æŒ‡å®šç¯€æ•¸**ä¸Šçš„æ’èª²ã€‚</p>
        <div class="input-full-width">
            <label for="clear-lessons-input">æ¸…ç©ºã€Œç¯€æ•¸ã€ (ä¾‹å¦‚: 3,4):</label>
            <input type="text" id="clear-lessons-input" placeholder="3,4">
        </div>
        <div class="input-full-width">
            <label for="clear-teachers-input" style="color: #900;">æ¸…ç©ºæ’èª²è€å¸«åå–® (ä¾‹å¦‚: ç›§ æ¬£):</label>
            <input type="text" id="clear-teachers-input" placeholder="ç›§ æ¬£">
        </div>
        <button id="clear-teachers-btn" disabled>åŸ·è¡Œæ¸…ç©ºæ’èª² (Clear)</button>
        
        <h3>3.3. æ–°å¢è€å¸«æ’èª² (Add)</h3>
        <p>æ­¤åŠŸèƒ½å°‡åœ¨ **ğŸ¯ æ‰€é¸ç­åˆ¥** çš„ **æŒ‡å®šç¯€æ•¸** ä¸Šï¼ŒåŠ å…¥æŒ‡å®šçš„è€å¸«åˆ°æ’èª²åå–®ã€‚å¦‚æœè©²ä½ç½®å·²æœ‰è€å¸«ï¼Œå‰‡æœƒé™„åŠ è€å¸«åå–®ã€‚</p>
        <div class="input-full-width">
            <label for="add-lessons-input">åŠ å…¥ã€Œç¯€æ•¸ã€ (ä¾‹å¦‚: 3,4):</label>
            <input type="text" id="add-lessons-input" placeholder="3,4">
        </div>
        <div class="input-full-width">
            <label for="add-teacher-input" style="color: #007bff;">æ–°å¢è€å¸«åå–® (ä¾‹å¦‚: ç›§ æ¬£):</label>
            <input type="text" id="add-teacher-input" placeholder="ç›§ æ¬£">
        </div>
        <button id="add-teacher-btn" disabled>åŸ·è¡Œæ–°å¢æ’èª² (Add)</button>

    </div>
    
    <div class="controls">
        <h3>3.4. å„²å­˜èˆ‡è¼‰å…¥åŠŸèƒ½ (Save & Load)</h3>
        <p style="color: green; font-weight: bold;">ğŸ’¾ å„²å­˜ (Save): åƒ…ä¸‹è¼‰æœ‰è®Šå‹•çš„èª²å ‚è¨˜éŒ„ (Diff CSV)ã€‚</p>
        <div class="select-group">
            <button id="save-data-btn" disabled style="background-color: #2ecc71;">ğŸ“¥ ä¸‹è¼‰å·²èª¿æ•´æ’èª²è¡¨å·®ç•° (Save Diff)</button>
        </div>
        <p style="color: blue; font-weight: bold; margin-top: 15px;">â¬†ï¸ è¼‰å…¥ (Load): ä¸Šå‚³å·®ç•° CSV æª”æ¡ˆï¼Œå°‡è®Šå‹•æ‡‰ç”¨åˆ°ç•¶å‰æ’èª²è¡¨ä¸­ã€‚</p>
        <div class="input-full-width" style="margin-top: 5px;">
            <label for="load-file-input">ä¸Šå‚³å·®ç•° CSV æª”æ¡ˆ (Load Diff):</label>
            <input type="file" id="load-file-input" accept=".csv" disabled>
            <button id="load-data-btn" disabled style="background-color: #3498db; margin-left: 10px;">â¬†ï¸ æ‡‰ç”¨æ’èª²è¡¨å·®ç•° (Load Diff)</button>
        </div>
    </div>


    <p id="adjustment-message" style="margin-top: 15px; font-weight: bold;"></p>

    <script>
        const CSV_FILE_PATH = "ç­åˆ¥æ™‚é–“ç¸½è¡¨.csv"; 
        const GRADE_FILE_PATH = "S&PSM_L.csv"; 
        const TEACHER_LIST_FILE_PATH = "Teacher List.csv";
        const TIMETABLE_FILE_PATH = "æ™‚é–“è¡¨.csv"; 
        
        const NON_LESSON_ACTIVITIES = ['å°æ¯', 'åˆè†³', 'åˆé–“æ´»å‹•', 'é€±æœƒï¼èª²é–“æ´»å‹•'];
        
        // --- æ ¸å¿ƒä¿®æ”¹é» 1: æ–°å¢è®Šæ•¸ä¾†å„²å­˜åŸå§‹æ•¸æ“šå’Œ Map ---
        let scheduleData = []; // ç•¶å‰å¯ä¿®æ”¹çš„æ•¸æ“šé™£åˆ—
        let initialScheduleData = []; // åŸå§‹æ•¸æ“šé™£åˆ—ï¼ˆä¸è®Šï¼‰
        let scheduleDataMap = new Map(); // Key: æ—¥å­|ç­åˆ¥|æ™‚é–“ -> Value: record (Current)
        let initialScheduleDataMap = new Map(); // Key: æ—¥å­|ç­åˆ¥|æ™‚é–“ -> Value: record (Initial)
        
        let teacherGradesMap = new Map(); 
        let teacherListCache = []; 
        let timetableDayTypeMap = new Map(); 
        
        // DOM å…ƒç´ å¼•ç”¨
        const daySelect = document.getElementById('day-select');
        const classSelect = document.getElementById('class-select');
        const scheduleHeader = document.getElementById('schedule-header'); 
        const scheduleBody = document.getElementById('schedule-body');
        const resultMessage = document.getElementById('result-message');
        
        const teacherNameInput = document.getElementById('teacher-name-input');
        const lessonNumberInput = document.getElementById('lesson-number-input'); 
        const teacherScheduleBody = document.getElementById('teacher-schedule-body');
        const teacherResultMessage = document.getElementById('teacher-result-message');
        
        const priorityTeacherInput = document.getElementById('priority-teacher-input');
        const dutyTeacherInput = document.getElementById('duty-teacher-input');

        // ADJUSTMENT CONTROLS
        const classSelectAdj = document.getElementById('class-select-adj'); 
        const swapClassesBtn = document.getElementById('swap-classes-btn');
        const clearTeachersBtn = document.getElementById('clear-teachers-btn');
        const addTeacherBtn = document.getElementById('add-teacher-btn');
        
        // NEW SWAP CONTROLS
        const swapClass1Select = document.getElementById('swap-class-1-select');
        const swapLessons1Input = document.getElementById('swap-lessons-1-input');
        const swapClass2Select = document.getElementById('swap-class-2-select');
        const swapLessons2Input = document.getElementById('swap-lessons-2-input');
        
        // SAVE/LOAD CONTROLS
        const saveDataBtn = document.getElementById('save-data-btn');
        const loadFileInput = document.getElementById('load-file-input');
        const loadDataBtn = document.getElementById('load-data-btn');
        
        const adjustmentMessage = document.getElementById('adjustment-message');
        
        // ====================================================================
        // æ ¸å¿ƒè¼”åŠ©åŠŸèƒ½
        // ====================================================================

        /**
         * å‰µå»ºä¸€å€‹å”¯ä¸€çš„ Key ç”¨æ–¼ Map æŸ¥æ‰¾ã€‚
         * @param {object} record - å–®ä¸€æ’èª²è¨˜éŒ„
         * @returns {string} æ ¼å¼: æ—¥å­|ç­åˆ¥|æ™‚é–“
         */
        function createKey(record) {
            return `${record['æ—¥å­']}|${record['ç­åˆ¥']}|${record['æ™‚é–“']}`;
        }
        
        /**
         * å‰µå»ºä¸€å€‹æ’èª²æ•¸æ“š Map ä»¥ä¾›å¿«é€ŸæŸ¥æ‰¾å’Œä¿®æ”¹ã€‚
         * @param {Array<object>} dataArray - æ’èª²è¨˜éŒ„é™£åˆ—
         * @returns {Map<string, object>} - Key: æ—¥å­|ç­åˆ¥|æ™‚é–“, Value: record
         */
        function createScheduleMap(dataArray) {
            const map = new Map();
            dataArray.forEach(record => {
                if (record['æ—¥å­'] && record['ç­åˆ¥'] && record['æ™‚é–“']) {
                    map.set(createKey(record), record);
                }
            });
            return map;
        }

        /**
         * æ‰¾å‡ºç•¶å‰æ•¸æ“šèˆ‡åŸå§‹æ•¸æ“šä¸åŒçš„è¨˜éŒ„ (Diffs)ã€‚
         * @returns {Array<object>} - åƒ…åŒ…å«æœ‰è®Šå‹•çš„è¨˜éŒ„
         */
        function findModifiedRecords() {
            const modifiedRecords = [];
            
            // ç”±æ–¼ scheduleDataMap åŒ…å«ç•¶å‰æ‰€æœ‰æ•¸æ“šï¼Œæˆ‘å€‘ä»¥å®ƒç‚ºåŸºç¤é€²è¡Œéæ­·
            for (const [key, currentRecord] of scheduleDataMap.entries()) {
                const initialRecord = initialScheduleDataMap.get(key);
                
                // å¦‚æœåŸå§‹æ•¸æ“šä¸­æ²’æœ‰é€™æ¢è¨˜éŒ„ï¼ˆä¸æ‡‰è©²ç™¼ç”Ÿï¼Œé™¤éæ‰‹å‹•ä¿®æ”¹äº†åŸå§‹æ•¸æ“šçµæ§‹ï¼‰ï¼Œå‰‡è·³é
                if (!initialRecord) continue; 

                // æ¯”è¼ƒé—œéµæ¬„ä½ï¼šèª²å ‚ å’Œ ä¸Šèª²æ•™å¸«
                const currentLesson = String(currentRecord['èª²å ‚'] || '').trim();
                const initialLesson = String(initialRecord['èª²å ‚'] || '').trim();
                
                const currentTeacher = String(currentRecord['ä¸Šèª²æ•™å¸«'] || '').trim();
                const initialTeacher = String(initialRecord['ä¸Šèª²æ•™å¸«'] || '').trim();
                
                if (currentLesson !== initialLesson || currentTeacher !== initialTeacher) {
                    // åªå°‡æœ‰è®Šå‹•çš„è¨˜éŒ„åŠ å…¥åˆ°çµæœä¸­
                    // ä½¿ç”¨å±•é–‹é‹ç®—ç¬¦ç¢ºä¿æˆ‘å€‘è¤‡è£½äº†ä¸€å€‹è¨˜éŒ„ï¼Œé˜²æ­¢å¾ŒçºŒä¿®æ”¹
                    modifiedRecords.push({ ...currentRecord }); 
                }
            }
            return modifiedRecords;
        }

        function getCurrentTimetableMap(day) {
            if (!day) return new Map();
            const dayType = (day === 'æ˜ŸæœŸäº”' || day === 'Friday') ? 'Day5' : 'Day1-4';
            return timetableDayTypeMap.get(dayType) || new Map();
        }

        function timeToMinutes(timeString) {
            if (!timeString || typeof timeString !== 'string') return 0;
            const startTime = timeString.split('-')[0].trim(); 
            const parts = startTime.split(':');
            if (parts.length !== 2) return 0;
            
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);
            return hours * 60 + minutes;
        }

        function splitTeacherList(teacherString) {
            if (!teacherString) return []; 
            return String(teacherString)
                .split(/[\s,ï¼Œ\/\ï¼+]+/) 
                .map(name => name.trim()) 
                .filter(name => name.length > 0 && name !== '---'); 
        }

        function getStyledTeacherName(teacherName) {
            if (!teacherName || teacherName === '---') return teacherName;

            const grade = teacherGradesMap.get(teacherName);
            let colorStyle = '';

            if (grade === 'P') {
                colorStyle = 'color: red; font-weight: bold;';
            } else if (grade === 'S') {
                colorStyle = 'color: blue; font-weight: bold;';
            }

            if (colorStyle) {
                return `<span style="${colorStyle}">${teacherName}</span>`;
            }
            return teacherName;
        }

        function getFreeListStyledTeacherName(teacherName, isPriority) {
            if (!teacherName || teacherName === '---') return teacherName;

            let color = 'inherit'; 
            
            if (isPriority) {
                color = 'orange'; 
            } else {
                const grade = teacherGradesMap.get(teacherName);
                if (grade === 'P') {
                    color = 'red';
                } else if (grade === 'S') {
                    color = 'blue';
                }
            }

            if (color !== 'inherit') {
                return `<span style="color: ${color}; font-weight: bold;">${teacherName}</span>`;
            }
            return teacherName;
        }

        function getAllTeachers() {
            return teacherListCache; 
        }

        function getOccupiedTeachers(day, time) {
            const occupiedSet = new Set();
            // å¾ Map ä¸­æŸ¥æ‰¾æ‰€æœ‰ç­åˆ¥çš„è¨˜éŒ„
            for (const record of scheduleDataMap.values()) {
                if (record['æ—¥å­'] === day && record['æ™‚é–“'] === time) {
                    if (record['ä¸Šèª²æ•™å¸«']) {
                        const teachingNames = splitTeacherList(record['ä¸Šèª²æ•™å¸«']);
                        teachingNames.forEach(name => occupiedSet.add(name));
                    }
                }
            }
            return occupiedSet;
        }

        function calculateDailyFreeLessons(day) {
            const excludedLessons = NON_LESSON_ACTIVITIES;
            
            const relevantUniqueTimeSlots = [...new Set(Array.from(scheduleDataMap.values())
                .filter(item => 
                    item['æ—¥å­'] === day && 
                    !excludedLessons.includes(String(item['èª²å ‚']).trim())
                )
                .map(item => item['æ™‚é–“']))
            ];

            const allTeachers = getAllTeachers(); 
            const freeLessonCountMap = new Map();

            allTeachers.forEach(teacher => {
                freeLessonCountMap.set(teacher, 0);
            });

            relevantUniqueTimeSlots.forEach(timeSlot => {
                const occupiedSet = getOccupiedTeachers(day, timeSlot); 
                
                allTeachers.forEach(teacher => {
                    if (!occupiedSet.has(teacher)) {
                        freeLessonCountMap.set(teacher, freeLessonCountMap.get(teacher) + 1);
                    }
                });
            });

            return freeLessonCountMap;
        }

        function getTimeSlotsByLessonNumbers(day, lessonNumbersString) {
            if (!lessonNumbersString) return [];
            
            const lessonNumbers = String(lessonNumbersString)
                .split(/[\s,ï¼Œ]+/)
                .map(num => String(num).trim())
                .filter(num => num.length > 0);
            
            const currentTimetableMap = getCurrentTimetableMap(day); 

            const lessonToTimeMap = new Map();
            currentTimetableMap.forEach((lesson, time) => {
                if (!lessonToTimeMap.has(lesson)) {
                     lessonToTimeMap.set(lesson, time);
                }
            });
            
            const timeSlots = [];
            lessonNumbers.forEach(lessonNum => {
                const time = lessonToTimeMap.get(lessonNum);
                if (time) {
                    timeSlots.push(time);
                }
            });
            
            timeSlots.sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
            
            return timeSlots;
        }

        function updateDisplays() {
            displaySchedule();
            displayTeacherSchedule();
            saveDataBtn.disabled = false; 
        }
        
        // ====================================================================
        // æ•¸æ“šè¼‰å…¥èˆ‡åˆå§‹åŒ–
        // ====================================================================

        function loadDataAndPopulateControls() {
             resultMessage.textContent = 'è¼‰å…¥æ’èª²è¡¨...'; 
             teacherResultMessage.textContent = 'è¼‰å…¥æ’èª²è¡¨...';
            loadTeacherList();
        }
        
        function loadTeacherList() {
            Papa.parse(TEACHER_LIST_FILE_PATH, {
                download: true,
                header: false, 
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    if (results.data.length > 0 && results.data[0].length > 0) {
                        teacherListCache = results.data
                            .map(row => String(row[0]).trim()) 
                            .filter(name => name.length > 0 && name !== 'Teacher List'); 

                        teacherResultMessage.textContent = `âœ… æ•™å¸«åå–®æª”æ¡ˆè¼‰å…¥æˆåŠŸ (å…± ${teacherListCache.length} ä½æ•™å¸«)ã€‚è¼‰å…¥æ’èª²è¡¨...`;
                    } else {
                        teacherResultMessage.textContent = `âš ï¸ æ•™å¸«åå–®æª”æ¡ˆè¼‰å…¥æˆåŠŸï¼Œä½†å…§å®¹ç‚ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¢ºã€‚è¼‰å…¥æ’èª²è¡¨...`;
                    }
                    loadScheduleData();
                },
                error: function(err) {
                    console.error("PapaParse Teacher List Error:", err);
                    teacherResultMessage.textContent = `âŒ è¼‰å…¥æ•™å¸«åå–®æª”æ¡ˆå¤±æ•—ã€‚è«‹ç¢ºèªæª”æ¡ˆ "${TEACHER_LIST_FILE_PATH}" å­˜åœ¨ã€‚è¼‰å…¥æ’èª²è¡¨...`;
                    loadScheduleData();
                }
            });
        }

        // --- æ ¸å¿ƒä¿®æ”¹é» 2: è¼‰å…¥æ™‚å„²å­˜åŸå§‹æ•¸æ“šå’Œ Map ---
        function loadScheduleData() {
            Papa.parse(CSV_FILE_PATH, {
                download: true,         
                header: true,           
                skipEmptyLines: true,   
                dynamicTyping: true,    
                complete: function(results) {
                    
                    if (results.data.length === 0 || !results.data[0]['æ—¥å­'] || !results.data[0]['ç­åˆ¥']) {
                        const errorMsg = "æ’èª²è¡¨æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆæ•¸æ“šï¼Œæˆ–æ¬„ä½æ¨™é¡Œä¸æ­£ç¢ºã€‚";
                        console.error(errorMsg);
                        resultMessage.textContent = `âŒ æ•¸æ“šè¼‰å…¥å¤±æ•—ï¼š${errorMsg}`;
                        disableAllControls();
                        return;
                    }
                    
                    // 1. è¨­ç½®åˆå§‹æ•¸æ“š
                    initialScheduleData = results.data.map(item => ({ ...item })); // æ·±åº¦è¤‡è£½
                    initialScheduleDataMap = createScheduleMap(initialScheduleData);
                    
                    // 2. è¨­ç½®ç•¶å‰æ•¸æ“š
                    scheduleData = results.data;
                    scheduleDataMap = createScheduleMap(scheduleData); 

                    resultMessage.textContent = 'è¼‰å…¥æ’èª²è¡¨æˆåŠŸã€‚è¼‰å…¥æ•™å¸«ç­‰ç´šæª”æ¡ˆ...'; 
                    
                    if (teacherListCache.length === 0) {
                        teacherListCache = deriveTeachersFromSchedule();
                        teacherResultMessage.textContent += ` (å‚™ç”¨: å¾æ’èª²è¡¨æ¨å°å‡º ${teacherListCache.length} ä½æ•™å¸«åå–®)`;
                    }

                    loadTeacherGrades();
                },
                error: function(err) {
                    console.error("PapaParse Schedule Error:", err);
                    resultMessage.textContent = `âŒ è¼‰å…¥æ’èª²è¡¨æª”æ¡ˆå¤±æ•—ã€‚è«‹ç¢ºèªæª”æ¡ˆ "${CSV_FILE_PATH}" å­˜åœ¨ã€‚`;
                    teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">æ’èª²è¡¨æª”æ¡ˆè¼‰å…¥å¤±æ•—ã€‚</td></tr>`;
                    disableAllControls();
                }
            });
        }
        
        function deriveTeachersFromSchedule() {
            const teacherSet = new Set();
             Array.from(scheduleDataMap.values()).forEach(item => {
                if (item['ä¸Šèª²æ•™å¸«']) {
                    splitTeacherList(item['ä¸Šèª²æ•™å¸«']).forEach(name => teacherSet.add(name));
                }
                if (item['å¯ä»£èª²æ•™å¸«']) {
                    splitTeacherList(item['å¯ä»£èª²æ•™å¸«']).forEach(name => teacherSet.add(name));
                }
            });
            return Array.from(teacherSet).filter(name => name !== '---' && name.length > 0);
        }


        function loadTeacherGrades() {
            Papa.parse(GRADE_FILE_PATH, {
                download: true,
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(gradeResults) {
                    if (gradeResults.data.length > 0 && gradeResults.data[0]['æ•™å¸«'] && gradeResults.data[0]['Grade']) {
                        gradeResults.data.forEach(item => {
                            if (item['æ•™å¸«'] && item['Grade']) {
                                teacherGradesMap.set(String(item['æ•™å¸«']).trim(), String(item['Grade']).trim());
                            }
                        });
                        teacherResultMessage.textContent += ' âœ… æ•™å¸«ç­‰ç´šæª”æ¡ˆè¼‰å…¥æˆåŠŸã€‚';
                    } else {
                        teacherResultMessage.textContent += ` âš ï¸ æ•™å¸«ç­‰ç´šæª”æ¡ˆè¼‰å…¥æˆåŠŸï¼Œä½†å…§å®¹æ ¼å¼å¯èƒ½ä¸æ­£ç¢ºã€‚`;
                    }
                    
                    loadTimetableData(); 
                },
                error: function(err) {
                    console.error("PapaParse Grade Error:", err);
                    teacherResultMessage.textContent += ` âŒ è¼‰å…¥æ•™å¸«ç­‰ç´šæª”æ¡ˆå¤±æ•—ã€‚è«‹ç¢ºèªæª”æ¡ˆ "${GRADE_FILE_PATH}" å­˜åœ¨ã€‚`;
                    loadTimetableData(); 
                }
            });
        }
        
        function loadTimetableData() {
            Papa.parse(TIMETABLE_FILE_PATH, {
                download: true,
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(timetableResults) {
                    if (timetableResults.data.length > 0 && timetableResults.data[0]['æ™‚é–“'] && timetableResults.data[0]['ç¯€æ•¸']) {
                        
                        const splitIndex = 17; 
                        
                        const timetable1 = timetableResults.data.slice(0, splitIndex);
                        const timetable2 = timetableResults.data.slice(splitIndex).filter(item => item['æ™‚é–“']); 
                        
                        const finalMap1 = new Map();
                        timetable1.forEach(item => finalMap1.set(String(item['æ™‚é–“']).trim(), String(item['ç¯€æ•¸']).trim()));
                        
                        const finalMap2 = new Map();
                        timetable2.forEach(item => finalMap2.set(String(item['æ™‚é–“']).trim(), String(item['ç¯€æ•¸']).trim()));

                        timetableDayTypeMap.set('Day1-4', finalMap1);
                        timetableDayTypeMap.set('Day5', finalMap2);

                        teacherResultMessage.textContent += ` âœ… ç¯€æ•¸æ™‚é–“è¡¨æª”æ¡ˆè¼‰å…¥æˆåŠŸã€‚å·²è¼‰å…¥ Day1-4 (${finalMap1.size} ç­†) å’Œ Day5 (${finalMap2.size} ç­†) å…©çµ„æ™‚é–“è¡¨ã€‚`;
                    } else {
                        teacherResultMessage.textContent += ` âš ï¸ ç¯€æ•¸æ™‚é–“è¡¨æª”æ¡ˆè¼‰å…¥æˆåŠŸï¼Œä½†å…§å®¹æ ¼å¼å¯èƒ½ä¸æ­£ç¢ºã€‚`;
                    }
                    
                    populateControls(); 
                },
                error: function(err) {
                    console.error("PapaParse Timetable Error:", err);
                    teacherResultMessage.textContent += ` âŒ è¼‰å…¥ç¯€æ•¸æ™‚é–“è¡¨æª”æ¡ˆå¤±æ•—ã€‚è«‹ç¢ºèªæª”æ¡ˆ "${TIMETABLE_FILE_PATH}" å­˜åœ¨ã€‚`;
                    populateControls(); 
                }
            });
        }


        function disableAllControls() {
            // ... (rest of the disableAllControls function remains the same)
            daySelect.disabled = true;
            classSelect.disabled = true;
            teacherNameInput.disabled = true; 
            lessonNumberInput.disabled = true; 
            priorityTeacherInput.disabled = true; 
            dutyTeacherInput.disabled = true; 
            
            classSelectAdj.disabled = true;
            swapClassesBtn.disabled = true;
            clearTeachersBtn.disabled = true;
            addTeacherBtn.disabled = true;

            swapClass1Select.disabled = true;
            swapLessons1Input.disabled = true;
            swapClass2Select.disabled = true;
            swapLessons2Input.disabled = true;
            
            saveDataBtn.disabled = true; 
            loadFileInput.disabled = true;
            loadDataBtn.disabled = true;
        }

        function populateControls() {
            // ... (rest of the populateControls function remains the same)
            daySelect.disabled = false;
            classSelect.disabled = false;
            teacherNameInput.disabled = false;
            lessonNumberInput.disabled = false; 
            priorityTeacherInput.disabled = false; 
            dutyTeacherInput.disabled = false;
            
            classSelectAdj.disabled = false;
            swapClassesBtn.disabled = false;
            clearTeachersBtn.disabled = false;
            addTeacherBtn.disabled = false;

            swapClass1Select.disabled = false;
            swapLessons1Input.disabled = false;
            swapClass2Select.disabled = false;
            swapLessons2Input.disabled = false;
            
            saveDataBtn.disabled = false; 
            loadFileInput.disabled = false;
            loadDataBtn.disabled = false;
            
            // ä½¿ç”¨ scheduleData çš„å€¼ä¾†å¡«å……ä¸‹æ‹‰é¸å–®
            const allDays = [...new Set(Array.from(scheduleDataMap.values()).map(item => item['æ—¥å­']).filter(Boolean))].sort((a, b) => {
                 const order = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­', 'æ˜ŸæœŸæ—¥'];
                 return order.indexOf(a) - order.indexOf(b);
            });
            const allClasses = [...new Set(Array.from(scheduleDataMap.values()).map(item => item['ç­åˆ¥']).filter(Boolean))].sort();

            populateSelect(daySelect, allDays, 'æ—¥å­');
            
            classSelect.innerHTML = ''; 
            
            const allOption = document.createElement('option');
            allOption.value = 'ALL';
            allOption.textContent = '--- æ‰€æœ‰ç­åˆ¥ (All Classes) ---';
            classSelect.appendChild(allOption);

            allClasses.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                classSelect.appendChild(opt);
            });

            if (allClasses.length > 0) {
                 classSelect.value = 'ALL'; 
            }
            
            populateSelect(classSelectAdj, allClasses, 'æ–°å¢è€å¸«ç›®æ¨™ç­åˆ¥'); 
            if (allClasses.length > 0) classSelectAdj.value = allClasses[0];

            populateSelect(swapClass1Select, allClasses, 'A ç­åˆ¥'); 
            populateSelect(swapClass2Select, allClasses, 'B ç­åˆ¥');
            if (allClasses.length > 0) {
                swapClass1Select.value = allClasses[0];
                swapClass2Select.value = allClasses[0];
            }
            
            if (allDays.length > 0) daySelect.value = allDays[0];

            displayTeacherSchedule(); 
            displaySchedule();
        }

        function populateSelect(selectElement, options, name) {
            // ... (rest of the populateSelect function remains the same)
            selectElement.innerHTML = ''; 
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = `--- è«‹é¸æ“‡ ${name} ---`;
            selectElement.appendChild(defaultOption);

            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        }

        // ====================================================================
        // é¡¯ç¤ºåŠŸèƒ½ (Display) (ç•¥éï¼Œå› ç‚ºå®ƒå€‘ä½¿ç”¨ scheduleDataMap.values() æŸ¥æ‰¾)
        // ====================================================================

        function displayFreeTeachersOnly(selectedDay, timeSlots) {
            // ... (Function remains the same, but relies on the correct scheduleDataMap)
            const allTeachers = getAllTeachers();
            const dailyFreeLessonsMap = calculateDailyFreeLessons(selectedDay); 
            const priorityTeachers = new Set(splitTeacherList(priorityTeacherInput.value.trim()));
            const dutyTeachers = new Set(splitTeacherList(dutyTeacherInput.value.trim()));
            
            const currentTimetableMap = getCurrentTimetableMap(selectedDay); 
            
            teacherScheduleBody.innerHTML = '';
            
            // å¾ Map ä¸­éæ¿¾ç›¸é—œè¨˜éŒ„
            const relevantLessons = Array.from(scheduleDataMap.values()).filter(item => 
                item['æ—¥å­'] === selectedDay && timeSlots.includes(item['æ™‚é–“'])
            ).sort((a, b) => timeToMinutes(a['æ™‚é–“']) - timeToMinutes(b['æ™‚é–“']));
            
            const uniqueTimeSlots = [...new Set(relevantLessons.map(item => item['æ™‚é–“']))];
            
            if (uniqueTimeSlots.length === 0) {
                teacherResultMessage.textContent = `åœ¨ ${selectedDay}ï¼ŒæŒ‡å®šç¯€æ•¸æ²’æœ‰æ‰¾åˆ°ä»»ä½•èª²å ‚è¨˜éŒ„ã€‚`;
                teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">ç„¡è³‡æ–™ã€‚</td></tr>`;
                return;
            }

            uniqueTimeSlots.forEach(timeSlot => {
                const lessonNumber = currentTimetableMap.get(timeSlot) || '---'; 
                
                const row = teacherScheduleBody.insertRow();
                row.className = 'timeslot-header-row'; 
                
                row.insertCell().textContent = lessonNumber;
                row.insertCell().textContent = timeSlot;
                
                const classesInSlot = relevantLessons.filter(l => l['æ™‚é–“'] === timeSlot)
                    .map(l => {
                        const lesson = l['èª²å ‚'] || '---';
                        const teacher = l['ä¸Šèª²æ•™å¸«'] || '';
                        const styledTeachers = splitTeacherList(teacher || '---')
                            .map(name => getStyledTeacherName(name))
                            .join(' / ');
                        return `**${l['ç­åˆ¥']}**: ${lesson} - ${styledTeachers}`;
                    })
                    .join('<br>');
                    
                const classesCell = row.insertCell();
                classesCell.colSpan = 2; 
                classesCell.innerHTML = classesInSlot || '--- (ç„¡èª²å ‚è¨˜éŒ„) ---';
                
                const occupiedTeachers = getOccupiedTeachers(selectedDay, timeSlot);
                
                const freeTeachersNames = allTeachers.filter(teacher => 
                    !occupiedTeachers.has(teacher) && 
                    !dutyTeachers.has(teacher)
                );
                
                const freeTeachersWithCount = freeTeachersNames.map(teacher => ({
                    name: teacher,
                    freeCount: dailyFreeLessonsMap.get(teacher) || 0 
                }));

                freeTeachersWithCount.sort((a, b) => {
                    const aIsPriority = priorityTeachers.has(a.name);
                    const bIsPriority = priorityTeachers.has(b.name);

                    if (aIsPriority && !bIsPriority) return -1;
                    if (!aIsPriority && bIsPriority) return 1;
                    
                    return b.freeCount - a.freeCount;
                });

                const freeTeachersString = freeTeachersWithCount
                    .map(item => {
                        const isPriority = priorityTeachers.has(item.name);
                        const styledName = getFreeListStyledTeacherName(item.name, isPriority);
                        return `${styledName} (${item.freeCount})`;
                    })
                    .join(', ');

                const freeTeachersCell = row.insertCell();
                freeTeachersCell.innerHTML = freeTeachersString || 'ç„¡æ•™å¸«ç©ºé–’';
            });
            
            teacherResultMessage.textContent = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}ï¼ŒæŒ‡å®šç¯€æ•¸ (${timeSlots.map(t => currentTimetableMap.get(t)).join(', ')}) çš„ç©ºé–’æ•™å¸«åå–® (å…± ${uniqueTimeSlots.length} å€‹æ™‚æ®µ)ã€‚`;
        }

        function displayTeacherSchedule() {
            // ... (Function remains the same, using scheduleDataMap.values() or getOccupiedTeachers)
            if (scheduleDataMap.size === 0 || teacherListCache.length === 0) {
                teacherResultMessage.textContent = 'æ•¸æ“šè¼‰å…¥ä¸­ï¼Œæˆ–æ•™å¸«åå–®ç‚ºç©ºã€‚';
                teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">è«‹ç­‰å¾…æ‰€æœ‰æ•¸æ“šè¼‰å…¥ã€‚</td></tr>`; 
                return;
            }

            const selectedDay = daySelect.value;
            const rawInput = teacherNameInput.value.trim(); 
            const teacherNames = splitTeacherList(rawInput);
            
            const lessonNumberString = lessonNumberInput.value.trim();
            const filterTimeSlots = getTimeSlotsByLessonNumbers(selectedDay, lessonNumberString); 
            const isFilteringBySlot = filterTimeSlots.length > 0;
            
            const priorityTeachers = new Set(splitTeacherList(priorityTeacherInput.value.trim()));
            const dutyTeachers = new Set(splitTeacherList(dutyTeacherInput.value.trim()));
            
            const currentTimetableMap = getCurrentTimetableMap(selectedDay); 

            teacherScheduleBody.innerHTML = '';
            teacherResultMessage.textContent = '';

            if (!selectedDay) {
                 teacherResultMessage.textContent = 'è«‹å…ˆé¸æ“‡æ—¥å­ã€‚';
                 teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">è«‹å…ˆé¸æ“‡æ—¥å­ã€‚</td></tr>`; 
                 return;
            }

            if (teacherNames.length === 0 && isFilteringBySlot) {
                displayFreeTeachersOnly(selectedDay, filterTimeSlots);
                return;
            }

            if (teacherNames.length === 0) {
                teacherResultMessage.textContent = 'è«‹è¼¸å…¥æ•™å¸«å§“åæˆ–ç¯€æ•¸ä»¥æŸ¥è©¢ç©ºé–’æ•™å¸«ã€‚';
                teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">è«‹è¼¸å…¥æ•™å¸«å§“åæˆ–ç¯€æ•¸ã€‚</td></tr>`; 
                return;
            }
            
            let combinedTeacherLessons = [];
            const allTeachers = getAllTeachers(); 
            const dailyFreeLessonsMap = calculateDailyFreeLessons(selectedDay); 

            teacherNames.forEach(teacherName => {
                const targetTeacherLessons = Array.from(scheduleDataMap.values()).filter(item => {
                    if (item['æ—¥å­'] !== selectedDay) return false;
                    
                    if (isFilteringBySlot && !filterTimeSlots.includes(item['æ™‚é–“'])) {
                        return false;
                    }
                    
                    const teachingNames = splitTeacherList(item['ä¸Šèª²æ•™å¸«']);
                    return teachingNames.includes(teacherName);
                });
                
                if (targetTeacherLessons.length > 0) {
                    
                    targetTeacherLessons.sort((a, b) => timeToMinutes(a['æ™‚é–“']) - timeToMinutes(b['æ™‚é–“']));
                    
                    const styledHeaderName = getStyledTeacherName(teacherName);
                    combinedTeacherLessons.push({ isHeader: true, name: styledHeaderName });
                    combinedTeacherLessons.push(...targetTeacherLessons);
                }
            });

            if (combinedTeacherLessons.length === 0) {
                teacherScheduleBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">åœ¨ ${selectedDay}ï¼Œæ‚¨æŸ¥è©¢çš„æ•™å¸« ${teacherNames.join('ã€')} æ²’æœ‰ä»»æ•™èª²å ‚${isFilteringBySlot ? ` (æ–¼ç¯€æ•¸ ${lessonNumberString})` : ''}ã€‚</td></tr>`; 
                return;
            }
            
            let totalLessonsCount = 0;
            combinedTeacherLessons.forEach(lesson => {
                if (lesson.isHeader) {
                    const row = teacherScheduleBody.insertRow();
                    row.className = 'teacher-header-row';
                    row.insertCell().innerHTML = `æ•™å¸«: ${lesson.name}`; 
                    row.insertCell().colSpan = 4; 
                    row.cells[0].colSpan = 1; 
                    row.cells[1].textContent = 'è©²æ•™å¸«çš„æ’èª²';
                    return;
                }
                
                const row = teacherScheduleBody.insertRow();
                const lessonTime = lesson['æ™‚é–“'] || '---';
                const lessonNumber = currentTimetableMap.get(lessonTime) || '---'; 

                totalLessonsCount++;
                
                const occupiedTeachers = getOccupiedTeachers(selectedDay, lessonTime);
                
                const freeTeachersNames = allTeachers.filter(teacher => 
                    !occupiedTeachers.has(teacher) && 
                    !teacherNames.includes(teacher) && 
                    !dutyTeachers.has(teacher)
                );

                const freeTeachersWithCount = freeTeachersNames.map(teacher => ({
                    name: teacher,
                    freeCount: dailyFreeLessonsMap.get(teacher) || 0 
                }));

                freeTeachersWithCount.sort((a, b) => {
                    const aIsPriority = priorityTeachers.has(a.name);
                    const bIsPriority = priorityTeachers.has(b.name);

                    if (aIsPriority && !bIsPriority) return -1;
                    if (!aIsPriority && bIsPriority) return 1;
                    
                    return b.freeCount - a.freeCount;
                });

                const freeTeachersString = freeTeachersWithCount
                    .map(item => {
                        const isPriority = priorityTeachers.has(item.name);
                        const styledName = getFreeListStyledTeacherName(item.name, isPriority);
                        return `${styledName} (${item.freeCount})`;
                    })
                    .join(', ');


                row.insertCell().textContent = lessonNumber; 
                row.insertCell().textContent = lessonTime;
                row.insertCell().textContent = lesson['ç­åˆ¥'] || '---';
                row.insertCell().textContent = lesson['èª²å ‚'] || '---';

                const freeTeachersCell = row.insertCell();
                freeTeachersCell.innerHTML = freeTeachersString || 'ç„¡å…¶ä»–æ•™å¸«ç©ºé–’';
            });
            
            let message = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}ï¼Œæ•™å¸« ${teacherNames.join('ã€')} çš„åˆä½µèª²å ‚å®‰æ’ (å…± ${totalLessonsCount} ç¯€)`;
            if(isFilteringBySlot) {
                message += ` (å·²ç¯©é¸ç¯€æ•¸: ${lessonNumberString})`;
            }
            teacherResultMessage.textContent = message + `ã€‚`;
        }


        function displaySchedule() {
            // ... (Function remains the same, using scheduleDataMap.values() and other Map-based lookups)
            if (scheduleDataMap.size === 0) return;

            const selectedDay = daySelect.value;
            const selectedClass = classSelect.value;
            
            const currentTimetableMap = getCurrentTimetableMap(selectedDay); 

            scheduleBody.innerHTML = '';
            resultMessage.textContent = '';
            
            const singleClassHeader = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th><th>èª²å ‚</th><th>ä¸Šèª²æ•™å¸«</th></tr>';

            if (!selectedDay) {
                resultMessage.textContent = 'è«‹é¸æ“‡æ—¥å­ã€‚';
                scheduleHeader.innerHTML = singleClassHeader;
                scheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">è«‹é¸æ“‡æ—¥å­ã€‚</td></tr>`; 
                return;
            }

            if (selectedClass === 'ALL') {
                displayAllClassesSchedule(selectedDay);
                return;
            }
            
            if (!selectedClass) {
                resultMessage.textContent = 'è«‹é¸æ“‡ç­åˆ¥ä»¥æŸ¥çœ‹èª²è¡¨ã€‚';
                scheduleHeader.innerHTML = singleClassHeader;
                scheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">è«‹é¸æ“‡ç­åˆ¥ã€‚</td></tr>`; 
                return;
            }
            
            scheduleHeader.innerHTML = singleClassHeader;

            const filteredSchedule = Array.from(scheduleDataMap.values()).filter(item => 
                item['æ—¥å­'] === selectedDay && item['ç­åˆ¥'] === selectedClass
            );

            if (filteredSchedule.length === 0) {
                resultMessage.textContent = `åœ¨ ${selectedDay}ï¼Œ${selectedClass} ç­æ²’æœ‰æ‰¾åˆ°èª²è¡¨æ•¸æ“šã€‚`;
                scheduleBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">åœ¨ ${selectedDay}ï¼Œ${selectedClass} ç­æ²’æœ‰æ‰¾åˆ°èª²è¡¨æ•¸æ“šã€‚</td></tr>`; 
                return;
            }

            filteredSchedule.forEach(lesson => {
                const row = scheduleBody.insertRow();
                
                const getTime = lesson['æ™‚é–“'] || '---';
                const getLesson = String(lesson['èª²å ‚'] || '---').trim(); 
                
                const rawTeacherValue = lesson['ä¸Šèª²æ•™å¸«'] || ''; 
                
                const getLessonNumber = currentTimetableMap.get(getTime) || '---'; 
                
                let rowStyle = '';
                const isLesson = !NON_LESSON_ACTIVITIES.includes(getLesson);
                const isTeacherMissing = splitTeacherList(rawTeacherValue).length === 0;

                if (isLesson && isTeacherMissing) {
                    rowStyle = 'background-color: #ffc2c2;'; 
                }
                
                row.style.cssText = rowStyle;

                const displayTeacherValue = rawTeacherValue || '---';
                const styledTeachers = splitTeacherList(displayTeacherValue)
                    .map(name => getStyledTeacherName(name))
                    .join(', ');


                row.insertCell().textContent = getLessonNumber; 
                row.insertCell().textContent = getTime;
                row.insertCell().textContent = getLesson;
                row.insertCell().innerHTML = styledTeachers || '---'; 
            });
            
            resultMessage.textContent = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}, ${selectedClass} ç­çš„èª²è¡¨ (å…± ${filteredSchedule.length} ç¯€)ã€‚`;
        }

        function displayAllClassesSchedule(selectedDay) {
            
            const allTimeSlots = [...new Set(Array.from(scheduleDataMap.values())
                .filter(item => item['æ—¥å­'] === selectedDay && item['æ™‚é–“'])
                .map(item => item['æ™‚é–“']))
            ].sort((a, b) => timeToMinutes(a) - timeToMinutes(b));
            
            const allClasses = [...new Set(Array.from(scheduleDataMap.values()).map(item => item['ç­åˆ¥']).filter(Boolean))].sort();
            
            const currentTimetableMap = getCurrentTimetableMap(selectedDay); 

            if (allTimeSlots.length === 0) {
                resultMessage.textContent = `åœ¨ ${selectedDay}ï¼Œæ²’æœ‰æ‰¾åˆ°ä»»ä½•èª²è¡¨æ•¸æ“šã€‚`;
                scheduleHeader.innerHTML = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th><th>(ç„¡ç­åˆ¥æ•¸æ“š)</th></tr>'; 
                scheduleBody.innerHTML = `<tr><td colspan="${allClasses.length + 2}" style="text-align: center;">æ²’æœ‰æ•¸æ“šã€‚</td></tr>`;
                return;
            }
            
            // 2. å½™æ•´æ•¸æ“š: { time: { class: {èª²å ‚, ä¸Šèª²æ•™å¸«} } }
            const aggregatedData = new Map();
            Array.from(scheduleDataMap.values()).forEach(item => {
                if (item['æ—¥å­'] === selectedDay && item['ç­åˆ¥']) { 
                    if (!aggregatedData.has(item['æ™‚é–“'])) {
                        aggregatedData.set(item['æ™‚é–“'], new Map());
                    }
                    aggregatedData.get(item['æ™‚é–“']).set(item['ç­åˆ¥'], {
                        lesson: item['èª²å ‚'] || '---',
                        teacher: item['ä¸Šèª²æ•™å¸«'] || '' 
                    });
                }
            });

            // 3. ç”Ÿæˆè¡¨é ­
            let headerHtml = '<tr><th>ç¯€æ•¸</th><th>æ™‚é–“</th>';
            allClasses.forEach(className => {
                headerHtml += `<th>${className}</th>`;
            });
            headerHtml += '</tr>';
            scheduleHeader.innerHTML = headerHtml; 
            
            // 4. ç”Ÿæˆè¡¨æ ¼å…§å®¹
            scheduleBody.innerHTML = '';
            
            allTimeSlots.forEach(timeSlot => {
                
                const teachingTeachers = new Map(); 
                const classDataMap = aggregatedData.get(timeSlot) || new Map();
                
                allClasses.forEach(className => {
                    const classLesson = classDataMap.get(className);
                    if (classLesson) {
                        const rawTeacher = String(classLesson.teacher).trim();
                        const teachers = splitTeacherList(rawTeacher);
                        teachers.forEach(teacher => {
                            if (teacher.length > 0 && teacher !== '---') { 
                                if (!teachingTeachers.has(teacher)) {
                                    teachingTeachers.set(teacher, new Set());
                                }
                                teachingTeachers.get(teacher).add(className);
                            }
                        });
                    }
                });

                const conflictedTeachers = new Set();
                teachingTeachers.forEach((classesSet, teacher) => {
                    if (classesSet.size >= 2) { 
                        conflictedTeachers.add(teacher);
                    }
                });
                
                const row = scheduleBody.insertRow();
                const lessonNumber = currentTimetableMap.get(timeSlot) || '---';
                
                row.insertCell().textContent = lessonNumber;
                row.insertCell().textContent = timeSlot;
                
                
                allClasses.forEach(className => {
                    const cell = row.insertCell();
                    const classLesson = classDataMap.get(className);
                    
                    if (classLesson) {
                        const lesson = String(classLesson.lesson).trim();
                        const rawTeacher = String(classLesson.teacher).trim();
                        const teachers = splitTeacherList(rawTeacher);
                        
                        let cellStyle = '';
                        
                        const hasConflict = teachers.some(teacher => conflictedTeachers.has(teacher));
                        
                        if (hasConflict) {
                            cellStyle = 'background-color: #FFC299;'; 
                        } else {
                            const isLesson = !NON_LESSON_ACTIVITIES.includes(lesson);
                            const isTeacherMissing = teachers.length === 0;

                            if (isLesson && isTeacherMissing) {
                                cellStyle = 'background-color: #ffc2c2;'; 
                            }
                        }
                        cell.style.cssText = cellStyle;
                        
                        
                        if (NON_LESSON_ACTIVITIES.includes(lesson)) {
                            cell.textContent = lesson; 
                        } else if (lesson === '---' && rawTeacher === '') {
                            cell.textContent = '---';
                        } else {
                            const displayTeacherValue = rawTeacher || '---';
                            const styledTeachers = splitTeacherList(displayTeacherValue)
                                .map(name => getStyledTeacherName(name))
                                .join(' / '); 
                                
                            cell.innerHTML = `${lesson} - ${styledTeachers}`;
                        }
                    } else {
                        cell.textContent = '---';
                    }
                });
            });

            resultMessage.textContent = `âœ… æˆåŠŸé¡¯ç¤º ${selectedDay}ï¼Œæ‰€æœ‰ ${allClasses.length} å€‹ç­åˆ¥çš„åˆä½µèª²è¡¨ (å…± ${allTimeSlots.length} å€‹æ™‚é–“æ®µ)ã€‚`;
        }

        // ====================================================================
        // 3.4. å„²å­˜èˆ‡è¼‰å…¥åŠŸèƒ½ (Save & Load) - æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†
        // ====================================================================
        
        // --- æ ¸å¿ƒä¿®æ”¹é» 3: å„²å­˜åŠŸèƒ½åªå„²å­˜å·®ç•° ---
        function handleSaveClick() {
            if (scheduleDataMap.size === 0) {
                adjustmentMessage.textContent = 'âŒ ç„¡æ•¸æ“šå¯å„²å­˜ã€‚è«‹å…ˆç¢ºèªæ’èª²è¡¨å·²æˆåŠŸè¼‰å…¥ã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            // æ‰¾å‡ºæ‰€æœ‰æœ‰è®Šå‹•çš„è¨˜éŒ„
            const modifiedRecords = findModifiedRecords();
            
            if (modifiedRecords.length === 0) {
                adjustmentMessage.textContent = 'âš ï¸ æ’èª²è¡¨è‡ªè¼‰å…¥ä»¥ä¾†æ²’æœ‰ä»»ä½•è®Šå‹•ï¼Œç„¡éœ€å„²å­˜å·®ç•°æª”æ¡ˆã€‚';
                adjustmentMessage.style.color = 'orange';
                return;
            }

            try {
                // åƒ…å°å‡ºä»¥ä¸‹é—œéµæ¬„ä½
                const columnsToExport = ['æ—¥å­', 'ç­åˆ¥', 'æ™‚é–“', 'èª²å ‚', 'ä¸Šèª²æ•™å¸«'];

                const csv = Papa.unparse(modifiedRecords, {
                    columns: columnsToExport,
                    skipEmptyLines: true
                });
                
                const currentDate = new Date().toISOString().slice(0, 10);
                const filename = `æ’èª²è¡¨å·®ç•°_${currentDate}_${modifiedRecords.length}ç­†.csv`;
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement('a');
                if (link.download !== undefined) { 
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden'; 
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    adjustmentMessage.textContent = `âœ… æˆåŠŸä¸‹è¼‰æ’èª²è¡¨å·®ç•°æª”æ¡ˆï¼š${filename} (å…± ${modifiedRecords.length} ç­†è®Šå‹•)ã€‚`;
                    adjustmentMessage.style.color = 'green';
                } else {
                    adjustmentMessage.textContent = 'âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è‡ªå‹•ä¸‹è¼‰ã€‚';
                    adjustmentMessage.style.color = 'orange';
                }
            } catch (error) {
                adjustmentMessage.textContent = `âŒ å„²å­˜å¤±æ•—: ${error.message}`;
                adjustmentMessage.style.color = 'red';
                console.error("Save Error:", error);
            }
        }
        
        // --- æ ¸å¿ƒä¿®æ”¹é» 4: è¼‰å…¥åŠŸèƒ½åªæ‡‰ç”¨å·®ç•° ---
        function handleLoadClick() {
            const file = loadFileInput.files[0];
            
            if (!file) {
                adjustmentMessage.textContent = 'âŒ è«‹å…ˆé¸æ“‡ä¸€å€‹ CSV å·®ç•°æª”æ¡ˆã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            if (scheduleDataMap.size === 0) {
                 adjustmentMessage.textContent = 'âŒ è«‹å…ˆè¼‰å…¥åŸå§‹æ’èª²è¡¨æª”æ¡ˆ `ç­åˆ¥æ™‚é–“ç¸½è¡¨.csv`ï¼Œæ‰èƒ½æ‡‰ç”¨å·®ç•°ã€‚';
                 adjustmentMessage.style.color = 'red';
                 return;
            }
            
            adjustmentMessage.textContent = `â³ æ­£åœ¨è¼‰å…¥å·®ç•°æª”æ¡ˆ "${file.name}"...`;
            adjustmentMessage.style.color = '#2980b9';
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    
                    if (results.data.length === 0 || !results.data[0]['æ—¥å­'] || !results.data[0]['ç­åˆ¥'] || !results.data[0]['æ™‚é–“']) {
                        adjustmentMessage.textContent = `âŒ è¼‰å…¥å¤±æ•—: å·®ç•°æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºæˆ–ç¼ºå°‘é—œéµæ¬„ä½ (æ—¥å­/ç­åˆ¥/æ™‚é–“)ã€‚`;
                        adjustmentMessage.style.color = 'red';
                        return;
                    }

                    let applyCount = 0;
                    
                    results.data.forEach(diffRecord => {
                        const key = createKey(diffRecord);
                        const targetRecord = scheduleDataMap.get(key);
                        
                        if (targetRecord) {
                            // åƒ…æ›´æ–°èª²å ‚å’Œä¸Šèª²æ•™å¸«æ¬„ä½
                            targetRecord['èª²å ‚'] = diffRecord['èª²å ‚'] || '';
                            targetRecord['ä¸Šèª²æ•™å¸«'] = diffRecord['ä¸Šèª²æ•™å¸«'] || '';
                            applyCount++;
                        }
                    });
                    
                    // ç”±æ–¼æˆ‘å€‘ä¿®æ”¹äº† Map ä¸­çš„å°è±¡å¼•ç”¨ï¼ŒscheduleData é™£åˆ—ä¹ŸåŒæ™‚è¢«æ›´æ–°äº†ã€‚
                    
                    // é‡æ–°æ•´ç†æ‰€æœ‰ä»‹é¢
                    updateDisplays(); 
                    
                    adjustmentMessage.textContent = `âœ… æˆåŠŸè¼‰å…¥å·®ç•°æª”æ¡ˆ "${file.name}" (å…± ${results.data.length} ç­†å·®ç•°è¨˜éŒ„)ã€‚å·²æˆåŠŸæ‡‰ç”¨ ${applyCount} ç­†è®Šå‹•åˆ°ç•¶å‰æ’èª²è¡¨ã€‚`;
                    adjustmentMessage.style.color = 'green';
                },
                error: function(err) {
                    adjustmentMessage.textContent = `âŒ è¼‰å…¥å¤±æ•—: è®€å–æª”æ¡ˆç™¼ç”ŸéŒ¯èª¤ã€‚`;
                    adjustmentMessage.style.color = 'red';
                    console.error("Load Error:", err);
                }
            });
        }

        // ====================================================================
        // 3.1, 3.2, 3.3 èª¿å ‚åŠŸèƒ½ (æ›´æ–°ï¼Œç¢ºä¿æ“ä½œåŒæ­¥åˆ° Map)
        // ====================================================================

        function handleClassSwapClick() {
            const selectedDay = daySelect.value;
            const class1 = swapClass1Select.value;
            const lessons1String = swapLessons1Input.value.trim();
            const class2 = swapClass2Select.value;
            const lessons2String = swapLessons2Input.value.trim();

            if (!selectedDay || !class1 || !class2 || !lessons1String || !lessons2String) {
                adjustmentMessage.textContent = 'âŒ è«‹é¸æ“‡æ—¥å­ã€å…©çµ„ç­åˆ¥ï¼Œä¸¦è¼¸å…¥å…©çµ„ç¯€æ•¸é€²è¡Œå°èª¿ã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            const timeSlots1 = getTimeSlotsByLessonNumbers(selectedDay, lessons1String);
            const timeSlots2 = getTimeSlotsByLessonNumbers(selectedDay, lessons2String);
            
            if (timeSlots1.length === 0 || timeSlots2.length === 0) {
                adjustmentMessage.textContent = `âŒ ç„¡æ•ˆçš„ç¯€æ•¸è¼¸å…¥ã€‚è«‹æª¢æŸ¥è¼¸å…¥çš„ç¯€æ•¸æ˜¯å¦å­˜åœ¨æ–¼ ${selectedDay} çš„æ™‚é–“è¡¨ä¸­ã€‚`;
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            if (timeSlots1.length !== timeSlots2.length) {
                adjustmentMessage.textContent = `âŒ å…©çµ„ç¯€æ•¸çš„æ•¸é‡ä¸ä¸€è‡´ (A: ${timeSlots1.length} ç¯€, B: ${timeSlots2.length} ç¯€)ã€‚å¿…é ˆæ•¸é‡ç›¸ç­‰æ‰èƒ½å°èª¿ã€‚`;
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            const originalRecords1 = new Map(); 
            const originalRecords2 = new Map(); 

            // å¾ Map ä¸­ç²å–è¨˜éŒ„ï¼Œä»¥ä¾¿ä¹‹å¾Œä¿®æ”¹
            const relevantRecords = Array.from(scheduleDataMap.values()).filter(record => 
                record['æ—¥å­'] === selectedDay && (
                    (record['ç­åˆ¥'] === class1 && timeSlots1.includes(record['æ™‚é–“'])) ||
                    (record['ç­åˆ¥'] === class2 && timeSlots2.includes(record['æ™‚é–“']))
                )
            );

            // æå–åŸå§‹æ•¸æ“šçš„å¿«ç…§
            relevantRecords.forEach(record => {
                const key = createKey(record);
                if (record['ç­åˆ¥'] === class1) {
                    originalRecords1.set(record['æ™‚é–“'], { ...record }); 
                } else if (record['ç­åˆ¥'] === class2) {
                    originalRecords2.set(record['æ™‚é–“'], { ...record }); 
                }
            });

            if (originalRecords1.size !== timeSlots1.length || originalRecords2.size !== timeSlots2.length) {
                adjustmentMessage.textContent = `âš ï¸ åœ¨ ${class1} å’Œ ${class2} ç­ï¼Œæ²’æœ‰æ‰¾åˆ°å®Œæ•´çš„ ${timeSlots1.length} ç¯€è¨˜éŒ„é€²è¡Œå°èª¿ã€‚è«‹ç¢ºèªç­åˆ¥ã€æ—¥å­å’Œç¯€æ•¸è¼¸å…¥æ­£ç¢ºï¼Œä¸”æ‰€æœ‰ç¯€æ•¸åœ¨æ’èª²è¡¨æ•¸æ“šä¸­éƒ½æœ‰å°æ‡‰çš„è¡Œè¨˜éŒ„ã€‚`;
                adjustmentMessage.style.color = 'orange';
                return;
            }
            
            let swapCount = 0;
            
            relevantRecords.forEach(record => {
                const currentTime = record['æ™‚é–“'];
                
                // æª¢æŸ¥æ˜¯å¦æ˜¯ A ç­çš„ç›®æ¨™ç¯€æ•¸
                if (record['ç­åˆ¥'] === class1 && timeSlots1.includes(currentTime)) {
                    const index = timeSlots1.indexOf(currentTime);
                    const targetTime = timeSlots2[index]; 
                    const recordToSwap = originalRecords2.get(targetTime);
                    
                    if (recordToSwap) {
                        record['èª²å ‚'] = recordToSwap['èª²å ‚'];
                        record['ä¸Šèª²æ•™å¸«'] = recordToSwap['ä¸Šèª²æ•™å¸«'];
                        swapCount++;
                    }
                } 
                // æª¢æŸ¥æ˜¯å¦æ˜¯ B ç­çš„ç›®æ¨™ç¯€æ•¸
                else if (record['ç­åˆ¥'] === class2 && timeSlots2.includes(currentTime)) {
                    const index = timeSlots2.indexOf(currentTime);
                    const targetTime = timeSlots1[index]; 
                    const recordToSwap = originalRecords1.get(targetTime);

                     if (recordToSwap) {
                        record['èª²å ‚'] = recordToSwap['èª²å ‚'];
                        record['ä¸Šèª²æ•™å¸«'] = recordToSwap['ä¸Šèª²æ•™å¸«'];
                        swapCount++;
                    }
                }
            });
            
            if (swapCount > 0) {
                adjustmentMessage.textContent = `âœ… æˆåŠŸèª¿æ› ${class1} ç­ ${lessons1String} å’Œ ${class2} ç­ ${lessons2String} çš„èª²å ‚å…§å®¹ (å…±ä¿®æ”¹ ${swapCount} ç­†è¨˜éŒ„)ã€‚è«‹æŸ¥çœ‹ä¸Šæ–¹æŸ¥è©¢çµæœã€‚`;
                adjustmentMessage.style.color = 'green';
                updateDisplays();
            } else {
                adjustmentMessage.textContent = `âš ï¸ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„é€²è¡Œå°èª¿ã€‚è«‹ç¢ºèªæ—¥å­ã€ç­åˆ¥å’Œç¯€æ•¸è¼¸å…¥æ­£ç¢ºã€‚`;
                adjustmentMessage.style.color = 'orange';
            }
        }


        function handleTeacherClearClick() {
             const selectedDay = daySelect.value;
            const lessonsString = document.getElementById('clear-lessons-input').value.trim();
            const teachersString = document.getElementById('clear-teachers-input').value.trim();

            if (!selectedDay || !lessonsString || !teachersString) {
                adjustmentMessage.textContent = 'âŒ è«‹é¸æ“‡æ—¥å­ï¼Œä¸¦è¼¸å…¥è¦æ¸…ç©ºçš„ç¯€æ•¸å’Œè€å¸«åå–®ã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            const timeSlots = getTimeSlotsByLessonNumbers(selectedDay, lessonsString);
            const teachersToClear = splitTeacherList(teachersString);
            
            if (timeSlots.length === 0) {
                adjustmentMessage.textContent = `âŒ ç„¡æ•ˆçš„ç¯€æ•¸è¼¸å…¥ã€‚è«‹æª¢æŸ¥è¼¸å…¥çš„ç¯€æ•¸æ˜¯å¦å­˜åœ¨æ–¼ ${selectedDay} çš„æ™‚é–“è¡¨ä¸­ã€‚`;
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            if (teachersToClear.length === 0) {
                 adjustmentMessage.textContent = 'âŒ ç„¡æ•ˆçš„è€å¸«åå–®è¼¸å…¥ã€‚';
                 adjustmentMessage.style.color = 'red';
                 return;
            }

            let clearCount = 0;
            
            Array.from(scheduleDataMap.values()).forEach(record => {
                if (record['æ—¥å­'] === selectedDay && timeSlots.includes(record['æ™‚é–“'])) {
                    let currentTeachersString = record['ä¸Šèª²æ•™å¸«'] || '';
                    let currentTeachers = splitTeacherList(currentTeachersString);
                    
                    let originalCount = currentTeachers.length;
                    
                    const remainingTeachers = currentTeachers.filter(teacher => 
                        !teachersToClear.includes(teacher)
                    );
                    
                    if (remainingTeachers.length !== originalCount) {
                        record['ä¸Šèª²æ•™å¸«'] = remainingTeachers.length > 0 ? remainingTeachers.join(' ') : ''; 
                        
                        clearCount += (originalCount - remainingTeachers.length);
                    }
                }
            });
            
            if (clearCount > 0) {
                adjustmentMessage.textContent = `âœ… æˆåŠŸæ¸…ç©º ${teachersString} åœ¨ ${selectedDay} ${lessonsString} ç¯€çš„æ’èª² (å…±æ¸…é™¤ ${clearCount} å€‹æ•™å¸«åˆ†é…)ã€‚è«‹æŸ¥çœ‹ä¸Šæ–¹æŸ¥è©¢çµæœï¼Œ**ç¼ºå°‘è€å¸«çš„èª²å ‚å°‡é¡¯ç¤ºç²‰ç´…è‰²**ã€‚`;
                adjustmentMessage.style.color = 'green';
                updateDisplays();
            } else {
                adjustmentMessage.textContent = `âš ï¸ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è€å¸«æ’èª²é€²è¡Œæ¸…ç©ºã€‚è«‹ç¢ºèªæ—¥å­ã€ç¯€æ•¸å’Œè€å¸«åå–®è¼¸å…¥æ­£ç¢ºã€‚`;
                adjustmentMessage.style.color = 'orange';
            }
        }
        
        function handleTeacherAddClick() {
             const selectedDay = daySelect.value;
            const selectedClass = classSelectAdj.value; 
            const lessonsString = document.getElementById('add-lessons-input').value.trim();
            const teachersString = document.getElementById('add-teacher-input').value.trim();

            if (!selectedDay || !selectedClass || !lessonsString || !teachersString) {
                adjustmentMessage.textContent = 'âŒ è«‹é¸æ“‡æ—¥å­ã€ğŸ¯ ç›®æ¨™ç­åˆ¥ï¼Œä¸¦è¼¸å…¥è¦åŠ å…¥çš„ç¯€æ•¸å’Œè€å¸«åå–®ã€‚';
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            const timeSlots = getTimeSlotsByLessonNumbers(selectedDay, lessonsString);
            const teachersToAdd = splitTeacherList(teachersString);
            
            if (timeSlots.length === 0) {
                adjustmentMessage.textContent = `âŒ ç„¡æ•ˆçš„ç¯€æ•¸è¼¸å…¥ã€‚è«‹æª¢æŸ¥è¼¸å…¥çš„ç¯€æ•¸æ˜¯å¦å­˜åœ¨æ–¼ ${selectedDay} çš„æ™‚é–“è¡¨ä¸­ã€‚`;
                adjustmentMessage.style.color = 'red';
                return;
            }
            
            if (teachersToAdd.length === 0) {
                 adjustmentMessage.textContent = 'âŒ ç„¡æ•ˆçš„è€å¸«åå–®è¼¸å…¥ã€‚';
                 adjustmentMessage.style.color = 'red';
                 return;
            }

            let addCount = 0;
            const teachersToAddSet = new Set(teachersToAdd);
            
            Array.from(scheduleDataMap.values()).forEach(record => {
                if (record['æ—¥å­'] === selectedDay && record['ç­åˆ¥'] === selectedClass && timeSlots.includes(record['æ™‚é–“'])) {
                    
                    let currentTeachersString = record['ä¸Šèª²æ•™å¸«'] || '';
                    let currentTeachers = splitTeacherList(currentTeachersString);
                    let currentTeachersSet = new Set(currentTeachers);
                    
                    let teachersAddedToThisRecord = 0;
                    
                    teachersToAddSet.forEach(newTeacher => {
                        if (!currentTeachersSet.has(newTeacher)) {
                            currentTeachers.push(newTeacher);
                            teachersAddedToThisRecord++;
                        }
                    });
                    
                    if (teachersAddedToThisRecord > 0) {
                        record['ä¸Šèª²æ•™å¸«'] = currentTeachers.join(' '); 
                        addCount += teachersAddedToThisRecord;
                    }
                }
            });
            
            if (addCount > 0) {
                adjustmentMessage.textContent = `âœ… æˆåŠŸåœ¨ ${selectedClass} ç­ ${selectedDay} ${lessonsString} ç¯€åŠ å…¥è€å¸« ${teachersString} (å…±æ–°å¢ ${addCount} å€‹æ•™å¸«åˆ†é…)ã€‚è«‹æŸ¥çœ‹ä¸Šæ–¹æŸ¥è©¢çµæœã€‚`;
                adjustmentMessage.style.color = 'green';
                updateDisplays();
            } else {
                adjustmentMessage.textContent = `âš ï¸ æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„èª²å ‚æˆ–æ‰€æœ‰è€å¸«å·²å­˜åœ¨ã€‚è«‹ç¢ºèªç­åˆ¥ã€æ—¥å­å’Œç¯€æ•¸è¼¸å…¥æ­£ç¢ºã€‚`;
                adjustmentMessage.style.color = 'orange';
            }
        }


        // ====================================================================
        // åˆå§‹åŒ–å’Œäº‹ä»¶ç›£è½
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // æŸ¥è©¢åŠŸèƒ½ç›£è½
            daySelect.addEventListener('change', updateDisplays);
            classSelect.addEventListener('change', displaySchedule); 
            teacherNameInput.addEventListener('input', displayTeacherSchedule); 
            lessonNumberInput.addEventListener('input', displayTeacherSchedule); 
            priorityTeacherInput.addEventListener('input', displayTeacherSchedule); 
            dutyTeacherInput.addEventListener('input', displayTeacherSchedule); 
            
            // èª¿å ‚åŠŸèƒ½ç›£è½
            document.getElementById('swap-classes-btn').addEventListener('click', handleClassSwapClick);
            document.getElementById('clear-teachers-btn').addEventListener('click', handleTeacherClearClick);
            document.getElementById('add-teacher-btn').addEventListener('click', handleTeacherAddClick); 
            
            // NEW SAVE/LOAD LISTENERS (å·²ä¿®æ”¹)
            saveDataBtn.addEventListener('click', handleSaveClick);
            loadDataBtn.addEventListener('click', handleLoadClick);
            
            loadDataAndPopulateControls();
        });

    </script>

</body>
</html>